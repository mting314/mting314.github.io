<!DOCTYPE html>
<html lang="en"><!--
 __  __                __                                     __
/\ \/\ \              /\ \             __                    /\ \
\ \ \_\ \   __  __    \_\ \      __   /\_\      __       ___ \ \ \/'\
 \ \  _  \ /\ \/\ \   /'_` \   /'__`\ \/\ \   /'__`\    /'___\\ \ , <
  \ \ \ \ \\ \ \_\ \ /\ \L\ \ /\  __/  \ \ \ /\ \L\.\_ /\ \__/ \ \ \\`\
   \ \_\ \_\\/`____ \\ \___,_\\ \____\ _\ \ \\ \__/.\_\\ \____\ \ \_\ \_\
    \/_/\/_/ `/___/> \\/__,_ / \/____//\ \_\ \\/__/\/_/ \/____/  \/_/\/_/
                /\___/                \ \____/
                \/__/                  \/___/

Powered by Hydejack v9.0.3 <https://hydejack.com/>
-->
















<head>
  






  
    
<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>An Anime Recommendation Website! Part 2: ALS From Scratch | Michael Ting</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="An Anime Recommendation Website! Part 2: ALS From Scratch" />
<meta name="author" content="Michael Ting" />
<meta property="og:locale" content="en" />
<meta name="description" content="Image credit to https://takuti.github.io/Recommendation.jl/latest/collaborative_filtering/" />
<meta property="og:description" content="Image credit to https://takuti.github.io/Recommendation.jl/latest/collaborative_filtering/" />
<link rel="canonical" href="http://gmarini.com/blog/blog/programming/2021-06-21-ALS_Explanation/" />
<meta property="og:url" content="http://gmarini.com/blog/blog/programming/2021-06-21-ALS_Explanation/" />
<meta property="og:site_name" content="Michael Ting" />
<meta property="og:image" content="https://takuti.github.io/Recommendation.jl/latest/assets/images/cf.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-06-21T00:00:00-07:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://takuti.github.io/Recommendation.jl/latest/assets/images/cf.png" />
<meta property="twitter:title" content="An Anime Recommendation Website! Part 2: ALS From Scratch" />
<meta name="twitter:site" content="@qwtel" />
<meta name="twitter:creator" content="@Michael Ting" />
<meta name="google-site-verification" content="kRoh_csFULhK6lxBJwZOxiWYQpvttOkFj0a3lWwQADc" />
<script type="application/ld+json">
{"datePublished":"2021-06-21T00:00:00-07:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://gmarini.com/blog/blog/programming/2021-06-21-ALS_Explanation/"},"@type":"BlogPosting","description":"Image credit to https://takuti.github.io/Recommendation.jl/latest/collaborative_filtering/","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://gmarini.com/assets/icons/icon.jpg"},"name":"Michael Ting"},"url":"http://gmarini.com/blog/blog/programming/2021-06-21-ALS_Explanation/","author":{"@type":"Person","name":"Michael Ting"},"image":"https://takuti.github.io/Recommendation.jl/latest/assets/images/cf.png","headline":"An Anime Recommendation Website! Part 2: ALS From Scratch","dateModified":"2021-07-14T23:24:51-07:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  

  
    <meta name="keywords" content="PhD,coding,programming,android,IoT,Ubiquitous,computing,computer,science">
  

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta http-equiv="x-ua-compatible" content="ie=edge">

<meta name="mobile-web-app-capable" content="yes">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Michael Ting">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<meta name="application-name" content="Michael Ting">


  <meta name="theme-color" content="rgb(8,46,57)">


<meta name="generator" content="Hydejack v9.0.3" />


<link rel="alternate" href="http://gmarini.com/blog/blog/programming/2020-05-27-ok-zoomer/" hreflang="en">

<link type="application/atom+xml" rel="alternate" href="http://gmarini.com/feed.xml" title="Michael Ting" />


<link rel="shortcut icon"    href="/assets/icons/favicon.ico">
<link rel="apple-touch-icon" href="/assets/icons/icon-192x192.png">

<link rel="manifest" href="/assets/site.webmanifest">


  <link rel="dns-prefetch" href="https://fonts.googleapis.com">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">



  <link rel="dns-prefetch" href="https://www.google-analytics.com">


<link rel="preload" href="/assets/img/swipe.svg" as="image" id="_hrefSwipeSVG">

<link rel="dns-prefetch" href="/assets/js/search-worker-9.0.3.js" as="worker" id="_hrefSearch">

  
  <link rel="dns-prefetch" href="/assets/bower_components/katex/dist/katex.min.css" id="_katexPreload">




<link rel="dns-prefetch" href="https://mting314-com.disqus.com" id="_hrefDisqus">


<script>!function(e,t){"use strict";function n(e,t,n,o){e.addEventListener?e.addEventListener(t,n,o):e.attachEvent?e.attachEvent("on"+t,n):e["on"+t]=n}e.loadJS=function(e,o){var r=t.createElement("script");r.src=e,o&&n(r,"load",o,{once:!0});var a=t.scripts[0];return a.parentNode.insertBefore(r,a),r},e._loaded=!1,e.loadJSDeferred=function(o,r){function a(){e._loaded=!0,r&&n(c,"load",r,{once:!0});var o=t.scripts[0];o.parentNode.insertBefore(c,o)}var c=t.createElement("script");return c.src=o,e._loaded?a():n(e,"load",a,{once:!0}),c},e.setRel=e.setRelStylesheet=function(e){function o(){this.rel="stylesheet"}n(t.getElementById(e),"load",o,{once:!0})}}(window,document);
!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);
!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);
!function(w) {
  w._baseURL = '/';
  w._publicPath = '/assets/js/';
  w._noPushState = false;
  w._noDrawer = false;
  w._noNavbar = false;
  w._noToc = false;
  w._noSearch = false;
}(window);
</script>



<!--[if gt IE 8]><!---->

  




<link rel="stylesheet" href="/assets/css/hydejack-9.0.3.css" id="_stylePreload">
<link rel="stylesheet" href="/assets/icomoon/style.css" id="_iconsPreload">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab:700%7CNoto+Sans:400,400i,700,700i&display=swap" id="_fontsPreload">



  <style id="_pageStyle">

html{--accent-color: rgb(79,177,186);--accent-color-transparent:  rgba(79,177,186,0.5);--accent-color-transparent-darkened:  rgba(32,76,80,0.8);--accent-color-faded: rgba(79,177,186,0.5);--accent-color-darkened: #409ba3;--theme-color: rgb(8,46,57);--dark-mode-body-bg: #282f31;--dark-mode-border-color: #343d3f}

</style>


<!--<![endif]-->


<!--
Code used for embedding Gumroad on the Hydejack Site. 
Left here for reference, feel free to delete.
-->



<!-- It's better to but it here as it is loaded BEFORE my-scripts.html -->
<script src="/assets/mting314/js/jquery-3.5.1.min.js"></script>



<link rel="dns-prefetch" href="https://assets.gumroad.com">
<script type="module">
  const ppiData = window._ppiData = fetch('https://hydejack-ppi.qwtel.workers.dev', { mode: 'cors'}).then(res => res.json()).catch(() => ({}));
  const promisify = f => x => new Promise(r => f(x).addEventListener('load', r));
  const loadJS = promisify(window.loadJS);
  {
    let p;
    document.querySelector('hy-push-state').addEventListener('load', () => {
      const io = new IntersectionObserver(async (entries) => {
        if (entries.some(x => x.isIntersecting)) {
          p = p || loadJS('https://gumroad.com/js/gumroad-embed.js');
          const [{ code }] = await Promise.all([ppiData, p]);
          document.querySelectorAll('.gumroad-product-embed').forEach(el => { 
            if (!el.dataset.gumroadParams) {
              el.dataset.gumroadParams = 'offer_code=' + (code || 'qr0tw8m');
            }
          });
          if (!window.GumroadEmbed) {
            await new Promise(function check1(res) {
              if ('createGumroadEmbed' in window) res(window.createGumroadEmbed());
              else setTimeout(() => check1(res), 200);
            });
          }
          await new Promise(function check2(res) {
            if ('GumroadEmbed' in window) res(GumroadEmbed.reload());
            else setTimeout(() => check2(res), 200);
          });
        }
      }, { rootMargin: '1440px' });
      document.querySelectorAll('.gumroad-product-embed').forEach(el => io.observe(el));
    });
  }
  {
    let p;
    document.querySelector('hy-push-state').addEventListener('load', () => {
      const io = new IntersectionObserver(async (entries) => {
        if (entries.some(x => x.isIntersecting)) {
          p = p || loadJS('https://gumroad.com/js/gumroad.js');
          const [{ code }] = await Promise.all([ppiData, p]);
          if (code) {
            document.querySelectorAll('.gumroad-button').forEach(el => { 
              if (!el.href.endsWith(code)) {
                el.href = el.href + '/' + (code || 'qr0tw8m');
              }
            });
          }
          if (!window.GumroadOverlay) {
            await new Promise(function check(res) {
              if ('createGumroadOverlay' in window) res(window.createGumroadOverlay());
              else setTimeout(() => check(res), 200);
            });
          }
        }
      }, { rootMargin: '300px' });
      document.querySelectorAll('.gumroad-button').forEach(el => io.observe(el));
    });
  }
</script>

</head>

<body class="no-break-layout no-large-headings">
  
<script>
  window._sunrise = 9;
  window._sunset =  18;
  window.match_os =  false;
  !function (window, document) {
  var LM = 'light-mode';
  var DM = 'dark-mode';
  var h = new Date().getHours();
  document.body.classList.add(DM); /*Start in dark mode and eventually switch */
  console.log("match_os " + match_os + " time " +h);
  /* if match_os is false, the time has the preference on deciding  which mode */
  if (window.match_os  && 'matchMedia' in window && window.matchMedia('(prefers-color-scheme)')) return;
  var m = h <= window._sunrise || h >= window._sunset  ? DM : LM; 
  var n = m === DM ? LM : DM;
  document.body.classList.add(m);
  document.body.classList.remove(n);
}(window, document);

</script>



<hy-push-state
  id="_pushState"
  replace-selector="#_main"
  link-selector="a[href]:not([href^='/assets/']):not(.external):not(.no-push-state)"
  script-selector="script"
  duration="500"
  hashchange
>
  
  <div id="_navbar" class="navbar fixed-top">
  <div class="content">
    <span class="sr-only">Jump to:</span>
    <div class="nav-btn-bar">
      <a id="_menu" class="nav-btn no-hover" href="#_drawer--opened">
        <span class="sr-only">Navigation</span>
        <span class="icon-menu"></span>
      </a>
      <div class="nav-span"></div>
    </div>
  </div>
</div>
<hr class="sr-only" hidden />

  <main
  id="_main"
  class="content layout-post"
  role="main"
>
  





<article id="post-blog-blog-programming-ALS_Explanation" class="page post mb6" role="article">
  <header>
    <h1 class="post-title flip-project-title">
      
        An Anime Recommendation Website! Part 2: ALS From Scratch

      
    </h1>

    <div class="post-date">
      
        
        <time datetime="2021-06-21T00:00:00-07:00">21 Jun 2021</time>
      
      
      
      
      
      









in <a href="/blog/blog/" class="flip-title">Blog</a> / <a href="/blog/programming/" class="flip-title">Programming</a>

      











    </div>

    
    
      
        
        
          <div class="lead aspect-ratio sixteen-nine flip-project-img">
            





<img
  
    src="https://takuti.github.io/Recommendation.jl/latest/assets/images/cf.png"
    
    
  
  alt="An Anime Recommendation Website! Part 2: ALS From Scratch"
  
  
  width="864"
  height="486"
  loading="lazy"
/>

          
        </div>
      
      
    

    



  
    <p class="note-sm"   >
      Image credit to https://takuti.github.io/Recommendation.jl/latest/collaborative_filtering/

    </p>
  


  </header>

  
    <p>I call this a part 1 because I’ll end up with many different parts to this blog post in the process of demonstrating the idea behind the recommendation system. For instance, this code as it stands actually won’t ever become part of the actual recommendation system for reasons I’ll talk about at the end. Instead, you can look forward to the Databricks notebook I’ll have later that demonstrates more an Apache Spark way of doing it that’ll be less math-y and a whole lot more computer science-y.</p>

<p>But either way, with the organization preliminaries out of the way, let’s get onto the fun stuff: math!</p>

<h2 id="the-setting">The setting:</h2>

<p>Something really satisfying to me about this particular data science idea here is that the idea of recommendations (a set of users rating a set of movies/shows/books) is that all the data already has a really nice representation as a matrix! For example, you could imagine that a group of friends rating movies they’ve seen written out in a format like this:</p>

<p><img src="https://takuti.github.io/Recommendation.jl/latest/assets/images/cf.png" alt="image.png" /></p>

<p><em>Image credit: https://takuti.github.io/Recommendation.jl/latest/collaborative_filtering/</em></p>

<p>From here, I think it becomes pretty clear what our machine learning task is: we start with a <em>sparse</em> (fancy word for very unfilled) matrix, call it $R$ for ratings, and we want to fill in, or “complete” $R$. And of course, completing the matrix is nothing more than exactly the predictions we are making, guesses at what the user would have rated a certain movie.</p>

<p>You can also see why it’s called <em>collaborative</em> filtering, because for instance user C as depicted above is like “yo, let me see your homework” to everyone else, and then they all collaborate to help filter out the movies/items that this user will like. Maybe we can filter out that movie 3 as a bad recommendation for user C because their profile is rather similar to user A, who did not like movie 3.</p>

<p>As I like to say, let’s start with the packages any good data-y project should start with: <code class="language-text highlighter-rouge">numpy</code> and <code class="language-text highlighter-rouge">pandas</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span>
</code></pre></div></div>

<p>And now of course let’s bring in the datasets straight from Kaggle.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">anime_data</span><span class="o">=</span><span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'anime.csv'</span><span class="p">)</span>
<span class="n">rating_data</span><span class="o">=</span><span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'rating.csv'</span><span class="p">)</span>
<span class="n">anime_data</span><span class="p">.</span><span class="n">shape</span>
</code></pre></div></div>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(12294, 7)
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">anime_data</span><span class="p">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>anime_id</th>
      <th>name</th>
      <th>genre</th>
      <th>type</th>
      <th>episodes</th>
      <th>rating</th>
      <th>members</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>32281</td>
      <td>Kimi no Na wa.</td>
      <td>Drama, Romance, School, Supernatural</td>
      <td>Movie</td>
      <td>1</td>
      <td>9.37</td>
      <td>200630</td>
    </tr>
    <tr>
      <th>1</th>
      <td>5114</td>
      <td>Fullmetal Alchemist: Brotherhood</td>
      <td>Action, Adventure, Drama, Fantasy, Magic, Mili...</td>
      <td>TV</td>
      <td>64</td>
      <td>9.26</td>
      <td>793665</td>
    </tr>
    <tr>
      <th>2</th>
      <td>28977</td>
      <td>Gintama°</td>
      <td>Action, Comedy, Historical, Parody, Samurai, S...</td>
      <td>TV</td>
      <td>51</td>
      <td>9.25</td>
      <td>114262</td>
    </tr>
    <tr>
      <th>3</th>
      <td>9253</td>
      <td>Steins;Gate</td>
      <td>Sci-Fi, Thriller</td>
      <td>TV</td>
      <td>24</td>
      <td>9.17</td>
      <td>673572</td>
    </tr>
    <tr>
      <th>4</th>
      <td>9969</td>
      <td>Gintama&amp;#039;</td>
      <td>Action, Comedy, Historical, Parody, Samurai, S...</td>
      <td>TV</td>
      <td>51</td>
      <td>9.16</td>
      <td>151266</td>
    </tr>
  </tbody>
</table>
</div>

<p>The <code class="language-text highlighter-rouge">anime_data</code> dataset should be pretty self explanatory hopefully. The highlights here are that each anime has an <code class="language-text highlighter-rouge">anime_id</code> which actually comes straight from the popular site <a href="https://myanimelist.net/">MyAnimeList</a>. For example, going to https://myanimelist.net/anime/32281 brings you directly to the page for Your Name (Kimi no Na wa.)</p>

<p>There is a <code class="language-text highlighter-rouge">rating</code> column, but that’s each anime’s average rating over all user ratings, not on a per-user basis.</p>

<p>To get the per-user basis, we need the second dataset, <code class="language-text highlighter-rouge">rating_data</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">rating_data</span><span class="p">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>anime_id</th>
      <th>rating</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>20</td>
      <td>-1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>24</td>
      <td>-1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>79</td>
      <td>-1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>226</td>
      <td>-1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>241</td>
      <td>-1</td>
    </tr>
  </tbody>
</table>
</div>

<p>And now that you know what the <code class="language-text highlighter-rouge">anime_id</code> is, maybe this dataset is a little more clear now: we have a single row for <em>every single</em> rating that happened, so the first row is user 1 rating anime 20, then the next row is user 1 rating anime 24, and so on.</p>

<p>Not only that, but you can also see a ton of -1 entries. These actually indicate a lack of a rating, that user 1 actually didn’t rate 20 at all. So there are a guaranteed 12294 entries for every single user, most of which are -1’s, but that’s why this dataset is absolutely enormous.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">rating_data</span><span class="p">.</span><span class="n">shape</span>
</code></pre></div></div>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(7813737, 3)
</code></pre></div></div>

<p>This means around 7.8 million ratings total.</p>

<p>By the way, no one ever told me about <code class="language-text highlighter-rouge">.info</code> from <code class="language-text highlighter-rouge">pandas</code>, but it’s actually pretty neat if you haven’t see it either.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">anime_data</span><span class="p">.</span><span class="n">info</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 12294 entries, 0 to 12293
Data columns (total 7 columns):
 #   Column    Non-Null Count  Dtype  
---  ------    --------------  -----  
 0   anime_id  12294 non-null  int64  
 1   name      12294 non-null  object 
 2   genre     12232 non-null  object 
 3   type      12269 non-null  object 
 4   episodes  12294 non-null  object 
 5   rating    12064 non-null  float64
 6   members   12294 non-null  int64  
dtypes: float64(1), int64(2), object(4)
memory usage: 672.5+ KB
</code></pre></div></div>

<p>It’s a bit ugly (reminds me of some of that R hypothesis testing stuff), but it’s pretty nice. From this, we can also see that there are 12294 total anime here.</p>

<p>We can do the same for the ratings dataset.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">rating_data</span><span class="p">.</span><span class="n">info</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 7813737 entries, 0 to 7813736
Data columns (total 3 columns):
 #   Column    Dtype
---  ------    -----
 0   user_id   int64
 1   anime_id  int64
 2   rating    int64
dtypes: int64(3)
memory usage: 178.8 MB
</code></pre></div></div>

<p>And we can also see that the ratings take up a good amount of memory. We’ll be cutting down on this later, but yeah, normally this amount of data wouldn’t fly.</p>

<p>With the explanation out of the way, we take the first standard step: cleaning and reshaping. The first and foremost thing to do remove all of those -1 entries, as that is sort of “non-information”. This can simply be done by replacing them with <code class="language-text highlighter-rouge">NaN</code> and dropping na.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">anime_fulldata</span><span class="o">=</span><span class="n">pd</span><span class="p">.</span><span class="n">merge</span><span class="p">(</span><span class="n">anime_data</span><span class="p">,</span><span class="n">rating_data</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="s">'anime_id'</span><span class="p">,</span><span class="n">suffixes</span><span class="o">=</span> <span class="p">[</span><span class="s">''</span><span class="p">,</span> <span class="s">'_user'</span><span class="p">])</span>
<span class="n">anime_fulldata</span> <span class="o">=</span> <span class="n">anime_fulldata</span><span class="p">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s">'name'</span><span class="p">:</span> <span class="s">'anime_title'</span><span class="p">,</span> <span class="s">'rating_user'</span><span class="p">:</span> <span class="s">'user_rating'</span><span class="p">})</span>
<span class="n">anime_fulldata</span><span class="p">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>anime_id</th>
      <th>anime_title</th>
      <th>genre</th>
      <th>type</th>
      <th>episodes</th>
      <th>rating</th>
      <th>members</th>
      <th>user_id</th>
      <th>user_rating</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>32281</td>
      <td>Kimi no Na wa.</td>
      <td>Drama, Romance, School, Supernatural</td>
      <td>Movie</td>
      <td>1</td>
      <td>9.37</td>
      <td>200630</td>
      <td>99</td>
      <td>5</td>
    </tr>
    <tr>
      <th>1</th>
      <td>32281</td>
      <td>Kimi no Na wa.</td>
      <td>Drama, Romance, School, Supernatural</td>
      <td>Movie</td>
      <td>1</td>
      <td>9.37</td>
      <td>200630</td>
      <td>152</td>
      <td>10</td>
    </tr>
    <tr>
      <th>2</th>
      <td>32281</td>
      <td>Kimi no Na wa.</td>
      <td>Drama, Romance, School, Supernatural</td>
      <td>Movie</td>
      <td>1</td>
      <td>9.37</td>
      <td>200630</td>
      <td>244</td>
      <td>10</td>
    </tr>
    <tr>
      <th>3</th>
      <td>32281</td>
      <td>Kimi no Na wa.</td>
      <td>Drama, Romance, School, Supernatural</td>
      <td>Movie</td>
      <td>1</td>
      <td>9.37</td>
      <td>200630</td>
      <td>271</td>
      <td>10</td>
    </tr>
    <tr>
      <th>4</th>
      <td>32281</td>
      <td>Kimi no Na wa.</td>
      <td>Drama, Romance, School, Supernatural</td>
      <td>Movie</td>
      <td>1</td>
      <td>9.37</td>
      <td>200630</td>
      <td>278</td>
      <td>-1</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">rating_data</span><span class="p">[</span><span class="s">"rating"</span><span class="p">].</span><span class="n">replace</span><span class="p">({</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">nan</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">rating_data</span><span class="p">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>user_id</th>
      <th>anime_id</th>
      <th>rating</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>20</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>24</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>79</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>226</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>241</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">rating_data</span> <span class="o">=</span> <span class="n">rating_data</span><span class="p">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span><span class="s">'any'</span><span class="p">)</span> 
<span class="n">rating_data</span><span class="p">.</span><span class="n">isnull</span><span class="p">().</span><span class="nb">sum</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user_id     0
anime_id    0
rating      0
dtype: int64
</code></pre></div></div>

<p>Now here’s a really important step: we’re going to be filtering again to <strong>keep only users with over a certain number of ratings</strong>. We’re actually killing two birds with one stone. The first is pretty simple - this is another good step to reduce the size of our dataset.</p>

<p>But of course we’re not throwing away data willy-nilly: the second reason we’re doing this is that collaborative filtering as you may imagine does better when the matrix is less sparse. Users that have only say rated one single item aren’t as much help. Just saying “oh, I really liked Attack on Titan” doesn’t help our algorithm realize anything about another user who say liked Attack on Titan.</p>

<p>As you can see too, there are indeed a lot of users that have rated very few anime. The next line tells us how many anime each user has rated:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">rating_data</span><span class="p">[</span><span class="s">'user_id'</span><span class="p">].</span><span class="n">value_counts</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>42635    3747
53698    2905
57620    2689
59643    2632
51693    2621
         ... 
3939        1
17218       1
11981       1
60619       1
69190       1
Name: user_id, Length: 69600, dtype: int64
</code></pre></div></div>

<p>(69600 users total). And look at what happens when I only want to see users that have rated more than 10 shows:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">counts</span> <span class="o">=</span> <span class="n">rating_data</span><span class="p">[</span><span class="s">'user_id'</span><span class="p">].</span><span class="n">value_counts</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">counts</span><span class="p">[</span><span class="n">counts</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">]</span>
</code></pre></div></div>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>42635    3747
53698    2905
57620    2689
59643    2632
51693    2621
         ... 
7865       11
39058      11
30115      11
4160       11
62278      11
Name: user_id, Length: 54204, dtype: int64
</code></pre></div></div>

<p>The number of valid users drops by like 15k, which is not far from a whole quarter of the dataset. In fact, maybe here’s a better way to visualize:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>



<span class="n">plt</span><span class="p">.</span><span class="n">hist</span><span class="p">(</span><span class="n">counts</span><span class="p">[</span><span class="n">counts</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">],</span> <span class="n">histtype</span> <span class="o">=</span> <span class="s">'stepfilled'</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>

         <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.85</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s">'# of ratings'</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s">'#7A68A6'</span><span class="p">,</span> <span class="n">density</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s">'black'</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s">'--'</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span> <span class="s">"upper right"</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="ALS_Explanation_files/ALS_Explanation_29_0.png" alt="png" /></p>

<p>So as you might expect, this is really right skewed, with lots of people leaving probably around 1-20 reviews in total, but notice that’s only around 0.6% of all the ratings. Tossing away users that have very few ratings will still leave most of the data intact, and allow us to more easily format our data in the way that we want (with every user in the dataset having more than say 10 or 100 ratings).</p>

<p>After a bit of experimenting, I found that cutting off at 200 ratings seemed to work pretty well (i.e. only consider users that have rated at least 200 anime). I drew a vertical at around this mark to show how much of the data we’d be cutting off.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">counts</span> <span class="o">=</span> <span class="n">rating_data</span><span class="p">[</span><span class="s">'user_id'</span><span class="p">].</span><span class="n">value_counts</span><span class="p">()</span>
<span class="n">rating_data</span> <span class="o">=</span> <span class="n">rating_data</span><span class="p">[</span><span class="n">rating_data</span><span class="p">[</span><span class="s">'user_id'</span><span class="p">].</span><span class="n">isin</span><span class="p">(</span><span class="n">counts</span><span class="p">[</span><span class="n">counts</span> <span class="o">&gt;=</span> <span class="mi">200</span><span class="p">].</span><span class="n">index</span><span class="p">)]</span>
</code></pre></div></div>

<p>And now we use the very fancy <code class="language-text highlighter-rouge">.pivot_table</code> to basically reshape the very “tall” ratings data into the “wider” format we want, with each column representing a show, and each row representing a user.</p>

<p>(BTW, this is the step would make any computer very sad if you tried to do this on the full dataset without filtering. The error message I got when I first tried said something like needed 6 GiB to store.)</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">anime_pivot</span><span class="o">=</span><span class="n">rating_data</span><span class="p">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s">'user_id'</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="s">'anime_id'</span><span class="p">,</span><span class="n">values</span><span class="o">=</span><span class="s">'rating'</span><span class="p">).</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">anime_pivot</span><span class="p">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>anime_id</th>
      <th>1</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>15</th>
      <th>16</th>
      <th>17</th>
      <th>18</th>
      <th>19</th>
      <th>...</th>
      <th>34238</th>
      <th>34239</th>
      <th>34240</th>
      <th>34252</th>
      <th>34283</th>
      <th>34324</th>
      <th>34325</th>
      <th>34349</th>
      <th>34367</th>
      <th>34475</th>
    </tr>
    <tr>
      <th>user_id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>5</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>8.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>6.0</td>
      <td>0.0</td>
      <td>6.0</td>
      <td>6.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>17</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>7.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>10.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>8.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>38</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>43</th>
      <td>10.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>7.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 9819 columns</p>
</div>

<p>Oohh, I think that looks pretty fancy now. Just again to get a better idea of what happened, here’s the shape now.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cols</span> <span class="o">=</span> <span class="n">anime_pivot</span><span class="p">.</span><span class="n">columns</span>

<span class="n">bt</span> <span class="o">=</span> <span class="n">anime_pivot</span><span class="p">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">my_list</span> <span class="o">=</span> <span class="n">bt</span><span class="p">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">cols</span><span class="p">[</span><span class="n">x</span><span class="p">.</span><span class="n">values</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">5</span><span class="p">]</span>


</code></pre></div></div>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>anime_id
7647     10.0
7674     10.0
15335    10.0
15417    10.0
20507    10.0
Name: 46, dtype: float64
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>

<span class="n">anime_pivot</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="n">my_list</span><span class="p">].</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">).</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>anime_id
7647     10.0
7674     10.0
15335    10.0
15417    10.0
20507    10.0
1535     10.0
6347     10.0
15775    10.0
23289    10.0
199      10.0
5680     10.0
269      10.0
16866    10.0
3702     10.0
245      10.0
3655     10.0
3588     10.0
18153    10.0
18179    10.0
7791     10.0
Name: 46, dtype: float64
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">anime_pivot</span><span class="p">.</span><span class="n">shape</span>
</code></pre></div></div>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(8713, 9819)
</code></pre></div></div>

<p>So this is simply indicating that after our filtering, we have 8713 users (down from 69600) rating 9819 anime (down from 12294). The higher frop in number of users should make a bit of sense - one way of thinking about it is that the dropped anime are “obscure” anime, but there are a lot more “obscure” users than anime in standard rating websites.</p>

<p>Either way, we’re pretty done for now with all of the pandas tools, so let’s get this out of a DataFrame and into a numpy matrix where it’ll be easier to “do math” on a matrix.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ratings</span> <span class="o">=</span> <span class="n">anime_pivot</span><span class="p">.</span><span class="n">to_numpy</span><span class="p">()</span>
</code></pre></div></div>

<p>Now that the data is in more or less the right shape now, let’s take a peek at some of it. This includes calculating the sparsity. (Recall that usually ratings matrices are sparce because it’s very unlikely that most users have rated most of the ~10k shows in our dataset).</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">matrix_size</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">prod</span><span class="p">(</span><span class="n">ratings</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">interaction</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">ratings</span><span class="p">).</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">sparsity</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">interaction</span> <span class="o">/</span> <span class="n">matrix_size</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="s">'dimension: '</span><span class="p">,</span> <span class="n">ratings</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'sparsity: {:.1f}%'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">sparsity</span><span class="p">))</span>
<span class="n">ratings</span>
</code></pre></div></div>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dimension:  (8713, 9819)
sparsity: 3.7%





array([[0., 0., 8., ..., 0., 0., 0.],
       [0., 0., 0., ..., 0., 0., 0.],
       [0., 0., 7., ..., 0., 0., 0.],
       ...,
       [0., 0., 0., ..., 0., 0., 0.],
       [9., 7., 9., ..., 0., 0., 0.],
       [9., 8., 9., ..., 0., 0., 0.]])
</code></pre></div></div>

<p>And so our sparsity is around 3.7%, which actually is an alright number. A heuristic I often hear is that 1% is the lower bound for amounts of data you can perform reasonable analysis on. Would have liked it to be a bit higher, but whenever I did things like increasing the number of ratings cutoff, we ended up with worse accuracy numbers.</p>

<p>Now the final step in most good machine learning notebooks: the test-train split. I did this a bit more manually</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">create_train_test</span><span class="p">(</span><span class="n">ratings</span><span class="p">):</span>
    <span class="s">"""
    split into training and test sets,
    remove 10 ratings from each user
    and assign them to the test set
    """</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ratings</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">train</span> <span class="o">=</span> <span class="n">ratings</span><span class="p">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ratings</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">test_index</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">choice</span><span class="p">(</span>
            <span class="n">np</span><span class="p">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">ratings</span><span class="p">[</span><span class="n">user</span><span class="p">]),</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">replace</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>

        <span class="n">train</span><span class="p">[</span><span class="n">user</span><span class="p">,</span> <span class="n">test_index</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">test</span><span class="p">[</span><span class="n">user</span><span class="p">,</span> <span class="n">test_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratings</span><span class="p">[</span><span class="n">user</span><span class="p">,</span> <span class="n">test_index</span><span class="p">]</span>
        
    <span class="c1"># assert that training and testing set are truly disjoint
</span>    <span class="k">assert</span> <span class="n">np</span><span class="p">.</span><span class="nb">all</span><span class="p">(</span><span class="n">train</span> <span class="o">*</span> <span class="n">test</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">train</span><span class="p">,</span> <span class="n">test</span>

<span class="n">train</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="n">create_train_test</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>
<span class="k">del</span> <span class="n">ratings</span>
<span class="n">train</span>
</code></pre></div></div>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>array([[0., 0., 8., ..., 0., 0., 0.],
       [0., 0., 0., ..., 0., 0., 0.],
       [0., 0., 0., ..., 0., 0., 0.],
       ...,
       [0., 0., 0., ..., 0., 0., 0.],
       [9., 7., 9., ..., 0., 0., 0.],
       [9., 8., 9., ..., 0., 0., 0.]])
</code></pre></div></div>

<p>And with that, pretty much all of the data preparation is taken care of. So now we can <em>finally</em> start machine learning.</p>

<h2 id="the-machine-learning">The machine learning</h2>

<p>The algorithm we’ll be using is called <strong>Alternating Least Squares (ALS)</strong>. You’ll see why in a second, but we have to set up some theory first. Recall that we’re trying to “complete” this matrix $R$ (like completing a Sudoku puzzle).</p>

<p>The idea is to use matrix factorization, i.e. try to find matrices</p>

<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi mathvariant="normal">∣</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi mathvariant="normal">∣</mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>1</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mi>n</mi></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi mathvariant="normal">∣</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi mathvariant="normal">∣</mi></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">X = 

\begin{bmatrix}

    \vert &amp; &amp; \vert \\

    x_1  &amp; \dots &amp; x_n   \\

    \vert &amp; &amp; \vert

\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.6010299999999997em;vertical-align:-1.55002em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.0510099999999998em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-2.8099900000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-4.05101em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">∣</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">∣</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="minner">…</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">∣</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">∣</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.0510099999999998em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-2.8099900000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-4.05101em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span></span></span></span></span></span>

<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi mathvariant="normal">∣</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi mathvariant="normal">∣</mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>y</mi><mn>1</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>y</mi><mi>m</mi></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi mathvariant="normal">∣</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi mathvariant="normal">∣</mi></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">Y = 

\begin{bmatrix}

    \vert &amp; &amp; \vert \\

    y_1  &amp; \dots &amp; y_m   \\

    \vert &amp; &amp; \vert

\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.6010299999999997em;vertical-align:-1.55002em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.0510099999999998em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-2.8099900000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-4.05101em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">∣</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">∣</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="minner">…</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">∣</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">∣</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.0510099999999998em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-2.8099900000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-4.05101em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span></span></span></span></span></span>

<p>matrices such that $R \approx X^T Y$. Notice then that if we find such a factors $X,Y$, we’d have $r_{ui} \approx x_u^t y_i$. In other words, each $x_u$ represents one “factor” that summarizes user $u$ and, we multiply each factor to by the item summarized by $y_i$ to get recover the rating that would result from that user against that item. Normally of course, to make the optimization a lot more managable, these factor vectors would be in a much lower dimension than the size of $R$, like maybe around 10, or however many makes sense for your dataset to try to summarize each user/item. Then we use this loss function to minimize against:</p>

<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mtext>min</mtext><mrow><mi>X</mi><mo separator="true">,</mo><mi>Y</mi></mrow></msub><munder><mo>∑</mo><mrow><msub><mi>r</mi><mrow><mi>u</mi><mi>i</mi></mrow></msub><mtext> observed</mtext></mrow></munder><mo stretchy="false">(</mo><msub><mi>r</mi><mrow><mi>u</mi><mi>i</mi></mrow></msub><mo>−</mo><msubsup><mi>x</mi><mi>u</mi><mi>T</mi></msubsup><msub><mi>y</mi><mi>i</mi></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mi>λ</mi><mrow><mo fence="true">(</mo><munder><mo>∑</mo><mi>u</mi></munder><mi mathvariant="normal">∥</mi><msub><mi>x</mi><mi>u</mi></msub><msup><mi mathvariant="normal">∥</mi><mn>2</mn></msup><mo>+</mo><munder><mo>∑</mo><mi>i</mi></munder><mi mathvariant="normal">∥</mi><msub><mi>y</mi><mi>i</mi></msub><msup><mi mathvariant="normal">∥</mi><mn>2</mn></msup><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">\text{min}_{X,Y} \sum_{r_{ui} \text{ observed}}(r_{ui} - x_u^T y_i)^2 + \lambda \left( \sum_u \|x_u\|^2 + \sum_i  \|y_i\|^2 \right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.4522180000000002em;vertical-align:-1.402213em;"></span><span class="mord"><span class="mord text"><span class="mord">min</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.328331em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.07847em;">X</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.22222em;">Y</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0500050000000003em;"><span style="top:-1.847887em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:-0.02778em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">u</span><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mord text mtight"><span class="mord mtight"> observed</span></span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.402213em;"><span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">u</span><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.1413309999999999em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913309999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">u</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:3.027669em;vertical-align:-1.277669em;"></span><span class="mord mathdefault">λ</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">(</span></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.8999949999999999em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">u</span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.250005em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">∥</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">u</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord">∥</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0500050000000003em;"><span style="top:-1.872331em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.277669em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">∥</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord">∥</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size4">)</span></span></span></span></span></span></span>

<p>What’s going on here? Notice that the first term is just a standard least squares loss function that penalizes us if of course we didn’t get the original known ratings correct.</p>

<p>Then the second term is $\lambda$, which is called a <em>regularizer</em>. This basically means that we penalize (make the error worse) of attempts that have very high numbers in the $x_u$ or $y_i$ vector, which makes sense, we want a solution that keeps the numbers rather tame rather than extreme to keep the ratings as close to the 1-10 range as possible.</p>

<p>Now unfortunately this <em>almost</em> look convex, but it’s not because of the $x_u^T y_i$ term. However, here’s the key observation: if we don’t minimize over both $X,Y$ at the same time, and instead treat $Y$ as fixed first and just optimize over possible $X$ matrices, we do have a convex function. (In fact, we’ll essentially just have a least squares problem with a regularizer.)</p>

<p>Once that’s optimized, we can just hold $X$ constant and optimize for $Y$, which is symmetrically convex. This could possibly mess up our optimization of $X$, so reverse and keep repeating until convergence.</p>

<p>Now we’ll actually be implementing this as a Python class simply because we’ll want to be storing a lot of instance variables and methods for easy access later.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ALS</span><span class="p">:</span>
    <span class="s">"""
    A matrix factorization model using Alternating Least Squares
    to complete a ratings matrix
    
    Parameters
    ----------
    n_iters : int
        number of iterations to train the algorithm
        
    rank : int
        number of latent factors, the linear algebra thingy
        
    reg : float
        regularization term for item/user latent factors,
        normally called lambda but that's taken in python
    """</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_iters</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">reg</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">reg</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">n_iters</span> <span class="o">=</span> <span class="n">n_iters</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">rank</span> <span class="o">=</span> <span class="n">rank</span>  
        
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train</span><span class="p">,</span> <span class="n">test</span><span class="p">):</span>
        <span class="s">"""
        pass in training and testing at the same time to record
        model convergence, assuming both dataset is in the form
        of User x Item matrix with cells as ratings
        """</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">n_user</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">n_item</span> <span class="o">=</span> <span class="n">train</span><span class="p">.</span><span class="n">shape</span>

        <span class="c1"># random initialization of X (matrix user factor columns)
</span>        <span class="c1"># and Y (matrix of item factor columns) 
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">user_factors</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">random</span><span class="p">((</span><span class="bp">self</span><span class="p">.</span><span class="n">n_user</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">rank</span><span class="p">))</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">item_factors</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">random</span><span class="p">((</span><span class="bp">self</span><span class="p">.</span><span class="n">n_item</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">rank</span><span class="p">))</span>
        
        <span class="c1"># for plotting, to see how error decreases
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">test_mse_record</span>  <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">train_mse_record</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># main iteration
</span>        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">n_iters</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">user_factors</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_als_step</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">user_factors</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">item_factors</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">item_factors</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_als_step</span><span class="p">(</span><span class="n">train</span><span class="p">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">item_factors</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">user_factors</span><span class="p">)</span> 

            <span class="c1"># at every step, compute current predictions to get error
</span>            <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">predict</span><span class="p">()</span>
            <span class="n">test_mse</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">compute_mse</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">predictions</span><span class="p">)</span>
            <span class="n">train_mse</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">compute_mse</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">predictions</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">test_mse_record</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">test_mse</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">train_mse_record</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_mse</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span>    
    
    <span class="k">def</span> <span class="nf">_als_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ratings</span><span class="p">,</span> <span class="n">solve_vecs</span><span class="p">,</span> <span class="n">fixed_vecs</span><span class="p">):</span>
        <span class="s">"""
        when updating the user matrix,
        the item matrix is the fixed vector and vice versa
        """</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">fixed_vecs</span><span class="p">.</span><span class="n">T</span><span class="p">.</span><span class="n">dot</span><span class="p">(</span><span class="n">fixed_vecs</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="p">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">rank</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">reg</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">ratings</span><span class="p">.</span><span class="n">dot</span><span class="p">(</span><span class="n">fixed_vecs</span><span class="p">)</span>
        <span class="n">A_inv</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">linalg</span><span class="p">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
        <span class="n">solve_vecs</span> <span class="o">=</span> <span class="n">b</span><span class="p">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A_inv</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">solve_vecs</span>
    
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""predict ratings for every user and item"""</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">user_factors</span><span class="p">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">item_factors</span><span class="p">.</span><span class="n">T</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pred</span>
    
    <span class="o">@</span><span class="nb">staticmethod</span>
    <span class="k">def</span> <span class="nf">compute_mse</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
        <span class="s">"""ignore zero terms prior to comparing the mse"""</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span>
        <span class="n">mse</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_true</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">y_pred</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">amax</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="p">.</span><span class="n">amin</span><span class="p">(</span><span class="n">y_true</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">mse</span>
    
</code></pre></div></div>

<p>A couple of highlights, notice that for all the matrix-y computation, we only needed one function. This is still thanks to the symmetry of the objective function in $X$ and $Y$: if you fix $X$ and optimize $Y$, the equation looks exactly the same as if you’re fixing $Y$ and optimizing $X$, so we literally just switch the order of arguments when we call the single function.</p>

<p>By the way, mean square error is just a standard way of computing</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">plot_learning_curve</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="s">"""visualize the training/testing loss"""</span>
    <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">test_mse_record</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s">'Test'</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="n">linewidth</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">train_mse_record</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s">'Train'</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="n">linewidth</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'iterations'</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'MSE'</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="s">f'rank = </span><span class="si">{</span><span class="n">model</span><span class="p">.</span><span class="n">rank</span><span class="si">}</span><span class="s">, reg = </span><span class="si">{</span><span class="n">model</span><span class="p">.</span><span class="n">reg</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span> <span class="s">'best'</span><span class="p">)</span>
</code></pre></div></div>

<p>And that’s pretty much it! That’s the machine learning! As far as I’ve seen it’s pretty simple as far as machine learning algorithms go, but I still think that idea of “alternating” and optimizing one at a time to make the problem so much easier is really cool. Even more than that too, it’s one of those ideas that someone who didn’t know better might just throw out there and that you might expect to totally not work, but it actually does end up converging.</p>

<p>So now, like many standard machine learning practices, there are still a few knobs that we as the architects can turn to make further improvements. The most obvious ones we’ll be tackling here are to change around those parameters for rank and regularization. I’ll be doing this in a rather simple way, just rerunning the model over and over again with different parameters until we find one a set that minimizes the error.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_ALS</span><span class="p">(</span><span class="n">factors</span><span class="p">,</span> <span class="n">regs</span><span class="p">):</span>

    <span class="n">min_error</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s">'inf'</span><span class="p">)</span>

    <span class="n">best_rank</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="n">best_regularization</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">best_model</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">for</span> <span class="n">factor</span> <span class="ow">in</span> <span class="n">factors</span><span class="p">:</span>

        <span class="k">for</span> <span class="n">my_reg</span> <span class="ow">in</span> <span class="n">regs</span><span class="p">:</span>

            <span class="k">print</span><span class="p">(</span><span class="n">factor</span><span class="p">,</span> <span class="n">my_reg</span><span class="p">)</span>





            <span class="n">als</span> <span class="o">=</span> <span class="n">ALS</span><span class="p">(</span><span class="n">n_iters</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">rank</span> <span class="o">=</span> <span class="n">factor</span><span class="p">,</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">my_reg</span><span class="p">)</span>

            <span class="n">als</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">test</span><span class="p">)</span>



            <span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">()</span>



            <span class="n">plot_learning_curve</span><span class="p">(</span><span class="n">als</span><span class="p">)</span>

            

            <span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>

            <span class="k">print</span><span class="p">(</span><span class="s">f'</span><span class="si">{</span><span class="n">factor</span><span class="si">}</span><span class="s"> latent factors and regularization = </span><span class="si">{</span><span class="n">my_reg</span><span class="si">}</span><span class="s">: validation RMSE is </span><span class="si">{</span><span class="n">als</span><span class="p">.</span><span class="n">train_mse_record</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">als</span><span class="p">.</span><span class="n">train_mse_record</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_error</span><span class="p">:</span>

                <span class="n">min_error</span> <span class="o">=</span> <span class="n">als</span><span class="p">.</span><span class="n">train_mse_record</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">best_rank</span> <span class="o">=</span> <span class="n">factor</span>

                <span class="n">best_rank</span> <span class="o">=</span> <span class="n">my_reg</span>

                <span class="n">best_model</span> <span class="o">=</span> <span class="n">als</span>

                

    <span class="k">print</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">The best model has {} latent factors and '</span>

          <span class="s">'regularization = {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">best_rank</span><span class="p">,</span> <span class="n">best_regularization</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">best_model</span>


</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">best_als</span> <span class="o">=</span> <span class="n">test_ALS</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">10</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="p">[.</span><span class="mi">15</span><span class="p">,</span> <span class="p">.</span><span class="mi">20</span><span class="p">,</span> <span class="p">.</span><span class="mi">25</span><span class="p">])</span>
</code></pre></div></div>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>100 0.15
</code></pre></div></div>

<p><img src="ALS_Explanation_files/ALS_Explanation_51_1.svg" alt="svg" /></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>100 latent factors and regularization = 0.15: validation RMSE is 2.0629825922048317
100 0.2
</code></pre></div></div>

<p><img src="ALS_Explanation_files/ALS_Explanation_51_3.svg" alt="svg" /></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>100 latent factors and regularization = 0.2: validation RMSE is 2.0645885054062694
100 0.25
</code></pre></div></div>

<p><img src="ALS_Explanation_files/ALS_Explanation_51_5.svg" alt="svg" /></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>100 latent factors and regularization = 0.25: validation RMSE is 2.0651915286109905
200 0.15
</code></pre></div></div>

<p><img src="ALS_Explanation_files/ALS_Explanation_51_7.svg" alt="svg" /></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>200 latent factors and regularization = 0.15: validation RMSE is 1.6989438453979033
200 0.2
</code></pre></div></div>

<p><img src="ALS_Explanation_files/ALS_Explanation_51_9.svg" alt="svg" /></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>200 latent factors and regularization = 0.2: validation RMSE is 1.6998052179555423
200 0.25
</code></pre></div></div>

<p><img src="ALS_Explanation_files/ALS_Explanation_51_11.svg" alt="svg" /></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>200 latent factors and regularization = 0.25: validation RMSE is 1.7009243667280873
300 0.15
</code></pre></div></div>

<p><img src="ALS_Explanation_files/ALS_Explanation_51_13.svg" alt="svg" /></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>300 latent factors and regularization = 0.15: validation RMSE is 1.4319365065787886
300 0.2
</code></pre></div></div>

<p><img src="ALS_Explanation_files/ALS_Explanation_51_15.svg" alt="svg" /></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>300 latent factors and regularization = 0.2: validation RMSE is 1.4331314315800647
300 0.25
</code></pre></div></div>

<p><img src="ALS_Explanation_files/ALS_Explanation_51_17.svg" alt="svg" /></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>300 latent factors and regularization = 0.25: validation RMSE is 1.4337480456022065
400 0.15
</code></pre></div></div>

<p><img src="ALS_Explanation_files/ALS_Explanation_51_19.svg" alt="svg" /></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>400 latent factors and regularization = 0.15: validation RMSE is 1.2189224538768477
400 0.2
</code></pre></div></div>

<p><img src="ALS_Explanation_files/ALS_Explanation_51_21.svg" alt="svg" /></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>400 latent factors and regularization = 0.2: validation RMSE is 1.220164657281094
400 0.25
</code></pre></div></div>

<p><img src="ALS_Explanation_files/ALS_Explanation_51_23.svg" alt="svg" /></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>400 latent factors and regularization = 0.25: validation RMSE is 1.2209445028822967
500 0.15
</code></pre></div></div>

<p><img src="ALS_Explanation_files/ALS_Explanation_51_25.svg" alt="svg" /></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>500 latent factors and regularization = 0.15: validation RMSE is 1.0456991188926468
500 0.2
</code></pre></div></div>

<p><img src="ALS_Explanation_files/ALS_Explanation_51_27.svg" alt="svg" /></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>500 latent factors and regularization = 0.2: validation RMSE is 1.0467176552011828
500 0.25
</code></pre></div></div>

<p><img src="ALS_Explanation_files/ALS_Explanation_51_29.svg" alt="svg" /></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>500 latent factors and regularization = 0.25: validation RMSE is 1.0478343728527022
600 0.15
</code></pre></div></div>

<p><img src="ALS_Explanation_files/ALS_Explanation_51_31.svg" alt="svg" /></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>600 latent factors and regularization = 0.15: validation RMSE is 0.9009767772788353
600 0.2
</code></pre></div></div>

<p><img src="ALS_Explanation_files/ALS_Explanation_51_33.svg" alt="svg" /></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>600 latent factors and regularization = 0.2: validation RMSE is 0.9021863737737588
600 0.25
</code></pre></div></div>

<p><img src="ALS_Explanation_files/ALS_Explanation_51_35.svg" alt="svg" /></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>600 latent factors and regularization = 0.25: validation RMSE is 0.9031407089645205
700 0.15
</code></pre></div></div>

<p><img src="ALS_Explanation_files/ALS_Explanation_51_37.svg" alt="svg" /></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>700 latent factors and regularization = 0.15: validation RMSE is 0.778942074072108
700 0.2
</code></pre></div></div>

<p><img src="ALS_Explanation_files/ALS_Explanation_51_39.svg" alt="svg" /></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>700 latent factors and regularization = 0.2: validation RMSE is 0.7799283174829428
700 0.25
</code></pre></div></div>

<p><img src="ALS_Explanation_files/ALS_Explanation_51_41.svg" alt="svg" /></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>700 latent factors and regularization = 0.25: validation RMSE is 0.7808132441055287
800 0.15
</code></pre></div></div>

<p><img src="ALS_Explanation_files/ALS_Explanation_51_43.svg" alt="svg" /></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>800 latent factors and regularization = 0.15: validation RMSE is 0.6752493857981295
800 0.2
</code></pre></div></div>

<p><img src="ALS_Explanation_files/ALS_Explanation_51_45.svg" alt="svg" /></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>800 latent factors and regularization = 0.2: validation RMSE is 0.6762372769929852
800 0.25
</code></pre></div></div>

<p><img src="ALS_Explanation_files/ALS_Explanation_51_47.svg" alt="svg" /></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>800 latent factors and regularization = 0.25: validation RMSE is 0.6772041449371212
900 0.15
</code></pre></div></div>

<p><img src="ALS_Explanation_files/ALS_Explanation_51_49.svg" alt="svg" /></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>900 latent factors and regularization = 0.15: validation RMSE is 0.5864264259589638
900 0.2
</code></pre></div></div>

<p><img src="ALS_Explanation_files/ALS_Explanation_51_51.svg" alt="svg" /></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>900 latent factors and regularization = 0.2: validation RMSE is 0.5872564472879721
900 0.25
</code></pre></div></div>

<p><img src="ALS_Explanation_files/ALS_Explanation_51_53.svg" alt="svg" /></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>900 latent factors and regularization = 0.25: validation RMSE is 0.5880839764818996
1000 0.15
</code></pre></div></div>

<p><img src="ALS_Explanation_files/ALS_Explanation_51_55.svg" alt="svg" /></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1000 latent factors and regularization = 0.15: validation RMSE is 0.5098030597726719
1000 0.2
</code></pre></div></div>

<p><img src="ALS_Explanation_files/ALS_Explanation_51_57.svg" alt="svg" /></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1000 latent factors and regularization = 0.2: validation RMSE is 0.5108041692369727
1000 0.25
</code></pre></div></div>

<p><img src="ALS_Explanation_files/ALS_Explanation_51_59.svg" alt="svg" /></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1000 latent factors and regularization = 0.25: validation RMSE is 0.5115036124585726

The best model has 0.15 latent factors and regularization = 0
</code></pre></div></div>

<p>(And we get some pretty clear signs of overfitting past rank 200).</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">best_als</span><span class="p">.</span><span class="n">predict</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>array([[ 2.56274937e+00,  1.16276848e+00,  3.21482109e+00, ...,
        -2.99449524e-02, -1.46400569e-02, -3.72779239e-04],
       [ 3.51537758e-01, -1.02474420e+00,  2.14228881e+00, ...,
        -1.34284410e-02,  1.99208294e-03,  9.94906979e-03],
       [ 4.09141195e+00,  1.70242472e+00,  3.15586421e+00, ...,
         3.09869749e-03,  7.17839259e-04,  2.68027908e-02],
       ...,
       [ 2.19355801e-01,  4.41395374e-01,  3.37594716e-01, ...,
         1.93705514e-03, -2.55587166e-04,  1.29430481e-02],
       [ 6.73220411e+00,  4.00699476e+00,  4.22009172e+00, ...,
        -3.37342630e-02,  1.35956518e-02,  6.27329934e-03],
       [ 6.72736354e+00,  4.75549634e+00,  5.00467333e+00, ...,
        -8.51482392e-03,  2.44434181e-03,  2.34263313e-03]])
</code></pre></div></div>

<p>But that’s it now! This is our reconstructed (“learned”) ratings matrix! With this information, we can now get</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">best_als</span><span class="p">.</span><span class="n">predict</span><span class="p">(),</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">anime_pivot</span><span class="p">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">anime_pivot</span><span class="p">.</span><span class="n">index</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span><span class="p">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>anime_id</th>
      <th>1</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>15</th>
      <th>16</th>
      <th>17</th>
      <th>18</th>
      <th>19</th>
      <th>...</th>
      <th>34238</th>
      <th>34239</th>
      <th>34240</th>
      <th>34252</th>
      <th>34283</th>
      <th>34324</th>
      <th>34325</th>
      <th>34349</th>
      <th>34367</th>
      <th>34475</th>
    </tr>
    <tr>
      <th>user_id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>5</th>
      <td>2.562749</td>
      <td>1.162768</td>
      <td>3.214821</td>
      <td>0.293718</td>
      <td>0.471657</td>
      <td>2.827497</td>
      <td>0.753208</td>
      <td>1.159920</td>
      <td>0.748092</td>
      <td>1.215935</td>
      <td>...</td>
      <td>0.011473</td>
      <td>0.007717</td>
      <td>0.271801</td>
      <td>0.014540</td>
      <td>-0.015202</td>
      <td>-0.000045</td>
      <td>0.025190</td>
      <td>-0.029945</td>
      <td>-0.014640</td>
      <td>-0.000373</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0.351538</td>
      <td>-1.024744</td>
      <td>2.142289</td>
      <td>0.068091</td>
      <td>0.227317</td>
      <td>0.928156</td>
      <td>-2.087391</td>
      <td>0.474109</td>
      <td>0.090831</td>
      <td>1.465056</td>
      <td>...</td>
      <td>0.007809</td>
      <td>0.005742</td>
      <td>-0.083864</td>
      <td>0.001615</td>
      <td>0.025667</td>
      <td>-0.018983</td>
      <td>0.036369</td>
      <td>-0.013428</td>
      <td>0.001992</td>
      <td>0.009949</td>
    </tr>
    <tr>
      <th>17</th>
      <td>4.091412</td>
      <td>1.702425</td>
      <td>3.155864</td>
      <td>-0.536683</td>
      <td>-0.294676</td>
      <td>0.426128</td>
      <td>0.055513</td>
      <td>-0.034629</td>
      <td>0.127867</td>
      <td>4.266287</td>
      <td>...</td>
      <td>0.193421</td>
      <td>-0.009706</td>
      <td>2.925138</td>
      <td>0.000583</td>
      <td>0.115008</td>
      <td>0.026459</td>
      <td>-0.058944</td>
      <td>0.003099</td>
      <td>0.000718</td>
      <td>0.026803</td>
    </tr>
    <tr>
      <th>38</th>
      <td>0.887254</td>
      <td>-0.388829</td>
      <td>1.304103</td>
      <td>-0.045049</td>
      <td>-0.334334</td>
      <td>0.326981</td>
      <td>-0.558836</td>
      <td>-0.062609</td>
      <td>0.500415</td>
      <td>0.952750</td>
      <td>...</td>
      <td>-0.078735</td>
      <td>-0.004248</td>
      <td>0.168934</td>
      <td>-0.031152</td>
      <td>0.052439</td>
      <td>-0.004278</td>
      <td>-0.050811</td>
      <td>-0.025365</td>
      <td>-0.003588</td>
      <td>0.011929</td>
    </tr>
    <tr>
      <th>43</th>
      <td>4.146058</td>
      <td>1.328764</td>
      <td>2.461934</td>
      <td>0.640694</td>
      <td>0.180400</td>
      <td>1.172276</td>
      <td>-0.341378</td>
      <td>-0.071348</td>
      <td>-0.197650</td>
      <td>0.750328</td>
      <td>...</td>
      <td>0.065064</td>
      <td>0.021012</td>
      <td>0.427438</td>
      <td>0.001162</td>
      <td>-0.032281</td>
      <td>0.010966</td>
      <td>-0.007738</td>
      <td>-0.021349</td>
      <td>-0.004984</td>
      <td>-0.009888</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 9785 columns</p>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">anime_pivot</span><span class="p">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div></div>

<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>anime_id</th>
      <th>1</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>15</th>
      <th>16</th>
      <th>17</th>
      <th>18</th>
      <th>19</th>
      <th>...</th>
      <th>34238</th>
      <th>34239</th>
      <th>34240</th>
      <th>34252</th>
      <th>34283</th>
      <th>34324</th>
      <th>34325</th>
      <th>34349</th>
      <th>34367</th>
      <th>34475</th>
    </tr>
    <tr>
      <th>user_id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>5</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>8.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>6.0</td>
      <td>0.0</td>
      <td>6.0</td>
      <td>6.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>17</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>7.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>10.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>8.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>38</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>43</th>
      <td>10.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>7.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 9785 columns</p>
</div>

<p>And so if we match up the entries, you’ll see that while the entries are sort of “off” by some scaling, the entries that the user originally marked as high are also high in the predictions, which is a good “intuitive” sign that something’s going right! Then the idea is that for a particular user, we can just find the highest entries that they haven’t marked rated yet.</p>

<p>So now that we have all the prediction numbers, we can actually make some recommendations! The idea will be what was outlined just above. Implementing it will involve “zeroing” out all the entries that are nonzero (rated) using entrywise series multiplication for pandas.</p>

<p>Then, out of that whole list, sorting by top rated first will let those zero’d out ones we don’t care about sink to the bottom, leaving only new shows.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">list</span><span class="p">((</span><span class="n">df</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">anime_pivot</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)).</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)[:</span><span class="mi">5</span><span class="p">].</span><span class="n">index</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[11061, 154, 11771, 18119, 30276]
</code></pre></div></div>

<p>And now we can just look up those ids with the original <code class="language-text highlighter-rouge">anime.csv</code> dataset.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">anime_data</span> <span class="o">=</span> <span class="n">anime_data</span><span class="p">.</span><span class="n">set_index</span><span class="p">(</span><span class="s">"anime_id"</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">anime_data</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">32281</span><span class="p">][</span><span class="s">'name'</span><span class="p">]</span>
</code></pre></div></div>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>'Kimi no Na wa.'
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">generate_recommendations</span><span class="p">(</span><span class="n">userid</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"You really liked:"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">liked</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">anime_pivot</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">userid</span><span class="p">].</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)[:</span><span class="n">n</span><span class="p">].</span><span class="n">index</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">anime_data</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">liked</span><span class="p">][</span><span class="s">'name'</span><span class="p">])</span>
        
        
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n\n</span><span class="s">And here are the recommendations"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">recommended</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">((</span><span class="n">df</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">userid</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">anime_pivot</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">userid</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)).</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)[:</span><span class="n">n</span><span class="p">].</span><span class="n">index</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">anime_data</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">recommended</span><span class="p">][</span><span class="s">'name'</span><span class="p">])</span>
        
<span class="n">generate_recommendations</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>You really liked:
Gintama Movie: Kanketsu-hen - Yorozuya yo Eien Nare
Great Teacher Onizuka
Steins;Gate Movie: Fuka Ryouiki no Déjà vu
JoJo no Kimyou na Bouken (TV)
Detroit Metal City


And here are the recommendations
Hunter x Hunter (2011)
Shaman King
Kuroko no Basket
Servant x Service
One Punch Man
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">generate_recommendations</span><span class="p">(</span><span class="mi">38</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>You really liked:
Hellsing Ultimate
Magi: The Kingdom of Magic
Neon Genesis Evangelion: The End of Evangelion
Stranger: Mukou Hadan
Code Geass: Hangyaku no Lelouch


And here are the recommendations
Death Parade
Nanatsu no Taizai
Mahouka Koukou no Rettousei
Shingeki no Bahamut: Genesis
Zetsuen no Tempest
</code></pre></div></div>

<p>Nice! We can see that even these initial results make a good amount of sense. User id 5 seems to like lots of shounen/action anime so we got recommended One Punch Man, Hunter x Hunter, and Kuroko no Basket.</p>

<p>And user 38 also likes action shows, but more of the psychological/drama kind (Code Geass, Neon Genesis Evangelion), so we get recommended things like Death Parade and Zetsuen no Tempest.</p>

<p>Bonus points if you know all of those by the way, I certainly didn’t haha</p>

<h1 id="conclusion">Conclusion</h1>

<p>But here’s the thing: in actual apps and stuff, I really don’t want to be reinventing the wheel. In other words, pretty much every famous machine learning algorithm under the sun has been <em>greatly</em> optimized, so why bother using this method that takes 20 minutes per run?</p>

<p>No, I’ll go into more detail in the blog post, but I’ll instead be using Databricks instead, and not gonna lie it’s pretty magical.</p>

  
</article>






<hr class="dingbat related" />




  
     


  <aside class="about related mt4 mb4" role="complementary">
    
    

<div class="author mt4">
  

  
    





<img
  
    src="/assets/icons/icon.jpg"
    srcset="/assets/icons/icon.jpg 1x,/assets/icons/icon.jpg 2x"
    
  
  alt="Michael Ting"
  class="avatar"
  
  width="120"
  height="120"
  loading="lazy"
/>

  

  
  
  <h2  class="page-title hr-bottom">
    About
  </h2>

  <p>Michael is an Applied Math student at UCLA, but also minoring in Statistics and Asian Languages, with a specialization in computing - just studying anything that seems fun to me. Hoping that one day he’ll able to apply all the math+programming he’s been enjoying working on to help people solve their real-world problems. But most importantly? “I can only use SpeedChat”.</p>


  <div class="sidebar-social">
    <span class="sr-only">Social:</span>
<ul>
  
    
      



  

  
  
  
  

  

  

  <li>
    <a href="https://github.com/mting314" title="GitHub" class="no-mark-external">
      <span class="icon-github"></span>
      <span class="sr-only">GitHub</span>
    </a>
  </li>


    
      



  

  
  
  
  

  

  

  <li>
    <a href="mailto:giaga7@gmail.com" title="Email" class="no-mark-external">
      <span class="icon-mail"></span>
      <span class="sr-only">Email</span>
    </a>
  </li>


    
      



  

  
  
  
  

  

  

  <li>
    <a href="https://play.spotify.com/user/12162364462" title="Spotify" class="no-mark-external">
      <span class="icon-spotify"></span>
      <span class="sr-only">Spotify</span>
    </a>
  </li>


    
      



  

  
  
  
  

  

  

  <li>
    <a href="https://www.linkedin.com/in/michael-ting314" title="LinkedIn" class="no-mark-external">
      <span class="icon-linkedin2"></span>
      <span class="sr-only">LinkedIn</span>
    </a>
  </li>


    
  
</ul>

  </div>
</div>

  </aside>


  

  
    


  

  
    


  <aside class="other-projects related mb0" role="complementary">  <h2>Related Posts</h2>  <div class="columns">          <div class="column column-1-2">                  <article class="project-card">  <a href="/blog/blog/programming/2021-08-05-online-grade-distributions/" class="no-hover no-print-link flip-project" tabindex="-1">    <div class="project-card-img aspect-ratio sixteen-nine flip-project-img">              <img      src="https://takuti.github.io/Recommendation.jl/latest/assets/images/cf.png"        sizes="(min-width: 86em) 31.5rem, (min-width: 54em) 26.5rem, (min-width: 42em) 23.5rem, 48rem"    alt="How Grade Distributions Changed During Online Learning"      width="864"  height="486"  loading="lazy"/>          </div>  </a>  <h3 class="project-card-title flip-project-title">    <a href="/blog/blog/programming/2021-08-05-online-grade-distributions/" class="flip-title">How Grade Distributions Changed During Online Learning</a>  </h3>      <p class="project-card-text fine" property="disambiguatingDescription">      The COVID-19 pandemic changed routines in regard to learning and teaching. How did those changes impact grade distributions?    </p>      <a class="fill-card no-hover" href="/blog/blog/programming/2021-08-05-online-grade-distributions/" tabindex="-1"><span class="sr-only">Continue reading How Grade Distributions Changed During Online Learning</span></a></article>              </div>          <div class="column column-1-2">                  <article class="project-card">  <a href="/blog/blog/programming/2021-08-01-pubg/" class="no-hover no-print-link flip-project" tabindex="-1">    <div class="project-card-img aspect-ratio sixteen-nine flip-project-img">              <img      src="/assets/img/projects/pubg_thumbnail.jpg"        sizes="(min-width: 86em) 31.5rem, (min-width: 54em) 26.5rem, (min-width: 42em) 23.5rem, 48rem"    alt="PUBG Data Analysis"      width="864"  height="486"  loading="lazy"/>          </div>  </a>  <h3 class="project-card-title flip-project-title">    <a href="/blog/blog/programming/2021-08-01-pubg/" class="flip-title">PUBG Data Analysis</a>  </h3>      <p class="project-card-text fine" property="disambiguatingDescription">      Map of all kills across thousands of PUBG games, highlighted by the stage of the game in which the kill occurred.    </p>      <a class="fill-card no-hover" href="/blog/blog/programming/2021-08-01-pubg/" tabindex="-1"><span class="sr-only">Continue reading PUBG Data Analysis</span></a></article>              </div>      </div></aside>

  

  
    


  <aside class="related mb4" role="complementary">  <h2 class="hr-bottom">Random Posts</h2>  <ul class="related-posts">          <li class="h4">  <a href="/blog/blog/programming/2020-05-27-ok-zoomer/" class="flip-title"><span>Ok, Zoomer</span></a>  <time class="faded fine" datetime="2020-05-27T05:56:28-07:00">27 May 2020</time></li>          <li class="h4">  <a href="/blog/blog/programming/2021-08-05-online-grade-distributions/" class="flip-title"><span>How Grade Distributions Changed During Online Learning</span></a>  <time class="faded fine" datetime="2021-08-05T00:00:00-07:00">05 Aug 2021</time></li>          <li class="h4">  <a href="/blog/blog/programming/2021-08-01-pubg/" class="flip-title"><span>PUBG Data Analysis</span></a>  <time class="faded fine" datetime="2021-08-01T00:00:00-07:00">01 Aug 2021</time></li>      </ul></aside>

  

  
    

  


  
<footer class="content" role="contentinfo">
  <hr/>
  
    <p><small class="copyright">Michael Ting © 2021. All rights reserved
</small></p>
  
  
    <nav class="legal"><small>
    
      
      <a class="heading flip-title" href="/LICENSE/">LICENSE</a>
      |
    
      
      <a class="heading flip-title" href="/NOTICE/">NOTICE</a>
      |
    
      
      <a class="heading flip-title" href="/CHANGELOG/">CHANGELOG</a>
      
    
    </small></nav>
  
  
    <p><small>Powered by <a class="external" href="https://hydejack.com/">Hydejack</a> v<span id="_version">9.0.3</span></small></p>
  
  <hr class="sr-only"/>
</footer>


</main>

  <hy-drawer
  id="_drawer"
  class=""
  side="left"
  threshold="10"
  noscroll
  
>
  <header id="_sidebar" class="sidebar" role="banner">
    






<div class="sidebar-bg " style="background:linear-gradient(202deg, rgb(6 8 29) 13%, rgb(181 181 181) 87%)">

 </div>

    <div class="sidebar-sticky">
  <div class="sidebar-about">
    
      <a class="no-hover" href="/" tabindex="-1">
        <img src="/assets/icons/icon.jpg" class="avatar" alt="Michael Ting" width="120" height="120" loading="lazy" />
      </a>
    
    <a class="sidebar-title" href="/"><h2 class="h1">Michael Ting</h2>
        
      
      <h3 class="faded"> SpeedChat Enjoyer </h3>
    
    </a>
    

    
      <p class="">
        Undergraduate Student in Applied Mathematics at UCLA

      </p>
    
  </div>

  <nav class="sidebar-nav heading" role="navigation">
    <span class="sr-only">Navigation:</span>
<ul>
  
    
      
      <li>
        <a
          id="_drawer--opened"
          href="/about"
          class="sidebar-nav-item"
          
        >
          About
        </a>
      </li>
    
      
      <li>
        <a
          
          href="/blog"
          class="sidebar-nav-item"
          
        >
          Blog
        </a>
      </li>
    
      
      <li>
        <a
          
          href="/resume/"
          class="sidebar-nav-item"
          
        >
          Résumé\CV
        </a>
      </li>
    
      
      <li>
        <a
          
          href="/projects/"
          class="sidebar-nav-item"
          
        >
          Projects
        </a>
      </li>
    
  
</ul>

  </nav>

  
  <div class="sidebar-social">
    <span class="sr-only">Social:</span>
<ul>
  
    
      



  

  
  
  
  

  

  

  <li>
    <a href="https://github.com/mting314" title="GitHub" class="no-mark-external">
      <span class="icon-github"></span>
      <span class="sr-only">GitHub</span>
    </a>
  </li>


    
      



  

  
  
  
  

  

  

  <li>
    <a href="mailto:giaga7@gmail.com" title="Email" class="no-mark-external">
      <span class="icon-mail"></span>
      <span class="sr-only">Email</span>
    </a>
  </li>


    
      



  

  
  
  
  

  

  

  <li>
    <a href="https://play.spotify.com/user/12162364462" title="Spotify" class="no-mark-external">
      <span class="icon-spotify"></span>
      <span class="sr-only">Spotify</span>
    </a>
  </li>


    
      



  

  
  
  
  

  

  

  <li>
    <a href="https://www.linkedin.com/in/michael-ting314" title="LinkedIn" class="no-mark-external">
      <span class="icon-linkedin2"></span>
      <span class="sr-only">LinkedIn</span>
    </a>
  </li>


    
  
</ul>

  </div>
</div>
  </header>
</hy-drawer>
<hr class="sr-only" hidden />

</hy-push-state>


  <!--[if gt IE 10]><!---->
  <script nomodule>!function(){var e=document.createElement("script");if(!("noModule"in e)&&"onbeforeload"in e){var t=!1;document.addEventListener("beforeload",function(n){if(n.target===e)t=!0;else if(!n.target.hasAttribute("nomodule")||!t)return;n.preventDefault()},!0),e.type="module",e.src=".",document.head.appendChild(e),e.remove()}}();
</script>
  <script src="/assets/js/hydejack-9.0.3.js" type="module"></script>
  <script src="/assets/js/LEGACY-hydejack-9.0.3.js" nomodule defer></script>
  <!-- I gotta add this here or the javascript will NOT load when dynamic page reloading is disabled
typewriter.js and the code below are not that big so it should not be much of an issue in page loading speed. Especially with jekyll -->

<script src="/assets/mting314/js/jquery-3.5.1.min.js"></script>
<script src="/assets/mting314/js/typewriter.js"></script>
<script src="/assets/mting314/js/particles.min.js"></script> 
<script>
function appendLeadingZeroes(n){
    if(n <= 9){
      return "0" + n;
    };
    return n;
  };
  function strip(html){
    var doc = new DOMParser().parseFromString(html, 'text/html');
    return doc.body.textContent || "";
  };

  function getRandomSubarray(arr, size) {
    var shuffled = arr.slice(0), i = arr.length, temp, index;
    while (i--) {
        index = Math.floor((i + 1) * Math.random());
        temp = shuffled[index];
        shuffled[index] = shuffled[i];
        shuffled[i] = temp;
    }
    return shuffled.slice(0, size);
}

var blogTyperStarted = false;
var startBlogTyper = function(typingWindow){
  blogTyperStarted = true;
  var typingWindow = document.getElementsByClassName('typing-window blog')[0];  

  if(!typingWindow){
    return;
  };
  var typingWindowWrapper = document.getElementsByClassName('typing-window-wrapper')[0];  
  var app = typingWindow.getElementsByClassName('typing-area')[0];
  var closeBtn =  typingWindow.getElementsByClassName('typing-toolbar-btn close')[0];
  typingWindowWrapper.addEventListener('transitionend', function(event) {
    if(event.target !== event.currentTarget)
      return;
      /* Javascript returns max-height as a string "opx" */
    if (event.propertyName === "max-height" && typingWindowWrapper.style.maxHeight === "0px"){
      typingWindowWrapper.remove();
    }else if(event.propertyName === "opacity" && typingWindowWrapper.style.opacity < 0.1){
      typingWindowWrapper.style.maxHeight = 0;
    };
 });

  setTimeout (function() {
    closeBtn.classList.toggle('disabled');
    closeBtn.onclick = function() {
          typewriter.stop();
          typingWindowWrapper.style.opacity = 0.01;
      };
  }, 10000);
  console.log("Starting blog typer!");



  var totalLoops = 20;
  // var wordList = ["<em>PhD Student</em> 📚", "Programmer 💻", "Photographer 📷", "Pizza Lover 🍕", "Gamer 👾", "Swimmer 🏊", "Traveller 🌏"];
  const jsonData = {
        "10": "Oh, well.",
        "20": "Why not?",
        "30": "Naturally!",
        "40": "That's the way to do it.",
        "50": "Right on!",
        "60": "What up?",
        "70": "But of course!",
        "80": "Bingo!",
        "90": "You've got to be kidding...",
        "100": "Sounds good to me.",
        "110": "That's kooky!",
        "120": "Awesome!",
        "130": "For crying out loud!",
        "140": "Don't worry.",
        "150": "Grrrr!",
        "160": "What's new?",
        "170": "Hey, hey, hey!",
        "180": "See you tomorrow.",
        "190": "See you next time.",
        "200": "See ya later, alligator.",
        "210": "After a while, crocodile.",
        "220": "I need to go soon.",
        "230": "I don't know about this!",
        "240": "You're outta here!",
        "250": "Ouch, that really smarts!",
        "260": "Gotcha!",
        "270": "Please!",
        "280": "Thanks a million!",
        "290": "You are stylin'!",
        "300": "Excuse me!",
        "310": "Can I help you?",
        "320": "That's what I'm talking about!",
        "330": "If you can't take the heat, stay out of the kitchen.",
        "340": "Well shiver me timbers!",
        "350": "Well isn't that special!",
        "360": "Quit horsing around!",
        "370": "Cat got your tongue?",
        "380": "You're in the dog house now!",
        "390": "Look what the cat dragged in.",
        "400": "I need to go see a Toon.",
        "410": "Don't have a cow!",
        "420": "Don't chicken out!",
        "430": "You're a sitting duck.",
        "440": "Whatever!",
        "450": "Totally!",
        "460": "Sweet!",
        "470": "That rules!",
        "480": "Yeah, baby!",
        "490": "Catch me if you can!",
        "500": "You need to heal first.",
        "510": "You need more Laff Points.",
        "520": "I'll be back in a minute.",
        "530": "I'm hungry.",
        "540": "Yeah, right!",
        "550": "I'm sleepy.",
        "560": "I'm ready!",
        "570": "I'm bored.",
        "580": "I love it!",
        "590": "That was exciting!",
        "600": "Jump!",
        "610": "Got gags?",
        "620": "What's wrong?",
        "630": "Easy does it.",
        "640": "Slow and steady wins the race.",
        "650": "Touchdown!",
        "660": "Ready?",
        "670": "Set!",
        "680": "Go!",
        "690": "Let's go this way!",
        "700": "You won!",
        "710": "I vote yes.",
        "720": "I vote no.",
        "730": "Count me in.",
        "740": "Count me out.",
        "750": "Stay here, I'll be back.",
        "760": "That was quick!",
        "770": "Did you see that?",
        "780": "What's that smell?",
        "790": "That stinks!",
        "800": "I don't care.",
        "810": "Just what the doctor ordered.",
        "820": "Let's get this party started!",
        "830": "This way everybody!",
        "840": "What in the world?",
        "850": "The check's in the mail.",
        "860": "I heard that!",
        "870": "Are you talking to me?",
        "880": "Thank you, I'll be here all week.",
        "890": "Hmm.",
        "900": "I'll get this one.",
        "910": "I got it!",
        "920": "It's mine!",
        "930": "Please, take it.",
        "940": "Stand back, this could be dangerous.",
        "950": "No worries!",
        "960": "Oh, my!",
        "970": "Whew!",
        "980": "Owoooo!",
        "990": "All Aboard!",
        "1000": "Hot Diggity Dog!",
        "1010": "Curiosity killed the cat.",
        "2000": "Act your age!",
        "2010": "Am I glad to see you!",
        "2020": "Be my guest.",
        "2030": "Been keeping out of trouble?",
        "2040": "Better late than never!",
        "2050": "Bravo!",
        "2060": "But seriously, folks...",
        "2070": "Care to join us?",
        "2080": "Catch you later!",
        "2090": "Changed your mind?",
        "2100": "Come and get it!",
        "2110": "Dear me!",
        "2120": "Delighted to make your acquaintance.",
        "2130": "Don't do anything I wouldn't do!",
        "2140": "Don't even think about it!",
        "2150": "Don't give up the ship!",
        "2160": "Don't hold your breath.",
        "2170": "Don't ask.",
        "2180": "Easy for you to say.",
        "2190": "Enough is enough!",
        "2200": "Excellent!",
        "2210": "Fancy meeting you here!",
        "2220": "Give me a break.",
        "2230": "Glad to hear it.",
        "2240": "Go ahead, make my day!",
        "2250": "Go for it!",
        "2260": "Good job!",
        "2270": "Good to see you!",
        "2280": "Got to get moving.",
        "2290": "Got to hit the road.",
        "2300": "Hang in there.",
        "2310": "Hang on a second.",
        "2320": "Have a ball!",
        "2330": "Have fun!",
        "2340": "Haven't got all day!",
        "2350": "Hold your horses!",
        "2360": "Horsefeathers!",
        "2370": "I don't believe this!",
        "2380": "I doubt it.",
        "2390": "I owe you one.",
        "2400": "I read you loud and clear.",
        "2410": "I think so.",
        "2420": "I think you should pass.",
        "2430": "I wish I'd said that.",
        "2440": "I wouldn't if I were you.",
        "2450": "I'd be happy to!",
        "2460": "I'm helping my friend.",
        "2470": "I'm here all week.",
        "2480": "Imagine that!",
        "2490": "In the nick of time...",
        "2500": "It's not over 'til it's over.",
        "2510": "Just thinking out loud.",
        "2520": "Keep in touch.",
        "2530": "Lovely weather for ducks!",
        "2540": "Make it snappy!",
        "2550": "Make yourself at home.",
        "2560": "Maybe some other time.",
        "2570": "Mind if I join you?",
        "2580": "Nice place you have here.",
        "2590": "Nice talking to you.",
        "2600": "No doubt about it.",
        "2610": "No kidding!",
        "2620": "Not by a long shot.",
        "2630": "Of all the nerve!",
        "2640": "Okay by me.",
        "2650": "Righto.",
        "2660": "Say cheese!",
        "2670": "Say what?",
        "2680": "Tah-dah!",
        "2690": "Take it easy.",
        "2700": "Ta-ta for now!",
        "2710": "Thanks, but no thanks.",
        "2720": "That takes the cake!",
        "2730": "That's funny.",
        "2740": "That's the ticket!",
        "2750": "There's a Cog invasion!",
        "2760": "Toodles.",
        "2770": "Watch out!",
        "2780": "Well done!",
        "2790": "What's cooking?",
        "2800": "What's happening?",
        "2810": "Works for me.",
        "2820": "Yes sirree.",
        "2830": "You betcha.",
        "2840": "You do the math.",
        "2850": "You leaving so soon?",
        "2860": "You make me laugh!",
        "2870": "You take right.",
        "2880": "You're going down!",
        "3000": "Anything you say.",
        "3010": "Care if I join you?",
        "3020": "Check, please.",
        "3030": "Don't be too sure.",
        "3040": "Don't mind if I do.",
        "3050": "Don't sweat it!",
        "3060": "Don't you know it!",
        "3070": "Don't mind me.",
        "3080": "Eureka!",
        "3090": "Fancy that!",
        "3100": "Forget about it!",
        "3110": "Going my way?",
        "3120": "Good for you!",
        "3130": "Good grief.",
        "3140": "Have a good one!",
        "3150": "Heads up!",
        "3160": "Here we go again.",
        "3170": "How about that!",
        "3180": "How do you like that?",
        "3190": "I believe so.",
        "3200": "I think not.",
        "3210": "I'll get back to you.",
        "3220": "I'm all ears.",
        "3230": "I'm busy.",
        "3240": "I'm not kidding!",
        "3250": "I'm speechless.",
        "3260": "Keep smiling.",
        "3270": "Let me know!",
        "3280": "Let the pie fly!",
        "3290": "Likewise, I'm sure.",
        "3300": "Look alive!",
        "3310": "My, how time flies.",
        "3320": "No comment.",
        "3330": "Now you're talking!",
        "3340": "Okay by me.",
        "3350": "Pleased to meet you.",
        "3360": "Righto.",
        "3370": "Sure thing.",
        "3380": "Thanks a million.",
        "3390": "That's more like it.",
        "3400": "That's the stuff!",
        "3410": "Time for me to hit the hay.",
        "3420": "Trust me!",
        "3430": "Until next time.",
        "3440": "Wait up!",
        "3450": "Way to go!",
        "3460": "What brings you here?",
        "3470": "What happened?",
        "3480": "What now?",
        "3490": "You first.",
        "3500": "You take left.",
        "3510": "You wish!",
        "3520": "You're toast!",
        "3530": "You're too much!",
        "4000": "Toons rule!",
        "4010": "Cogs drool!",
        "4020": "Toons of the world unite!",
        "4030": "Howdy, partner!",
        "4040": "Much obliged.",
        "4050": "Get along, little doggie.",
        "4060": "I'm going to hit the hay.",
        "4070": "I'm chomping at the bit!",
        "4080": "This town isn't big enough for the two of us!",
        "4090": "Saddle up!",
        "4100": "Draw!!!",
        "4110": "There's gold in them there hills!",
        "4120": "Happy trails!",
        "4130": "This is where I ride off into the sunset...",
        "4140": "Let's skedaddle!",
        "4150": "You got a bee in your bonnet?",
        "4160": "Lands sake!",
        "4170": "Right as rain.",
        "4180": "I reckon so.",
        "4190": "Let's ride!",
        "4200": "Well, go figure!",
        "4210": "I'm back in the saddle again!",
        "4220": "Round up the usual suspects.",
        "4230": "Giddyup!",
        "4240": "Reach for the sky.",
        "4250": "I'm fixing to.",
        "4260": "Hold your horses!",
        "4270": "I can't hit the broad side of a barn.",
        "4280": "Y'all come back now.",
        "4290": "It's a real barn burner!",
        "4300": "Don't be a yellow belly.",
        "4310": "Feeling lucky?",
        "4320": "What in Sam Hill's goin' on here?",
        "4330": "Shake your tail feathers!",
        "4340": "Well, don't that take all.",
        "4350": "That's a sight for sore eyes!",
        "4360": "Pickins is mighty slim around here.",
        "4370": "Take a load off.",
        "4380": "Aren't you a sight!",
        "4390": "That'll learn ya!",
        "6000": "I want candy!",
        "6010": "I've got a sweet tooth.",
        "6020": "That's half-baked.",
        "6030": "Just like taking candy from a baby!",
        "6040": "They're cheaper by the dozen.",
        "6050": "Let them eat cake!",
        "6060": "That's the icing on the cake.",
        "6070": "You can't have your cake and eat it too.",
        "6080": "I feel like a kid in a candy store.",
        "6090": "Six of one, half a dozen of the other...",
        "6100": "Let's keep it short and sweet.",
        "6110": "Keep your eye on the doughnut not the hole.",
        "6120": "That's pie in the sky.",
        "6130": "But it's wafer thin.",
        "6140": "Let's gum up the works!",
        "6150": "You're one tough cookie!",
        "6160": "That's the way the cookie crumbles.",
        "6170": "Like water for chocolate.",
        "6180": "Are you trying to sweet talk me?",
        "6190": "A spoonful of sugar helps the medicine go down.",
        "6200": "You are what you eat!",
        "6210": "Easy as pie!",
        "6220": "Don't be a sucker!",
        "6230": "Sugar and spice and everything nice.",
        "6240": "It's like butter!",
        "6250": "The candyman can!",
        "6260": "We all scream for ice cream!",
        "6270": "Let's not sugar coat it.",
        "6280": "Knock knock...",
        "6290": "Who's there?",
        "7000": "Quit monkeying around!",
        "7010": "That really throws a monkey-wrench in things.",
        "7020": "Monkey see, monkey do.",
        "7030": "They made a monkey out of you.",
        "7040": "That sounds like monkey business.",
        "7050": "I'm just monkeying with you.",
        "7060": "Who's gonna be monkey in the middle?",
        "7070": "That's a monkey off my back...",
        "7080": "This is more fun than a barrel of monkeys!",
        "7090": "Well I'll be a monkey's uncle.",
        "7100": "I've got monkeys on the brain.",
        "7110": "What's with the monkey suit?",
        "7120": "Hear no evil.",
        "7130": "See no evil.",
        "7140": "Speak no evil.",
        "7150": "Let's make like a banana and split.",
        "7160": "It's a jungle out there.",
        "7170": "You're the top banana.",
        "7180": "Cool bananas!",
        "7190": "I'm going bananas!",
        "7200": "Let's get into the swing of things!",
        "7210": "This place is swinging!",
        "7220": "I'm dying on the vine.",
        "7230": "Let's make like a tree and leave.",
        "7240": "Jellybeans don't grow on trees!",
        "10000": "This place is a ghost town.",
        "10001": "Nice costume!",
        "10002": "I think this place is haunted.",
        "10003": "Trick or Treat!",
        "10004": "Boo!",
        "10005": "Happy Haunting!",
        "10006": "Happy Halloween!",
        "10007": "It's time for me to turn into a pumpkin.",
        "10008": "Spooktastic!",
        "10009": "Spooky!",
        "10010": "That's creepy!",
        "10011": "I hate spiders!",
        "10012": "Did you hear that?",
        "10013": "You don't have a ghost of a chance!",
        "10014": "You scared me!",
        "10015": "That's spooky!",
        "10016": "That's freaky!",
        "10017": "That was strange....",
        "10018": "Skeletons in your closet?",
        "10019": "Did I scare you?",
        "11000": "Bah! Humbug!",
        "11001": "Better not pout!",
        "11002": "Brrr!",
        "11003": "Chill out!",
        "11004": "Come and get it!",
        "11005": "Don't be a turkey.",
        "11006": "Gobble gobble!",
        "11007": "Happy holidays!",
        "11008": "Happy New Year!",
        "11009": "Happy Thanksgiving!",
        "11010": "Happy Turkey Day!",
        "11011": "Ho! Ho! Ho!",
        "11012": "It's \"snow\" problem.",
        "11013": "It's \"snow\" wonder.",
        "11014": "Let it snow!",
        "11015": "Rake 'em in.",
        "11016": "Season's greetings!",
        "11017": "Snow doubt about it!",
        "11018": "Snow far, snow good!",
        "11019": "Yule be sorry!",
        "11020": "Have a Wonderful Winter!",
        "11021": "The Holiday Party decorations are Toontastic!",
        "11022": "Toon Troopers are hosting Holiday Parties!",
        "12000": "Be mine!",
        "12001": "Be my sweetie!",
        "12002": "Happy ValenToon's Day!",
        "12003": "Aww, how cute.",
        "12004": "I'm sweet on you.",
        "12005": "It's puppy love.",
        "12006": "Love ya!",
        "12007": "Will you be my ValenToon?",
        "12008": "You are a sweetheart.",
        "12009": "You are as sweet as pie.",
        "12010": "You are cute.",
        "12011": "You need a hug.",
        "12012": "Lovely!",
        "12013": "That's darling!",
        "12014": "Roses are red...",
        "12015": "Violets are blue...",
        "12016": "That's sweet!",
        "12050": "I LOVE busting Cogs!",
        "12051": "You're dynamite!",
        "12052": "I only have hypno-eyes for you!",
        "12053": "You're sweeter than a jellybean!",
        "12054": "I'd LOVE for you to come to my ValenToon's party!",
        "13000": "Top o' the mornin' to you!",
        "13001": "Happy St. Patrick's Day!",
        "13002": "You're not wearing green!",
        "13003": "It's the luck of the Irish.",
        "13004": "I'm green with envy.",
        "13005": "You lucky dog!",
        "13006": "You're my four leaf clover!",
        "13007": "You're my lucky charm!",
        "14000": "Let's have a summer Estate party!",
        "14001": "It's party time!",
        "14002": "Last one in the pond is a rotten Cog!",
        "14003": "Group Doodle training time!",
        "14004": "Doodle training time!",
        "14005": "Your Doodle is cool!",
        "14006": "What tricks can your Doodle do?",
        "14007": "Time for Cannon Pinball!",
        "14008": "Cannon Pinball rocks!",
        "14009": "Your Estate rocks!",
        "14010": "Your Garden is cool!",
        "14011": "Your Estate is cool!",
        "14012": "I don't have anyone to call for help",
        "14013": "I like your style.",
        "14014": "Send in a bug report"
      }
  var wordList = getRandomSubarray(Object.values(jsonData), 10);
  var pause = [1000, 4500];
  var terminalStarter = "> <span style='color: #5cd400;'> mting314@blog:</span><span style='color: #1c39c7;'>~</span>$ ";
  var current_datetime = new Date();
  var formatted_date = current_datetime.getFullYear() + "-" + appendLeadingZeroes(current_datetime.getMonth() + 1) + "-" + appendLeadingZeroes(current_datetime.getDate()) + " " + appendLeadingZeroes(current_datetime.getHours()) + ":" + appendLeadingZeroes(current_datetime.getMinutes()) + ":" + appendLeadingZeroes(current_datetime.getSeconds());

  var randomDelay = function(){
   return Math.random() * (pause[1] - pause[0] + pause[0]);
  };
  var typewriter = new Typewriter(app, {
    loop: false,
    delay: 'natural',
    cursor: '▌'
  });

  typewriter
  .pasteString(terminalStarter +"["+formatted_date+"]")
  .pauseFor(1000);

  if(current_datetime.getHours() > 22 ||current_datetime.getHours() < 5){
    typewriter
    .changeDelay(50)
    .pasteString("<br /> " +terminalStarter)
    .typeString("What are you doing up late? :)")
    .pauseFor(randomDelay());
  };

  if((current_datetime.getMonth() + 1) == 6 && current_datetime.getDate() == 9){
    typewriter
    .changeDelay(50)
    .pasteString("<br /> " +terminalStarter)
    .typeString("It's my birthday today! 🎂🎉")
    .pauseFor(randomDelay());    
  };

  console.log("aolsikfhjalskfhj");
  typewriter
  .changeDelay(90)
  .pasteString("<br /> " +terminalStarter)
  .pauseFor(1200)
  .typeString("Hey!")
  .pauseFor(800)
  .typeString(" I'm <strong>Michael</strong>")
  .pauseFor(1000)
  .pasteString("<br /> " + terminalStarter)
  .typeString(" I can only use SpeedChat.")
  .pauseFor(1000)
  .pasteString("<br /> " + terminalStarter)
  .typeString(" SpeedChat: ")
  ;

  let toType;
  for(var k = 0; k < totalLoops; k++){ 
    for(var i=0; i < wordList.length; i++){
      toType = wordList[parseInt(Math.random() * wordList.length)]
      typewriter
      .typeString(toType)
      .pauseFor(randomDelay())
      .deleteChars(strip(toType).length);
    };
  };
  typewriter.start();
};

var startTypers = function(){
  /*if(!blogTyperStarted){  startBlogTyper() }; */
  startBlogTyper();
  
};

var linesAdded = false;
var codeLinesSpan = "<span class='code-lines' style='display: none;'> </span>";
var codeLinesBtn = "<span class='code-lines-btn icon-list-numbered'></span>";
var codeLanguageTag = "<span class='code-language-tag'></span>";
var codeOutputTag = "<span class='code-output-tag icon-enlarge2'></span>";
var codeOutputMinHeight = "3rem";
var codeExtrasSpan = "<span class='code-extras'></span>";
var charLength = 0.8+0.1;
var addCodeLines = function(){
  console.log(linesAdded);
  if(linesAdded){
    return;
  }
  linesAdded = true;
  $(".highlight").each(function(index){
    if($(this).find(".code-lines").length > 0){
      return;
    };
    if($(this).parents(".highlight").length > 0){ /*We only want the most external one */
      return;
    };
    var code = $(this).find("code");
    var languageClass = code.attr('class');
    if(!languageClass){
      languageClass = $($(this).parents(".highlighter-rouge")[0]).attr('class');
    };
    var language = languageClass.split("-")[1].split(" ")[0].trim();
    var codeExtras = $(codeExtrasSpan);
      var languageTag = $(codeLanguageTag);
    if(language === 'plaintext'){
      languageTag.text("output");
      codeExtras.prepend(languageTag);
      $(this).addClass("code-output");
      var outputTag = $(codeOutputTag);
      code.parent().css("max-height", codeOutputMinHeight);
      outputTag.click(function(){
          var par = $(this).parent().parent();
          par.toggleClass("expanded");
        if( $(this).hasClass("enabled")){
          par.find("code").parent().css('max-height', codeOutputMinHeight);
        }
        else{   
          par.find("code").parent().css('max-height', '');
        };
        $(this).toggleClass("enabled");
      });
      codeExtras.prepend(outputTag);    
    }
    else{
      languageTag.text(language);
      codeExtras.prepend(languageTag);
      var noLines = code.text().trim().split(/\r\n|\r|\n/).length;
      if(noLines > 5){
        var linesSpan = $(codeLinesSpan);
        linesSpan.attr("code-lines", noLines);
        var linesBtnSpan = $(codeLinesBtn);
        linesBtnSpan.click(function(){
          if( $(this).hasClass("enabled")){
            var par = $(this).parent().parent();
            var codeLines = par.find(".code-lines");
            par.find("code").parent().css("padding-left", "");
            codeLines.css('opacity', '0');
            codeLines.css('display', 'none');
          }
          else{   
            var par = $(this).parent().parent();
            var codeLines = par.find(".code-lines");
            var padding = Math.max(2,codeLines.attr("code-lines").length)+"rem";
            par.find("code").parent().css("padding-left", padding);
            codeLines.css('display', '');
            codeLines.css('opacity', '1');
          };
          $(this).toggleClass("enabled");
        });
        linesSpan.text([...Array(noLines).keys()].join("\n"));
        $(this).prepend(linesSpan);
        codeExtras.prepend(linesBtnSpan);
      };
    };
    $(this).prepend(codeExtras);
    $(this).addClass("code-extended");
  });
};


document.getElementById('_pushState').addEventListener('hy-push-state-load', function() {
    startTypers();
    addCodeLines();
});


document.getElementById('_pushState').addEventListener('hy-push-state-start', function() {
  linesAdded = false;
});
document.addEventListener('DOMContentLoaded', function(){ 
    startTypers();
}, false);
</script>
  
  <script>!function(w, d) {
    w.ga=w.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;

    /**/
      ga('create', 'UA-145580315-1', 'auto');
    /**/

    var pushStateEl = d.getElementById('_pushState');
    var timeoutId;
    pushStateEl.addEventListener('hy-push-state-load', function() {
      w.clearTimeout(timeoutId);
      timeoutId = w.setTimeout(function() {
        ga('set', 'page', w.location.pathname);
        ga('send', 'pageview');
      }, 500);
    });

    d.addEventListener('hy--cookies-ok', function () {
      w.ga(function(tracker) {
        w.ga("set", "anonymizeIp", undefined);
        localStorage && localStorage.setItem("ga--client-id", tracker.get("clientId"));
      });
    });

    w.loadJSDeferred('https://www.google-analytics.com/analytics.js');
  }(window, document);</script>


  <script type="module">
    if ('serviceWorker' in navigator) {
      /**/
      navigator.serviceWorker.register('/sw.js')
        .then(r => r.update())
        .catch(() => {});
      /**/
    }
  </script>
<!--<![endif]-->
  <!-- <script>
  document.querySelector('hy-push-state').setAttribute('prefetch', '');

  document.querySelectorAll('.sidebar a[href^="/"]').forEach(function (el) { 
    el.addEventListener('click', function (e) {
      if (el.pathname === window.location.pathname) {
        e.preventDefault();
        e.stopPropagation();
        document.querySelector('hy-drawer').close();
      }
    });
  });
</script> -->

<!--
Code for integrating CloudFlare's email protection with Hydejack's single page app loading.
-->
<script>
  document.getElementById('_pushState').addEventListener('hy-push-state-after', function (e) {
    function e(e){
      (console.error?console.error:console.log).call(console,e)
    }

    function t(e){
      return l.innerHTML='<a href="'+e.replace(/"/g,"&quot;")+'"></a>',l.childNodes[0].getAttribute("href")
    }

    function r(e,t){
      var r=e.substr(t,2);return parseInt(r,16)
    }

    function n(e,n){
      for(var o="",c=r(e,n),a=n+2;a<e.length;a+=2){
        var l=r(e,a)^c;
        o+=String.fromCharCode(l)
      }
      return t(o)
    }

    var o="/cdn-cgi/l/email-protection#",
        c=".__cf_email__",
        a="data-cfemail",
        l=document.createElement("div");

    !function(){
      for(var t=document.getElementsByTagName("a"),r=0;r<t.length;r++)
        try{
          var c=t[r],a=c.href.indexOf(o);
          a>-1&&(c.href="mailto:"+n(c.href,a+o.length))
        }catch(t){
          e(t)
        }
    }(),
    function(){
      for(var t=document.querySelectorAll(c),r=0;r<t.length;r++)
        try{
          var o=t[r],l=n(o.getAttribute(a),0),i=document.createTextNode(l);
          o.parentNode.replaceChild(i,o)
        }catch(t){
          e(t)
        }
    }()
  });
</script>





<div hidden>
  
  <h2 class="sr-only">Templates (for web app):</h2>

  <template id="_animation-template">
  <div class="animation-main fixed-top">
    <div class="content">
      <div class="page"></div>
    </div>
  </div>
</template>

  <template id="_loading-template">
  <div class="loading nav-btn fr">
    <span class="sr-only">Loading…</span>
    <span class="icon-cog"></span>
  </div>
</template>

  <template id="_error-template">
  <div class="page">
    <h1 class="page-title">Error</h1>
    
    
    <p class="lead">
      Sorry, an error occurred while loading <a class="this-link" href=""></a>.

    </p>
  </div>
</template>

  <template id="_forward-template">
  <button id="_forward" class="forward nav-btn no-hover">
    <span class="sr-only">Forward</span>
    <span class="icon-arrow-right2"></span>
  </button>
</template>

  <template id="_back-template">
  <button id="_back" class="back nav-btn no-hover">
    <span class="sr-only">Back</span>
    <span class="icon-arrow-left2"></span>
  </button>
</template>

  <template id="_permalink-template">
  <a href="#" class="permalink">
    <span class="sr-only">Permalink</span>
    <span class="content-hash"></span>
  </a>
</template>

  
  
    <template id="_dark-mode-template">
  <button id="_dark-mode" class="nav-btn no-hover" >
    <span class="sr-only">Dark Mode</span>
    <span class="icon-brightness-contrast"></span>
  </button>
</template>

  
  
    <template id="_search-template">
  <button id="_search" class="nav-btn no-hover">
    <label class="sr-only" for="_search-input">Search</label>
    <span class="icon-search"></span>
  </button>
  <div id="_search-box">
    <div class="nav-btn">
      <span class="icon-search"></span>
    </div>
    <input 
      id="_search-input"
      type="search"
      class="form-control form-control-lg nav-btn"
      placeholder="SEARCH NOT ENABLED DURING DEVELOPMENT"
    />
    <button type="reset" class="nav-btn no-hover">
      <span class="sr-only">Close</span>
      <span class="icon-cross"></span>
    </button>
  </div>
  <div id="_hits"></div>
</template>

  
</div>

</body>
</html>
