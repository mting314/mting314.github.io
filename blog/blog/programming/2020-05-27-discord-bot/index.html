<!DOCTYPE html>
<html lang="en"><!--
 __  __                __                                     __
/\ \/\ \              /\ \             __                    /\ \
\ \ \_\ \   __  __    \_\ \      __   /\_\      __       ___ \ \ \/'\
 \ \  _  \ /\ \/\ \   /'_` \   /'__`\ \/\ \   /'__`\    /'___\\ \ , <
  \ \ \ \ \\ \ \_\ \ /\ \L\ \ /\  __/  \ \ \ /\ \L\.\_ /\ \__/ \ \ \\`\
   \ \_\ \_\\/`____ \\ \___,_\\ \____\ _\ \ \\ \__/.\_\\ \____\ \ \_\ \_\
    \/_/\/_/ `/___/> \\/__,_ / \/____//\ \_\ \\/__/\/_/ \/____/  \/_/\/_/
                /\___/                \ \____/
                \/__/                  \/___/

Powered by Hydejack v9.0.3 <https://hydejack.com/>
-->
















<head>
  






  
    
<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Coursicle but Better | Michael Ting</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Coursicle but Better" />
<meta name="author" content="Michael Ting" />
<meta property="og:locale" content="en" />
<meta name="description" content="Documenting my thought process and progress on making a Discord bot that notifies users when UCLA classes change between closed and open" />
<meta property="og:description" content="Documenting my thought process and progress on making a Discord bot that notifies users when UCLA classes change between closed and open" />
<link rel="canonical" href="http://gmarini.com/blog/blog/programming/2020-05-27-discord-bot/" />
<meta property="og:url" content="http://gmarini.com/blog/blog/programming/2020-05-27-discord-bot/" />
<meta property="og:site_name" content="Michael Ting" />
<meta property="og:image" content="http://gmarini.com/assets/img/blog/discord_files/featured.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-05-27T05:56:28-07:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="http://gmarini.com/assets/img/blog/discord_files/featured.png" />
<meta property="twitter:title" content="Coursicle but Better" />
<meta name="twitter:site" content="@qwtel" />
<meta name="twitter:creator" content="@Michael Ting" />
<meta name="google-site-verification" content="kRoh_csFULhK6lxBJwZOxiWYQpvttOkFj0a3lWwQADc" />
<script type="application/ld+json">
{"datePublished":"2020-05-27T05:56:28-07:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://gmarini.com/blog/blog/programming/2020-05-27-discord-bot/"},"@type":"BlogPosting","description":"Documenting my thought process and progress on making a Discord bot that notifies users when UCLA classes change between closed and open","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://gmarini.com/assets/icons/icon.jpg"},"name":"Michael Ting"},"url":"http://gmarini.com/blog/blog/programming/2020-05-27-discord-bot/","author":{"@type":"Person","name":"Michael Ting"},"image":{"caption":"This class filled up in like 1.5 hours and it was only thanks to the bot that I knew when this class opened for enrollment.","focal_point":"","preview_only":false,"url":"http://gmarini.com/assets/img/blog/discord_files/featured.png","@type":"imageObject"},"headline":"Coursicle but Better","dateModified":"2021-05-11T03:31:34-07:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  

  
    <meta name="keywords" content="PhD,coding,programming,android,IoT,Ubiquitous,computing,computer,science">
  

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta http-equiv="x-ua-compatible" content="ie=edge">

<meta name="mobile-web-app-capable" content="yes">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Michael Ting">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<meta name="application-name" content="Michael Ting">


  <meta name="theme-color" content="rgb(8,46,57)">


<meta name="generator" content="Hydejack v9.0.3" />


<link rel="alternate" href="http://gmarini.com/blog/blog/programming/2020-05-27-ok-zoomer/" hreflang="en">

<link type="application/atom+xml" rel="alternate" href="http://gmarini.com/feed.xml" title="Michael Ting" />


<link rel="shortcut icon"    href="/assets/icons/favicon.ico">
<link rel="apple-touch-icon" href="/assets/icons/icon-192x192.png">

<link rel="manifest" href="/assets/site.webmanifest">


  <link rel="dns-prefetch" href="https://fonts.googleapis.com">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">



  <link rel="dns-prefetch" href="https://www.google-analytics.com">


<link rel="preload" href="/assets/img/swipe.svg" as="image" id="_hrefSwipeSVG">

<link rel="dns-prefetch" href="/assets/js/search-worker-9.0.3.js" as="worker" id="_hrefSearch">

  
  <link rel="dns-prefetch" href="/assets/bower_components/katex/dist/katex.min.css" id="_katexPreload">




<link rel="dns-prefetch" href="https://mting314-com.disqus.com" id="_hrefDisqus">


<script>!function(e,t){"use strict";function n(e,t,n,o){e.addEventListener?e.addEventListener(t,n,o):e.attachEvent?e.attachEvent("on"+t,n):e["on"+t]=n}e.loadJS=function(e,o){var r=t.createElement("script");r.src=e,o&&n(r,"load",o,{once:!0});var a=t.scripts[0];return a.parentNode.insertBefore(r,a),r},e._loaded=!1,e.loadJSDeferred=function(o,r){function a(){e._loaded=!0,r&&n(c,"load",r,{once:!0});var o=t.scripts[0];o.parentNode.insertBefore(c,o)}var c=t.createElement("script");return c.src=o,e._loaded?a():n(e,"load",a,{once:!0}),c},e.setRel=e.setRelStylesheet=function(e){function o(){this.rel="stylesheet"}n(t.getElementById(e),"load",o,{once:!0})}}(window,document);
!function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this);
!function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this);
!function(w) {
  w._baseURL = '/';
  w._publicPath = '/assets/js/';
  w._noPushState = false;
  w._noDrawer = false;
  w._noNavbar = false;
  w._noToc = false;
  w._noSearch = false;
}(window);
</script>



<!--[if gt IE 8]><!---->

  




<link rel="stylesheet" href="/assets/css/hydejack-9.0.3.css" id="_stylePreload">
<link rel="stylesheet" href="/assets/icomoon/style.css" id="_iconsPreload">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab:700%7CNoto+Sans:400,400i,700,700i&display=swap" id="_fontsPreload">



  <style id="_pageStyle">

html{--accent-color: rgb(79,177,186);--accent-color-transparent:  rgba(79,177,186,0.5);--accent-color-transparent-darkened:  rgba(32,76,80,0.8);--accent-color-faded: rgba(79,177,186,0.5);--accent-color-darkened: #409ba3;--theme-color: rgb(8,46,57);--dark-mode-body-bg: #282f31;--dark-mode-border-color: #343d3f}

</style>


<!--<![endif]-->


<!--
Code used for embedding Gumroad on the Hydejack Site. 
Left here for reference, feel free to delete.
-->



<!-- It's better to but it here as it is loaded BEFORE my-scripts.html -->
<script src="/assets/mting314/js/jquery-3.5.1.min.js"></script>



<link rel="dns-prefetch" href="https://assets.gumroad.com">
<script type="module">
  const ppiData = window._ppiData = fetch('https://hydejack-ppi.qwtel.workers.dev', { mode: 'cors'}).then(res => res.json()).catch(() => ({}));
  const promisify = f => x => new Promise(r => f(x).addEventListener('load', r));
  const loadJS = promisify(window.loadJS);
  {
    let p;
    document.querySelector('hy-push-state').addEventListener('load', () => {
      const io = new IntersectionObserver(async (entries) => {
        if (entries.some(x => x.isIntersecting)) {
          p = p || loadJS('https://gumroad.com/js/gumroad-embed.js');
          const [{ code }] = await Promise.all([ppiData, p]);
          document.querySelectorAll('.gumroad-product-embed').forEach(el => { 
            if (!el.dataset.gumroadParams) {
              el.dataset.gumroadParams = 'offer_code=' + (code || 'qr0tw8m');
            }
          });
          if (!window.GumroadEmbed) {
            await new Promise(function check1(res) {
              if ('createGumroadEmbed' in window) res(window.createGumroadEmbed());
              else setTimeout(() => check1(res), 200);
            });
          }
          await new Promise(function check2(res) {
            if ('GumroadEmbed' in window) res(GumroadEmbed.reload());
            else setTimeout(() => check2(res), 200);
          });
        }
      }, { rootMargin: '1440px' });
      document.querySelectorAll('.gumroad-product-embed').forEach(el => io.observe(el));
    });
  }
  {
    let p;
    document.querySelector('hy-push-state').addEventListener('load', () => {
      const io = new IntersectionObserver(async (entries) => {
        if (entries.some(x => x.isIntersecting)) {
          p = p || loadJS('https://gumroad.com/js/gumroad.js');
          const [{ code }] = await Promise.all([ppiData, p]);
          if (code) {
            document.querySelectorAll('.gumroad-button').forEach(el => { 
              if (!el.href.endsWith(code)) {
                el.href = el.href + '/' + (code || 'qr0tw8m');
              }
            });
          }
          if (!window.GumroadOverlay) {
            await new Promise(function check(res) {
              if ('createGumroadOverlay' in window) res(window.createGumroadOverlay());
              else setTimeout(() => check(res), 200);
            });
          }
        }
      }, { rootMargin: '300px' });
      document.querySelectorAll('.gumroad-button').forEach(el => io.observe(el));
    });
  }
</script>

</head>

<body class="no-break-layout no-large-headings">
  
<script>
  window._sunrise = 9;
  window._sunset =  18;
  window.match_os =  false;
  !function (window, document) {
  var LM = 'light-mode';
  var DM = 'dark-mode';
  var h = new Date().getHours();
  document.body.classList.add(DM); /*Start in dark mode and eventually switch */
  console.log("match_os " + match_os + " time " +h);
  /* if match_os is false, the time has the preference on deciding  which mode */
  if (window.match_os  && 'matchMedia' in window && window.matchMedia('(prefers-color-scheme)')) return;
  var m = h <= window._sunrise || h >= window._sunset  ? DM : LM; 
  var n = m === DM ? LM : DM;
  document.body.classList.add(m);
  document.body.classList.remove(n);
}(window, document);

</script>



<hy-push-state
  id="_pushState"
  replace-selector="#_main"
  link-selector="a[href]:not([href^='/assets/']):not(.external):not(.no-push-state)"
  script-selector="script"
  duration="500"
  hashchange
>
  
  <div id="_navbar" class="navbar fixed-top">
  <div class="content">
    <span class="sr-only">Jump to:</span>
    <div class="nav-btn-bar">
      <a id="_menu" class="nav-btn no-hover" href="#_drawer--opened">
        <span class="sr-only">Navigation</span>
        <span class="icon-menu"></span>
      </a>
      <div class="nav-span"></div>
    </div>
  </div>
</div>
<hr class="sr-only" hidden />

  <main
  id="_main"
  class="content layout-post"
  role="main"
>
  





<article id="post-blog-blog-programming-discord-bot" class="page post mb6" role="article">
  <header>
    <h1 class="post-title flip-project-title">
      
        Coursicle but Better

      
    </h1>

    <div class="post-date">
      
        
        <time datetime="2020-05-27T05:56:28-07:00">27 May 2020</time>
      
      
      
      
      
      









in <a href="/blog/blog/" class="flip-title">Blog</a> / <a href="/blog/programming/" class="flip-title">Programming</a>

      









on <span>Ucla class data</span>

    </div>

    
    
      
        
        
          <div class="lead aspect-ratio sixteen-nine flip-project-img">
            





<img
  
    src="/assets/img/blog/discord_files/featured.png"
    
    
  
  alt="Coursicle but Better"
  
  
  width="864"
  height="486"
  loading="lazy"
/>

          
        </div>
      
      
    

    



  
    <p class="note-sm"   >
      Documenting my thought process and progress on making a Discord bot that notifies users when UCLA classes change between closed and open

    </p>
  


  </header>

  
    <ol id="markdown-toc">
  <li><a href="#the-platform-a-discord-bot" id="markdown-toc-the-platform-a-discord-bot">The Platform: A Discord Bot</a></li>
  <li><a href="#how-to-get-the-enrollment-data" id="markdown-toc-how-to-get-the-enrollment-data">How to Get the Enrollment Data</a>    <ol>
      <li><a href="#scraping-the-public-schedule-of-classes-wont-work" id="markdown-toc-scraping-the-public-schedule-of-classes-wont-work">Scraping the Public Schedule of Classes Won’t Work</a></li>
      <li><a href="#finding-the-information-source" id="markdown-toc-finding-the-information-source">Finding the Information Source</a></li>
      <li><a href="#tokens" id="markdown-toc-tokens">Tokens</a></li>
    </ol>
  </li>
  <li><a href="#speed-is-important" id="markdown-toc-speed-is-important">Speed is Important!</a></li>
  <li><a href="#parsing-classes" id="markdown-toc-parsing-classes">Parsing Classes</a></li>
  <li><a href="#interacting-with-the-bot" id="markdown-toc-interacting-with-the-bot">Interacting with the Bot</a>    <ol>
      <li><a href="#choices" id="markdown-toc-choices">Choices</a></li>
      <li><a href="#fast-and-slow-mode" id="markdown-toc-fast-and-slow-mode">Fast and Slow Mode</a></li>
      <li><a href="#the-watchlist" id="markdown-toc-the-watchlist">The Watchlist</a></li>
    </ol>
  </li>
  <li><a href="#check-for-change" id="markdown-toc-check-for-change">Check for Change</a></li>
  <li><a href="#final-fixes" id="markdown-toc-final-fixes">Final Fixes</a>    <ol>
      <li><a href="#one-big-oversight-herokus-ephemeral-filesystem" id="markdown-toc-one-big-oversight-herokus-ephemeral-filesystem">One Big Oversight: Heroku’s Ephemeral Filesystem</a></li>
      <li><a href="#aliasing" id="markdown-toc-aliasing">Aliasing</a></li>
    </ol>
  </li>
  <li><a href="#concluding-thoughts" id="markdown-toc-concluding-thoughts">Concluding Thoughts</a></li>
</ol>

<p>Pretty much immediately after I figured out that UCLA had a giant database of class data, I immediately had an idea for yet another tool: a notification system that could tell you whenever your class became open again after being full for a bit. At UCLA, where I’m willing to say that the amount of time students spend worrying about getting into the classes, many of which are mandatory for graduation, is far too high.</p>

<p>Luckily, many students are able to find at least a partial solution in an app called Coursicle. This allows you to find any class from any college, and if you ask it to, the app will notify you whenever that class changes from “open” to “closed”, “closed” to “open”, etc. For a university where there are generally anywhere from 2-10 other students waiting to gobble up any single seat that opens up in a class you really want/need, having this app notify you could give the edge.</p>

<p>Now, this app is great, and has probably saved a lot of peoples’ butts, but there is one giant limitation to Coursicle: you can only track up to one class at a time without paying!</p>

<p>Now that I had a lot of ideas on how to query UCLA’s big class databases, I had just as much information as Coursicle does, and I thought I might be able to make an app that does what they do for UCLA, but allow students to track as many classes as they wanted!</p>

<p>But of course, this would be a big undertaking for someone with my knowledge. Some of the questions I would need to answer over the course of the project:</p>

<p>How do I have a program running at, well, all times? I mean, I can have a Python script running on my computer, but what happens when I want to turn my computer off?
How can I have a constant way to, say, every 15 seconds, but UCLA’s class enrollment database, asking “hey, did the enrollment status change” over and over again?
How can I send notifications to users when such a change is detected?</p>

<h2 id="the-platform-a-discord-bot">The Platform: A Discord Bot</h2>

<p>First was the question of what this app’s platform should be. This was right on the heels of Ok, Zoomer, so my first natural thought was a Chrome extension, but there were definitely some disadvantages. First, I didn’t really feel like doing HTML/JS programming anymore, I wanted more practice on Python. I know that it’s good to know multiple languages, but I feel like I already learned a lot from Ok, Zoomer, and what I got from that project was about as deep as I would need on the web programming side of things. Second, and I suppose more obviously, the program wouldn’t be running unless Chrome was running. This doesn’t just mean I wouldn’t be able to notify users unless their Chrome was open, it also meant that whatever scraper I had would stop running as soon as they closed Chrome. It just boils down to a difference of purpose; Chrome extensions are sort of meant to change your browsing experience in real time through injecting Javascript, while my aim isn’t really to change the browsing experience, I just want some way to notify users.</p>

<p>But this is when I came across Discord bots.</p>

<p><img src="https://content.instructables.com/ORIG/FWF/EAB2/K1S38849/FWFEAB2K1S38849.jpg?auto=webp" alt="Discord bots" /></p>

<p>In case you aren’t a Zoomer like me and don’t know that Discord is, just know that it’s like Microsoft Teams/Skype, but more centered on community/gaming rather than for work. One really nice thing about Discord, and one way that people add a lot to the community aspect of the platform is the custom bot users that you can make to perform certain fun tasks for you. They range in usage from just-for-fun tasks like randomly selecting certain users for a raffle and playing music from Youtube you want to show to everyone in a voice channel, to certain really useful tasks like quizzing you on flash cards and automoderation. And even better, it’s pretty darn easy to pick up and use.<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote">1</a></sup>Basically, you can implement almost anything you normally would in programming to the really easy-to-use platform of Discord where anyone in a server can interact with the bot. (Making a Discord bot is something anyone that’s any sort of combination of “gamer” and “programmer” has dabbled in at least a tiny bit.)</p>

<p>Now of course, you probably can tell where this is going; while I had been using popular Discord bots that server admins have brought in for playing music and such, I never really thought about the fact that you could indeed program and customize them to do whatever you wanted. But then I came across some Youtube video where someone was showing how to program one of these bots, and looking at the code, I realized “wait a second, this is just normal Python with some extra files!”</p>

<p>And after thinking for a second, I realized how nice of a platform this would be for an application like this. You could just use normal text channels to interact with the bot, and then you it could Direct Message (DM) you whenever a class opened up. It might seem strange to use Discord as a notification system, but many people who use Discord have it on their phones as well, where it would notify them about a DM in much the same way Coursicle would notify them in the first place.</p>

<h2 id="how-to-get-the-enrollment-data">How to Get the Enrollment Data</h2>
<h3 id="scraping-the-public-schedule-of-classes-wont-work">Scraping the Public Schedule of Classes Won’t Work</h3>
<p>So as I moaned on and on about in the post about Ok, Zoomer, I was really annoyed that you aren’t allowed to query the UCLA database that the Class Planner references. This is the endpoint:</p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">https://be.my.ucla.edu/ClassPlanner/ClassSearch.asmx/getTierData
</span></code></pre></div></div>
<p>However, of course, I realized that people that aren’t logged in to UCLA could find access pretty much all the same information, I just had to find where that was coming from.</p>

<p>In particular, I realized that when looking up classes not logged in as a UCLA student, you’ll probably find yourself not on myUCLA, but here:</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">https://sa.ucla.edu/ro/Public/SOC
</span></code></pre></div></div>
<p>where, in actuality, much of the same information is displayed.</p>

<p><img src="/assets/img/blog/discord_files/soc.png" alt="SOC Website" /></p>

<p>Directly from https://sa.ucla.edu/ro/public/soc/, didn’t have to log in
(I assume they keep these endpoints separate because the Class Planner logged in one exposes information on whether you are enrolled in the class, which is unnecessary if you’re just on the public Schedule of Classes.)</p>

<p>Great, so if we can find all this information without having to log in, we can just find where that enrollment data is coming from, and you probably won’t have to log in to get it.</p>

<p>Now of course anyone’s first instinct would be to just get the data off of this page using Python’s requests library or something. However, there’s a bit of a problem.</p>

<p>When you get the HTML of the page purely with requests, you’ll see that lots of information is missing. That’s because when you first go to this url, it looks like this:</p>

<p><img src="/assets/img/blog/discord_files/soc_list.png" alt="List of classes as displayed on SOC" /></p>

<p>And looking at the HTML reveals that there’s actually no information under these class names, the information we see really is all that we have…</p>

<p>Until we click on one of the names. Then the class expands to show all the good info that we need about the class like instructors, enrollment numbers, etc.</p>

<p>But this won’t do with requests, there’s just too much Javascript running in the page to effectively scrape with just requests on this SOC endpoint.</p>

<h3 id="finding-the-information-source">Finding the Information Source</h3>
<p>I spent some time fiddling around with using Pyppeteer (which is a really cool tool) to click buttons to expand all the class names, but that didn’t seem like a good idea because it could potentially take a long time to wait for the website to fetch the data and then display it, just to also potentially find that the class we’re looking for is on another page, and we have to repeat the process. Maybe that would work better if we were scraping all the data on the website, but clearly, in this scenario where we’re searching for a particular class, this would be very inefficient.</p>

<p>No, it was clear that the SOC website just surfaces lots of data coming from some other source, and the best way to do this was somehow make a query to this source ourselves, and not have to go through the middleman of the SOC webpage.</p>

<p>However, the SOC webpage could still be useful by looking into how it does indeed get the data for all of those classes. After more time than I’m willing to admit sifting through the Chrome Developer Tools throwing random breakpoints into the code to see what exactly was going on, I eventually came across this:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//fire an ajax request to being new search</span>
            <span class="nx">SearchPanel</span><span class="p">.</span><span class="nx">ClearError</span><span class="p">();</span>
            <span class="nx">globalFunction</span><span class="p">.</span><span class="nx">hideElements</span><span class="p">([</span><span class="dl">"</span><span class="s2">divClassNames</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">divSearchResultsHeader</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">divPaginationWrapper</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">divExpandAll</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">divExpandandPagination</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">divPaginationBottom</span><span class="dl">"</span><span class="p">]);</span>
            <span class="kd">var</span> <span class="nx">flagToSend</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="p">{},</span> <span class="nx">Iwe_ClassSearch_Filter</span><span class="p">.</span><span class="nx">flags</span><span class="p">);</span>
            <span class="c1">//use old search_by and model; not what's in the search panel right now</span>
            <span class="nx">data</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
                <span class="na">search_by</span><span class="p">:</span> <span class="nx">SearchPanel</span><span class="p">.</span><span class="nx">SearchBy</span><span class="p">,</span>
                <span class="na">model</span><span class="p">:</span> <span class="nx">SearchPanel</span><span class="p">.</span><span class="nx">SearchData</span><span class="p">,</span>
                <span class="na">filterFlags</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">flagToSend</span><span class="p">),</span>
                <span class="na">isFilter</span><span class="p">:</span> <span class="nx">isFilter</span>
            <span class="p">});</span>
            <span class="nx">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#divSearchResults</span><span class="dl">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">classList</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="dl">"</span><span class="s2">hide</span><span class="dl">"</span><span class="p">);</span>
            <span class="nx">AjaxProvider</span><span class="p">.</span><span class="nx">SendRequestWithContext</span><span class="p">(</span><span class="nx">ApplicationSettings</span><span class="p">.</span><span class="nx">GetControllerName</span><span class="p">()</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">/Results/GetCourseTitlesPage</span><span class="dl">"</span><span class="p">,</span>
                <span class="nx">data</span><span class="p">,</span>
                <span class="nx">ResponseFunctions</span><span class="p">.</span><span class="nx">respFunc_GetSearchResults</span><span class="p">,</span>
                <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span> <span class="dl">"</span><span class="s2">error_msg</span><span class="dl">"</span><span class="p">:</span> <span class="nx">SearchPanel</span><span class="p">.</span><span class="nx">ErrorMessage</span><span class="p">,</span>
                    <span class="dl">"</span><span class="s2">header_text</span><span class="dl">"</span><span class="p">:</span> <span class="nx">SearchPanel</span><span class="p">.</span><span class="nx">HeaderText</span><span class="p">,</span>
                    <span class="dl">"</span><span class="s2">isFilter</span><span class="dl">"</span><span class="p">:</span> <span class="nx">isFilter</span><span class="p">,</span>
                    <span class="dl">"</span><span class="s2">term_selected</span><span class="dl">"</span><span class="p">:</span> <span class="nx">$</span><span class="p">.</span><span class="nx">parseJSON</span>
                <span class="p">(</span><span class="nx">SearchPanel</span><span class="p">.</span><span class="nx">SearchData</span><span class="p">).</span><span class="nx">term_cd</span>
                <span class="p">}),</span>
                <span class="nx">AjaxProvider</span><span class="p">.</span><span class="nx">GenerateBeforeAjaxImageForID</span><span class="p">(...),</span>
                <span class="nx">AjaxProvider</span><span class="p">.</span><span class="nx">GenerateAfterAjaxImageForID</span><span class="p">(...),</span>
                <span class="nx">data</span><span class="p">.</span><span class="nx">title</span>
            <span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>
</code></pre></div></div>
<p>This code referenced a certain endpoint called</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">https://sa.ucla.edu/ro/public/soc/Results/CourseTitlesView
</span></code></pre></div></div>
<p>From the code, it looks like the idea is to pass in some information from our search, and have the endpoint give us all the classes titles that match this search. In fact, we can look at exactly the data that goes into this AJAX request:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>filterFlags: "{"enrollment_status":"O,W,C,X,T,S","advanced":"y","meet_days":"M,T,W,R,F","start_time":"8:00 am","end_time":"9:00 pm","meet_locations":null,"meet_units":null,"instructor":null,"class_career":null,"impacted":"N","enrollment_restrictions":null,"enforced_requisites":null,"individual_studies":null,"summer_session":null}"
isFilter: false
model: "{"term_cd":"21S","ses_grp_cd":"%","class_no":null,"crs_catlg_no":null,"subj_area_cd":"MATH   ","subj_area_name":"Mathematics (MATH)","class_prim_act_fl":"y"}"
search_by: "subject"
</code></pre></div></div>
<p>Cool, now that I have all the info sent along with the AJAX request, I can just query with Python requests again, right?</p>

<!-- ![Trying to get data from URL with Python](/assets/img/blog/discord_files/generate_url.png "My Title") -->

<figure style="width: 600px;">
<img alt="small network" src="/assets/img/blog/discord_files/generate_url.png" class="lead" />
<figcaption>Sorry if it's a bit small, but essentially, trying to do a `requests.get` on the URL we thought would work isn't working!
</figcaption>
</figure>

<p>(By the way, you can access this Jupyter noteboook on the Github repository to read it a bit more easily, and if you want to try things yourself.)</p>

<p>Hmm, that’s a bit annoying. What’s different about how I’m making the request, and how the SOC website is??</p>

<p>This is where my PIC40 knowledge comes in. I remembered that more than just URLs, other information that the browser caries is the headers that are sent along with requests. Sure enough, again with Chrome Dev Tools (Network tab) to the rescue:</p>

<p>After some testing, I found that the only header that seemed to matter was this final highlighted one. And when I add those to the Python request headers:</p>

<p>Awesome, we can reproduce the request, and get all the correct data! Now we can just interpret that input data, so we know what to substitute.</p>

<p>So it looks like those <code class="language-text highlighter-rouge">filterFlags</code> have to do with, well, what filters you set up in the advanced version of the search.</p>

<!-- ![Filter flags](/assets/img/blog/discord_files/filter_flags.png) -->
<figure style="width: 600px;">
<img alt="small network" src="/assets/img/blog/discord_files/filter_flags.png" class="lead" />
<figcaption>For example, enrollment_status seems to correspond to each of (O)pen, (W)aitlisted, (C)losed, Cancelled (X), (T)entative, and Not Available (S)
</figcaption>
</figure>

<p>While I could have settings within my own bot for those, I’d imagine most people wouldn’t care about trying to filter their search, especially if they know what class they’re looking for already. So I can just hard-code those filterFlags to be the same for every query. Furthermore, isFilter just seems to tell the search if any of those filters are in effect, so we can also just always keep that false.</p>

<p>Of course, you might be able to tell that the “model” is of particular interest to us. It seems to be a sort of, well, model against which the database can compare and decide if a certain class fits, it’d spit it back to us. Great, so all I have to do is change that “crs_catlg_no” part to, say, 31A (remember from the Ok, Zoomer post that catalog number means the 31A part of Math 31A).</p>

<p><img src="/assets/img/blog/discord_files/soup_result.png" alt="Soup Result" /></p>

<p>However, there’s an obvious problem here: where’s all the data? Well the “answer” is sort of hidden in the name of the endpoint we’re querying: CourseTitlesView. It looks like this is a sort of “first step” to just get titles of the classes, then when you click on one of the classes, it uses some additional information with another endpoint to get the rest of the data.</p>

<p>After putting in breakpoints for when you click on a certain class, I got to this point:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//fetch object from CourseData</span>
        <span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="nx">CourseData</span><span class="p">[</span><span class="nx">targetId</span><span class="p">];</span>
        <span class="kd">var</span> <span class="nx">isMultiListedTitles</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#isMultiListedTitles</span><span class="dl">"</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
 
        <span class="c1">//create payload for API call</span>
        <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
            <span class="na">model</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">model</span><span class="p">),</span>
            <span class="na">FilterFlags</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">Iwe_ClassSearch_Filter</span><span class="p">.</span><span class="nx">flags</span><span class="p">),</span>
            <span class="na">IsMultiListedTitles</span><span class="p">:</span> <span class="nx">isMultiListedTitles</span>
        <span class="p">});</span>
 
        <span class="c1">//toggle our image if it exists</span>
        <span class="kd">var</span> <span class="nx">expando</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">targetId</span> <span class="o">+</span> <span class="nx">Iwe_ClassSearch_SearchResults</span><span class="p">.</span><span class="nx">PATH_ELEMENT_SEPERATOR</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">expando</span><span class="dl">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">expando</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">expando</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="dl">'</span><span class="s1">span</span><span class="dl">'</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="dl">'</span><span class="s1">class</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">icon-caret-down</span><span class="dl">'</span><span class="p">);</span>
        <span class="p">}</span>
 
        <span class="c1">//create the context for the callback</span>
        <span class="kd">var</span> <span class="nx">context</span> <span class="o">=</span> <span class="p">{</span> <span class="na">path</span><span class="p">:</span> <span class="nx">targetId</span><span class="p">,</span> <span class="na">isExpandAll</span><span class="p">:</span> <span class="nx">isExpandAll</span> <span class="p">}</span>
        <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">ApplicationSettings</span><span class="p">.</span><span class="nx">GetControllerName</span><span class="p">()</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">/Results/GetCourseSummary</span><span class="dl">"</span><span class="p">;</span>
     
        <span class="nx">AjaxProvider</span><span class="p">.</span><span class="nx">SendRequestWithContext</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">OnShowClassesClick</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span>
                                            <span class="nx">AjaxProvider</span><span class="p">.</span><span class="nx">GenerateBeforeAjaxImageForID</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">[</span><span class="nx">targetId</span><span class="p">],</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">false</span><span class="p">),</span>
                                            <span class="nx">AjaxProvider</span><span class="p">.</span><span class="nx">GenerateAfterAjaxImageForID</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">[</span><span class="nx">targetId</span><span class="p">],</span> <span class="kc">false</span><span class="p">));</span>
    <span class="p">};</span>
</code></pre></div></div>

<p>Aha, so we’re going to yet another endpoint!</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">https://sa.ucla.edu/ro/public/soc/Results/GetCourseSummary
</span></code></pre></div></div>
<p>Let’s look at the <code class="language-text highlighter-rouge">data</code> (on line 22) that’s sent with the request:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FilterFlags: "{"enrollment_status":"O,W,C,X,T,S","advanced":"y","meet_days":"M,T,W,R,F","start_time":"8:00 am","end_time":"9:00 pm","meet_locations":null,"meet_units":null,"instructor":null,"class_career":null,"impacted":"N","enrollment_restrictions":null,"enforced_requisites":null,"individual_studies":null,"summer_session":null}"
model: "{"Term":"21S","SubjectAreaCode":"MATH   ","CatalogNumber":"0003C   ","IsRoot":true,"SessionGroup":"%","ClassNumber":"%","SequenceNumber":null,"Path":"MATH0003C","MultiListedClassFlag":"n","Token":"MDAwM0MgICBNQVRIMDAwM0M="}"
</code></pre></div></div>

<p><img src="/assets/img/blog/discord_files/get_course_summary.png" alt="GetCourseSummary response from request" /></p>

<p>The filter flags are the same, but the model looks a bit different. Cool, why don’t we even bother with the <code class="language-text highlighter-rouge">CourseTitlesView</code>?</p>

<p>Well, here’s an immediate issue:</p>

<!-- ![Comparing the queries for two classes, Math 3C and 11N](/assets/img/blog/discord_files/compare_classes.png) -->

<figure style="width: 600px;">
<img alt="comparing classes" src="/assets/img/blog/discord_files/compare_classes.png" class="lead" />
<figcaption>When we make a request for the original class we were talking about, 3C, everything's fine. However, If I just change the class catalog number, 11N, things break.
</figcaption>
</figure>

<p>Wait, but why does the first query work, when we use catalog number 3C, but when we switch to 11N, we get error messages from the endpoint?</p>

<h3 id="tokens">Tokens</h3>
<p>The observant among you might have noticed that in the data sent to the <code class="language-text highlighter-rouge">GetCourseSummary</code>:</p>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>model: "{"Term":"21S",
    "SubjectAreaCode":"MATH   ",
    "CatalogNumber":"0003C   ",
    "IsRoot":true,
    "SessionGroup":"%",
    "ClassNumber":"%",
    "SequenceNumber":null,
    "Path":"MATH0003C",
    "MultiListedClassFlag":"n",
    "Token":"MDAwM0MgICBNQVRIMDAwM0M="
}"
</code></pre></div></div>
<p>There seems to be only one or 2 elements that depend on the catalog number, so if we switch those, it should still be a valid query. However, what’s that <em>token</em>? I sure hope that is just some random stuff that doesn’t matter for the overall query.</p>

<p><img src="/assets/img/blog/discord_files/no_token.png" alt="Query without providing token" /></p>

<p>Uh oh, removing it makes the query not work. Is it something actually necessary to distinguish between classe? Well, so what does the model for another class look like?</p>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>model: "{"Term":"21S","SubjectAreaCode":"MATH   ","CatalogNumber":"0031B   ","IsRoot":true,"SessionGroup":"%","ClassNumber":"%","SequenceNumber":null,"Path":"MATH0031B","MultiListedClassFlag":"n","Token":"MDAzMUIgICBNQVRIMDAzMUI="}"
</code></pre></div></div>
<p>Oh no no no. The token is different. Uggghhhhhh they’re specific to every single class, aren’t they……</p>

<p>Sure enough, look at this.</p>

<p><img src="/assets/img/blog/discord_files/different_tokens.png" alt="All classes have a different token" /></p>

<p>There are some common runs among all the token strings, but it’s undeniable that it seems to differ for every single class. And without the token, there’s no way to get the enrollment information!</p>

<p>So knowing all this now, our process should be something like</p>

<ol>
  <li>Someone inputs something like Math 142</li>
  <li>Use “MATH” as the subject, 142 as the catalog number, and query the CourseTitlesView page</li>
  <li>Use the model that the CourseTitlesView page spits out as the model for a GetCourseSummary</li>
  <li>Scrape the class data from the GetCourseSummary endpoint.</li>
</ol>

<p>This function summarizes my first attempt at implementing the first 3 steps:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">search_for_class_model</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="n">catalog</span><span class="p">,</span> <span class="n">lecture_no</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">term</span><span class="o">=</span><span class="s">"21W"</span><span class="p">):</span>
    <span class="c1"># Separate catalog no (151AH) into {numbers: 151, letters:AH}.
</span>    <span class="c1"># The reason for this is really annoying:
</span>    <span class="c1"># For some reason, when padding the overall course name with
</span>    <span class="c1"># zeroes, you only consider the length of the number part.
</span>    <span class="c1"># For example, Math 151AH would become MATH0151AH,
</span>    <span class="c1"># while Math 31A would become MATH0031A
</span>    <span class="n">better_catalog</span> <span class="o">=</span> <span class="n">parse_catalog_no</span><span class="p">(</span><span class="n">catalog</span><span class="p">)</span>
 
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">"X-Requested-With"</span><span class="p">:</span> <span class="s">"XMLHttpRequest"</span><span class="p">}</span>    
    <span class="n">pageNumber</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="c1"># if I included the whole url, it'd look really long and ugly
</span>        <span class="c1"># so just trust me that the query parameters are all in the right place
</span>        <span class="n">url</span> <span class="o">=</span> <span class="s">f'https://sa.ucla.edu/ro/Public/SOC/Results/CourseTitlesView?...'</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
 
        <span class="c1"># when we get past all the result pages, we'll get nothing from requests.get
</span>        <span class="k">if</span> <span class="n">r</span><span class="p">.</span><span class="n">content</span> <span class="o">==</span> <span class="s">b''</span><span class="p">:</span>
            <span class="k">break</span>
 
       
        <span class="n">real_regex</span> <span class="o">=</span> <span class="n">regex</span> <span class="o">%</span> <span class="p">(</span><span class="n">subject</span> <span class="o">+</span> <span class="n">better_catalog</span><span class="p">,</span> <span class="n">subject</span> <span class="o">+</span> <span class="n">better_catalog</span><span class="p">)</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">real_regex</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">content</span><span class="p">))</span>
         
        <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">found</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
 
        <span class="n">pageNumber</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div></div>

<p>(You’ll have to forgive me for that giant URL, this was early in the project before I had the URL stored as an instance variable in a larger class context, and before I knew about URL encoding with urllib.)</p>

<p>where <code class="language-text highlighter-rouge">real_regex</code> on line 23 is the regex I used to extract the model. So we’d get back an iterator containing every model that matches the input, for example “MATH 142”.</p>

<p>(I say every model simply because there are some wack cases where for example “MATH 19” has two distinct classes with the same subject and catalog.) And with these models, we can implement the final step, which is to go up to the GetCourseSummary endpoint and ask for the rest of the class information for each class model.</p>

<h2 id="speed-is-important">Speed is Important!</h2>
<p>After implementing the above process everything was looking pretty good. However, I was noticing something while running commands on Discord: the commands actually took a good amount of time to execute. Because Discord isn’t quite a command line interface, you can’t see too much of how it’s thinking and as such, it’s a bit uncomfortable when there’s a noticeable gap between sending the command and getting the response.</p>

<p>The largest reason for this is because the first query takes quite a long time because step 2 of the process listed above takes quite a while, because the program has to sift through giant chunks of HTML looking for the right model. At a certain point, this might also become inefficient just because we’ll have to keep getting that giant list for everyone every time MATH subject is searched.</p>

<p>This is when I got another idea: why don’t we just store the models in a giant JSON file? It’s not like the existence of certain classes and their tokens will change that often, so keeping it more locally instead of having to ask UCLA for it every single time could be a great way to save time.</p>

<p>(Of course, a good point is that we can’t keep that file and just never update it again, certain classes get added later on closer to when the new quarter starts. We’ll have to “reload” every once in a while, but I’ll get to the detail on that later.)</p>

<p>Caching all classes
So now I needed some function that would get every single UCLA class’s model to store in the big cached JSON. But for this, I needed to know every single subject offered in a single quarter. I say in a single quarter because I can’t rule out some weird cases where a department changes names over quarters, or even stops existing, so I can’t just generalize a single list of subjects over all quarters.</p>

<p>So our first step is to, given a certain quarter, get all the subjects offered. I know that the SOC website autofills subjects, so it must have some way of getting all those names. Sure enough, looking through the HTML some more:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span><span class="nt">&gt;</span>
    <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">SearchPanelSetup</span><span class="p">(</span><span class="dl">'</span><span class="s1">[{"label":"Aerospace Studies (AERO ST)","value":"AERO ST"},{"label":"African American Studies (AF AMER)","value":"AF AMER"},{"label":"African Studies (AFRC ST)","value":"AFRC ST"},
&lt;!-- ... --&gt;
</span><span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>
<p>There it is! That giant string in this script seems to hold all the subjects that are possible to search for in a particular quarter (it changes with quarter). I assume the purpose of this script is to load all the subjects into the search bar for autofilling purposes, but whatever. All we need to do is get this string, parse it, and then load it into our JSON file.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_subjects_for_term</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">f"getting subjects json for </span><span class="si">{</span><span class="n">term</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">f"https://sa.ucla.edu/ro/Public/SOC/Results?t=</span><span class="si">{</span><span class="n">term</span><span class="si">}</span><span class="s">&amp;sBy=subject&amp;subj=MATH"</span><span class="p">)</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="s">"SearchPanelSetup\('(.*?)'"</span><span class="p">)</span>
    <span class="n">soup</span>  <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">content</span><span class="p">,</span> <span class="s">"lxml"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">script</span> <span class="ow">in</span> <span class="n">soup</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="s">"script"</span><span class="p">):</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">template</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">script</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">matches</span><span class="p">:</span>
            <span class="n">subjects</span> <span class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">replace</span><span class="p">(</span><span class="s">"'"</span><span class="p">,</span> <span class="s">'"'</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">term</span><span class="p">:</span>
                <span class="n">os</span><span class="p">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">data_dir</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">term</span><span class="o">=</span><span class="n">term</span><span class="p">))</span>
 
            <span class="n">subjects_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">data_dir</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">term</span><span class="o">=</span><span class="n">term</span> <span class="ow">or</span> <span class="bp">self</span><span class="p">.</span><span class="n">default_term</span><span class="p">)</span> <span class="o">+</span> <span class="s">"/subjects.json"</span><span class="p">,</span> <span class="s">"w+"</span><span class="p">)</span>
            <span class="n">subjects_file</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">subjects</span><span class="p">)</span>
            <span class="n">subjects_file</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>
<p>So that takes care of the <code class="language-text highlighter-rouge">subjects.json</code> file, and now we can read through that file to get the corresponding <code class="language-text highlighter-rouge">class_names.json</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_reload_classes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">term</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c1"># Load list of subjects parsed from UCLA website
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">data_dir</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">term</span><span class="o">=</span><span class="n">term</span> <span class="ow">or</span> <span class="bp">self</span><span class="p">.</span><span class="n">default_term</span><span class="p">)</span> <span class="o">+</span> <span class="s">"/subjects.json"</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">get_subjects_for_term</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
 
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">data_dir</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">term</span><span class="o">=</span><span class="n">term</span> <span class="ow">or</span> <span class="bp">self</span><span class="p">.</span><span class="n">default_term</span><span class="p">)</span> <span class="o">+</span> <span class="s">"/subjects.json"</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">subjectsJSON</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">f</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
 
        <span class="n">class_name_dict</span> <span class="o">=</span> <span class="p">{}</span>
 
        <span class="c1"># we're sending command from discord channel, so force the reload goes through regardless of when last updated
</span>        <span class="k">if</span> <span class="n">ctx</span><span class="p">:</span>
            <span class="c1"># await ctx.send(f"Reloading the {term or self.default_term} class names JSON (this may take a minute or 2)...")
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="s">"sfasf"</span><span class="p">)</span>
 
        <span class="k">print</span><span class="p">(</span><span class="s">f"Reloading the </span><span class="si">{</span><span class="n">term</span><span class="si">}</span><span class="s"> class names JSON (this may take a minute or 2)..."</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">subject</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">subjectsJSON</span><span class="p">):</span>
            <span class="n">pageNumber</span> <span class="o">=</span> <span class="mi">1</span>
 
            <span class="c1"># Replace everything but spaces, which get changed to "+", i.e. "ART HIS" -&gt; "ART+HIS"
</span>            <span class="n">model</span> <span class="o">=</span> <span class="p">{</span><span class="s">"subj_area_cd"</span><span class="p">:</span><span class="n">subject</span><span class="p">[</span><span class="s">"value"</span><span class="p">],</span><span class="s">"search_by"</span><span class="p">:</span><span class="s">"subject"</span><span class="p">,</span><span class="s">"term_cd"</span><span class="p">:</span><span class="n">term</span> <span class="ow">or</span> <span class="bp">self</span><span class="p">.</span><span class="n">default_term</span><span class="p">,</span><span class="s">"SubjectAreaName"</span><span class="p">:</span><span class="s">"Computer Science (COM SCI)"</span><span class="p">,</span><span class="s">"CrsCatlgName"</span><span class="p">:</span><span class="s">"Enter a Catalog Number or Class Title (Optional)"</span><span class="p">,</span><span class="s">"ActiveEnrollmentFlag"</span><span class="p">:</span><span class="s">"n"</span><span class="p">,</span><span class="s">"HasData"</span><span class="p">:</span><span class="s">"True"</span><span class="p">}</span>
            <span class="n">all_classes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s">'search_by'</span><span class="p">:</span> <span class="s">'subject'</span><span class="p">,</span> <span class="s">'model'</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span> <span class="s">"pageNumber"</span><span class="p">:</span><span class="n">pageNumber</span><span class="p">,</span> <span class="s">'FilterFlags'</span><span class="p">:</span> <span class="n">filter_flags</span><span class="p">,</span> <span class="s">'_'</span><span class="p">:</span> <span class="s">'1571869764769'</span><span class="p">}</span>
 
                <span class="n">url</span> <span class="o">=</span> <span class="n">_generate_url</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">COURSE_TITLES_VIEW</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
 
                <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">HEADERS</span><span class="p">)</span>
                <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">content</span><span class="p">,</span> <span class="s">"lxml"</span><span class="p">)</span>
                <span class="n">div_script_pairs</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">soup</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="s">"h3.head"</span><span class="p">),</span> <span class="n">soup</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="s">"script"</span><span class="p">))</span>
 
                <span class="k">for</span> <span class="n">div</span><span class="p">,</span> <span class="n">script</span> <span class="ow">in</span> <span class="n">div_script_pairs</span><span class="p">:</span>
                    <span class="c1"># I can't guarantee that there isn't some wack scenario where there are two classes
</span>                    <span class="c1"># names exactly the same, make each name+model pair like a tuple instead
</span>                    <span class="n">all_classes</span><span class="p">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">div</span><span class="p">.</span><span class="n">select_one</span><span class="p">(</span><span class="s">'a[id$="-title"]'</span><span class="p">).</span><span class="n">text</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="s">"({.*?})"</span><span class="p">,</span> <span class="n">script</span><span class="p">.</span><span class="n">decode_contents</span><span class="p">())[</span><span class="mi">1</span><span class="p">]])</span>
                <span class="c1"># when we get past all the result pages, we'll get nothing from requests.get
</span>                <span class="k">if</span> <span class="n">r</span><span class="p">.</span><span class="n">content</span> <span class="o">==</span> <span class="s">b''</span><span class="p">:</span>
                    <span class="k">break</span>
 
                <span class="n">pageNumber</span> <span class="o">+=</span> <span class="mi">1</span>
 
            <span class="n">class_name_dict</span><span class="p">[</span><span class="n">subject</span><span class="p">[</span><span class="s">"value"</span><span class="p">]]</span> <span class="o">=</span> <span class="n">all_classes</span>
 
        <span class="k">if</span> <span class="n">ctx</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">f"Done reloading"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Done reloading"</span><span class="p">)</span>
 
        <span class="n">class_names_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">data_dir</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">term</span><span class="o">=</span><span class="n">term</span> <span class="ow">or</span> <span class="bp">self</span><span class="p">.</span><span class="n">default_term</span><span class="p">)</span> <span class="o">+</span> <span class="s">"/class_names.json"</span><span class="p">,</span> <span class="s">"w"</span><span class="p">)</span>
        <span class="n">class_names_file</span><span class="p">.</span><span class="n">write</span><span class="p">(</span>
            <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">"last_updated"</span><span class="p">:</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">(),</span> <span class="s">"term"</span><span class="p">:</span> <span class="n">term</span> <span class="ow">or</span> <span class="bp">self</span><span class="p">.</span><span class="n">default_term</span><span class="p">,</span> <span class="s">"class_names"</span><span class="p">:</span> <span class="n">class_name_dict</span><span class="p">},</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
        <span class="n">class_names_file</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>
<p>After that, the class_names.json looks a bit like this.</p>

<p>Great, then when we look up a class, we can just find if the catalog number matches up with everything before the “-” in the class name.</p>

<h2 id="parsing-classes">Parsing Classes</h2>
<p>So now we’ve pretty much figured out how we’re going to get all the data, now it’s just time to parse. Recall what the incoming data looks like:</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"MATH0003C-children"</span><span class="nt">&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row-fluid data_row primary-row class-info class-not-checked"</span> <span class="na">id=</span><span class="s">"262089200_MATH0003C"</span><span class="nt">&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"enrollColumn"</span> <span class="na">id=</span><span class="s">"262089200_MATH0003C-enroll"</span><span class="nt">&gt;</span>
<span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"262089200_MATH0003C-checkbox"</span> <span class="na">type=</span><span class="s">"checkbox"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"toggle"</span> <span class="na">id=</span><span class="s">"262089200_MATH0003C-expando"</span><span class="nt">&gt;</span>
<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"javascript:void(0)"</span><span class="nt">&gt;&lt;span</span> <span class="na">class=</span><span class="s">"icon-caret-right"</span><span class="nt">&gt;&lt;/span&gt;&lt;/a&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"sectionColumn"</span><span class="nt">&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"cls-section click_info"</span> <span class="na">id=</span><span class="s">"262089200_MATH0003C-section"</span><span class="nt">&gt;</span>
<span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"hide-small"</span><span class="nt">&gt;</span>
<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/ro/Public/SOC/Results/ClassDetail?term_cd=21S&amp;subj_area_cd=MATH%20%20%20&amp;crs_catlg_no=0003C%20%20%20&amp;class_id=262089200&amp;class_no=%20001%20%20"</span> <span class="na">target=</span><span class="s">"_blank"</span> <span class="na">title=</span><span class="s">"Class Detail for 262089200"</span><span class="nt">&gt;</span>Lec 1<span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"hide-above-small"</span> <span class="na">data-poload=</span><span class="s">"term_cd=21S&amp;subj_area_cd=MATH+++&amp;crs_catlg_no=0003C   &amp;class_id=262089200&amp;class_no= 001  "</span> <span class="na">tabindex=</span><span class="s">"0"</span><span class="nt">&gt;</span>
                        Lec 1 <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"icon-warning-sign icon-position"</span><span class="nt">&gt;&lt;/span&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"statusColumn"</span> <span class="na">id=</span><span class="s">"262089200_MATH0003C-status_data"</span><span class="nt">&gt;&lt;p&gt;&lt;i</span> <span class="na">class=</span><span class="s">"icon-unlock"</span> <span class="na">style=</span><span class="s">"color:green; display:block; float:left; height:3em;"</span><span class="nt">&gt;&lt;/i&gt;</span>Open<span class="nt">&lt;br/&gt;</span>0 of 140 Enrolled<span class="nt">&lt;br/&gt;</span>140 Spots Left<span class="nt">&lt;/p&gt;&lt;/div&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"waitlistColumn"</span> <span class="na">id=</span><span class="s">"262089200_MATH0003C-waitlist_data"</span><span class="nt">&gt;</span>
<span class="nt">&lt;p&gt;</span>0 of 12 Taken<span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"infoColumn hide-small click_info"</span> <span class="na">id=</span><span class="s">"262089200_MATH0003C-info_data"</span><span class="nt">&gt;</span>
<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"javascript:void(0)"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"icon-warning-sign icon-position"</span> <span class="na">data-poload=</span><span class="s">"term_cd=21S&amp;subj_area_cd=MATH+++&amp;crs_catlg_no=0003C   &amp;class_id=262089200&amp;class_no= 001  "</span> <span class="na">tabindex=</span><span class="s">"0"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"dayColumn hide-small beforeCollapseHide"</span><span class="nt">&gt;</span>
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"262089200_MATH0003C-days_data"</span><span class="nt">&gt;</span>
<span class="nt">&lt;p&gt;&lt;a</span> <span class="na">class=</span><span class="s">"popover-bottom"</span> <span class="na">data-content=</span><span class="s">"Monday, Wednesday, Friday"</span> <span class="na">href=</span><span class="s">"javascript:void(0)"</span><span class="nt">&gt;</span>MWF<span class="nt">&lt;/a&gt;&lt;/p&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"timeColumn"</span> <span class="na">id=</span><span class="s">"262089200_MATH0003C-time_data"</span><span class="nt">&gt;</span>
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"262089200_MATH0003C-days_data"</span><span class="nt">&gt;</span>
<span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"hide-above-small beforeCollapseShow"</span><span class="nt">&gt;&lt;a</span> <span class="na">class=</span><span class="s">"popover-bottom"</span> <span class="na">data-content=</span><span class="s">"Monday, Wednesday, Friday"</span> <span class="na">href=</span><span class="s">"javascript:void(0)"</span><span class="nt">&gt;</span>MWF<span class="nt">&lt;/a&gt;&lt;/p&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;p&gt;</span>12pm<span class="nt">&lt;wbr/&gt;</span>-12:50pm<span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"locationColumn hide-small"</span> <span class="na">id=</span><span class="s">"262089200_MATH0003C-location_data"</span><span class="nt">&gt;</span>
<span class="nt">&lt;p&gt;</span>
<span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"popover-bottom"</span> <span class="na">data-content=</span><span class="s">"Online - Recorded: Classes will be held at scheduled times with faculty delivering course content using remote communication tools and with students in attendance using those tools. Faculty &lt;strong&gt;will record&lt;/strong&gt; the class and make available those scheduled activities for subsequent use by students. However, students should be aware that faculty may still request their participation during scheduled meeting times."</span> <span class="na">href=</span><span class="s">"javascript:void(0)"</span><span class="nt">&gt;</span>Online - Recorded <span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"unitsColumn"</span> <span class="na">id=</span><span class="s">"262089200_MATH0003C-units_data"</span><span class="nt">&gt;&lt;p&gt;</span>4.0<span class="nt">&lt;/p&gt;&lt;/div&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"instructorColumn hide-small"</span> <span class="na">id=</span><span class="s">"262089200_MATH0003C-instructor_data"</span><span class="nt">&gt;&lt;p&gt;</span>Greene, M.P.<span class="nt">&lt;/p&gt;&lt;/div&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span><span class="nt">&gt;</span>
        <span class="kd">var</span> <span class="nx">addCourse262089200_MATH0003C</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="nx">Iwe_ClassSearch_SearchResults</span><span class="p">.</span><span class="nx">AddToCourseData</span><span class="p">(</span><span class="dl">"</span><span class="s2">262089200_MATH0003C</span><span class="dl">"</span><span class="p">,{</span><span class="dl">"</span><span class="s2">Term</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">21S</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">SubjectAreaCode</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">MATH   </span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">CatalogNumber</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">0003C   </span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">IsRoot</span><span class="dl">"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="dl">"</span><span class="s2">SessionGroup</span><span class="dl">"</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span><span class="dl">"</span><span class="s2">ClassNumber</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2"> 001  </span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">SequenceNumber</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">1</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">Path</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">262089200_MATH0003C</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">MultiListedClassFlag</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">n</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">Token</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">MDAwM0MgICAyNjIwODkyMDBfTUFUSDAwMDND</span><span class="dl">"</span><span class="p">});</span> <span class="p">};</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">Iwe_ClassSearch_SearchResults</span><span class="p">)</span> <span class="o">!=</span> <span class="dl">"</span><span class="s2">undefined</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">addCourse262089200_MATH0003C</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">load</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">addCourse262089200_MATH0003C</span><span class="p">();</span>
            <span class="p">})</span>
        <span class="p">}</span>
    <span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"/ro/bundles/jspopover?v=Nrx_Cn4rF92aryETxJrW9wFWCHWVEbfIYvLDTjy4c341"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;&lt;/html&gt;</span>
</code></pre></div></div>
<p>I know it’s kind of a mess, but the important takeaway is that this actually looks like it’s the exact HTML that gets loaded when you expand one of the classes on the SOC site, and therefore has all the information we need!</p>

<p>So why don’t we just load this into <code class="language-text highlighter-rouge">BeautifulSoup</code>, and use lots of the nice query selector features? Let’s get parsing out all the easy stuff out of the way.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_parse_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_soup_pair</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">name_soup_pair</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">name_soup_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">soup</span> <span class="o">=</span> <span class="n">name_soup_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># we sent to this function soup from the public records page, which has name info on it
</span>        <span class="n">soup</span> <span class="o">=</span> <span class="n">name_soup_pair</span>
        
    <span class="n">details_url</span> <span class="o">=</span> <span class="s">"https://sa.ucla.edu"</span> <span class="o">+</span> <span class="n">soup</span><span class="p">.</span><span class="n">select_one</span><span class="p">(</span><span class="s">'a[title^="Class Detail for "]'</span><span class="p">)[</span><span class="s">'href'</span><span class="p">]</span>
    <span class="n">section_name</span> <span class="o">=</span> <span class="n">soup</span><span class="p">.</span><span class="n">select_one</span><span class="p">(</span><span class="s">'a[title^="Class Detail for "]'</span><span class="p">).</span><span class="n">text</span>
    <span class="n">details_url_parts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">urlparse</span><span class="p">.</span><span class="n">parse_qsl</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">urlparse</span><span class="p">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">details_url</span><span class="p">))[</span><span class="mi">4</span><span class="p">]))</span>

    <span class="n">subject</span> <span class="o">=</span> <span class="n">details_url_parts</span><span class="p">[</span><span class="s">'subj_area_cd'</span><span class="p">].</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">name_soup_pair</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">f'</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">name_soup_pair</span><span class="p">.</span><span class="n">select_one</span><span class="p">(</span><span class="s">"a[id$=-title]"</span><span class="p">).</span><span class="n">text</span><span class="si">}</span><span class="s">'</span>

    <span class="n">enrollment_data</span> <span class="o">=</span> <span class="n">soup</span><span class="p">.</span><span class="n">select_one</span><span class="p">(</span><span class="s">"div[id$=-status_data]"</span><span class="p">).</span><span class="n">text</span>
    <span class="n">waitlist_data</span> <span class="o">=</span> <span class="n">soup</span><span class="p">.</span><span class="n">select_one</span><span class="p">(</span><span class="s">"div[id$=-waitlist_data]"</span><span class="p">).</span><span class="n">text</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span>

    <span class="n">locations</span> <span class="o">=</span> <span class="n">_parse_string_to_array</span><span class="p">(</span><span class="n">soup</span><span class="p">.</span><span class="n">select_one</span><span class="p">(</span><span class="s">"div[id$=-location_data]"</span><span class="p">))</span> <span class="ow">or</span> <span class="p">[</span><span class="s">"N/A"</span><span class="p">]</span>
    <span class="n">days</span> <span class="o">=</span> <span class="n">_parse_string_to_array</span><span class="p">(</span><span class="n">soup</span><span class="p">.</span><span class="n">select_one</span><span class="p">(</span><span class="s">"div[id$=-days_data] p a"</span><span class="p">))</span> <span class="ow">or</span> <span class="p">[</span><span class="s">"N/A"</span><span class="p">]</span>
    <span class="n">times</span> <span class="o">=</span> <span class="n">_parse_string_to_array</span><span class="p">(</span><span class="n">soup</span><span class="p">.</span><span class="n">select_one</span><span class="p">(</span><span class="s">"div[id$=-time_data]&gt;p"</span><span class="p">))</span> <span class="ow">or</span> <span class="p">[</span><span class="s">"N/A"</span><span class="p">]</span>

    <span class="n">instructors</span> <span class="o">=</span> <span class="n">_parse_string_to_array</span><span class="p">(</span><span class="n">soup</span><span class="p">.</span><span class="n">select_one</span><span class="p">(</span><span class="s">"div[id$=-instructor_data]&gt;p"</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">None</span><span class="p">)</span>

    <span class="c1"># I hope it always looks lile &lt;div id="blah-units_data"&gt;&lt;p&gt; # of units &lt;/p&gt;&lt;/div&gt;
</span>    <span class="c1"># could be wrong...
</span>    <span class="n">units</span> <span class="o">=</span> <span class="n">soup</span><span class="p">.</span><span class="n">select_one</span><span class="p">(</span><span class="s">"div[id$=-units_data] p"</span><span class="p">).</span><span class="n">text</span>

    <span class="n">class_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"subject"</span><span class="p">:</span>         <span class="n">subject</span><span class="p">,</span>
        <span class="s">"class_no"</span><span class="p">:</span>        <span class="n">details_url_parts</span><span class="p">[</span><span class="s">'class_no'</span><span class="p">].</span><span class="n">strip</span><span class="p">(),</span>
        <span class="s">"class_id"</span><span class="p">:</span>        <span class="n">parse_class_id</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">soup</span><span class="p">)),</span>
        <span class="s">"class_name"</span><span class="p">:</span>      <span class="n">name</span><span class="p">,</span>
        <span class="s">"term"</span><span class="p">:</span>            <span class="n">parse_term</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">soup</span><span class="p">)),</span>
        <span class="s">"section_name"</span><span class="p">:</span>    <span class="n">section_name</span><span class="p">,</span>
        <span class="s">"instructors"</span><span class="p">:</span>     <span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">instructors</span><span class="p">),</span>
        <span class="s">"days"</span><span class="p">:</span>            <span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">days</span><span class="p">),</span>
        <span class="s">"times"</span><span class="p">:</span>           <span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">times</span><span class="p">),</span>
        <span class="s">"locations"</span><span class="p">:</span>       <span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">locations</span><span class="p">),</span>
        <span class="s">"units"</span><span class="p">:</span>           <span class="n">units</span><span class="p">,</span>
        <span class="s">"url"</span><span class="p">:</span>             <span class="n">details_url</span><span class="p">,</span>
        <span class="s">"enrollment_data"</span><span class="p">:</span> <span class="n">enrollment_data</span><span class="p">,</span>
    <span class="p">}</span>
<span class="c1"># ...
</span></code></pre></div></div>
<p>Note that I have an auxiliary function <code class="language-text highlighter-rouge">_parse_string_to_array</code> for those weird cases where you have two instructors or 2 locations (in the Before Times), or even different times for different days. These need to be separated into an array. Here’s an example with Math 115AH which always has two separate meeting items for some reason:</p>

<p><img src="/assets/img/blog/discord_files/soc_class_2_times.png" alt="A class with two meeting times" /></p>

<p>We’d want the result to look similar:</p>

<p><img src="/assets/img/blog/discord_files/discord_embed.png" alt="What we want the resulting display from the Discord bot to look like" /></p>

<p>But now there’s the question of parsing the actual enrollment status. Unfortunately, it’s not as simple as getting the first word in the “statusColumn”, because sometimes it could be “ClosedClass Full” or “WaitlistClass Full”. Furthermore, I think it would be great to get the actual numbers (12 enrolled out of 20). This seemed like a good job for regex, and this is actually where I found another really neat regex feature I didn’t know about: named capture groups.</p>

<p>After looking over a good amount of classes, and remembering the filter flags from earlier that covered all cases for the status of a class, these are the regexes I came up with.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="bp">self</span><span class="p">.</span><span class="n">status_regexes</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"tenative"</span><span class="p">:</span> <span class="n">re</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="s">'^Tentative'</span><span class="p">),</span>
    <span class="s">"cancelled"</span><span class="p">:</span> <span class="n">re</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="s">'^Cancelled'</span><span class="p">),</span>
    <span class="s">"closedByDept"</span><span class="p">:</span> <span class="n">re</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span>
        <span class="s">'^Closed by Dept[a-zA-Z,/ ]*(\((?P&lt;Capacity&gt;\d+) capacity, (?P&lt;EnrolledCount&gt;\d+) enrolled, (?P&lt;WaitlistedCount&gt;\d+) waitlisted\))?'</span><span class="p">),</span>
    <span class="s">"classFull"</span><span class="p">:</span> <span class="n">re</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span>
        <span class="s">'ClosedClass Full \((?P&lt;Capacity&gt;\d+)\)(, Over Enrolled By (?P&lt;OverenrolledCount&gt;\d+))?'</span><span class="p">),</span>
    <span class="s">"classOpen"</span><span class="p">:</span> <span class="n">re</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="s">'Open(?P&lt;EnrolledCount&gt;\d+) of (?P&lt;Capacity&gt;\d+) Enrolled(\d+) Spots? Left'</span><span class="p">),</span>
    <span class="s">"waitlistOnly"</span><span class="p">:</span> <span class="n">re</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="s">'^Waitlist$'</span><span class="p">),</span>
    <span class="s">"waitlistFull"</span><span class="p">:</span> <span class="n">re</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span>
        <span class="s">'^WaitlistClass Full \((?P&lt;Capacity&gt;\d+)\)(, Over Enrolled By (?P&lt;OverenrolledCount&gt;\d+))?'</span><span class="p">),</span>
<span class="p">}</span>
</code></pre></div></div>
<p>With this collection of regexes (regi?), we can iterate over all the each kind of regex, and whenever one gets a match, we can set the dictionary key to the detected enrollment status, and we can even then use the matched groups to get a reference to the enrollment count (number of seats taken) and the enrollment capacity (number of seats available).</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_parse_enrollment_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">my_string</span><span class="p">):</span>
        <span class="s">"""
        Go through the dictionary of enrollment regexes, return an enrollment dictionary
        with count, capacity, etc numbers when the right match is found.
        """</span>
 
        <span class="k">for</span> <span class="n">potential_status</span><span class="p">,</span> <span class="n">regex</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">status_regexes</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">matches</span> <span class="o">=</span> <span class="n">regex</span><span class="p">.</span><span class="n">match</span><span class="p">(</span><span class="n">my_string</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">matches</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">match_dict</span> <span class="o">=</span> <span class="n">matches</span><span class="p">.</span><span class="n">groupdict</span><span class="p">()</span>
                <span class="n">enrollment_dict</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s">"enrollment_status"</span><span class="p">:</span> <span class="n">potential_status</span><span class="p">,</span>
                    <span class="s">"enrollment_capacity"</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">match_dict</span><span class="p">[</span><span class="s">"Capacity"</span><span class="p">]</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="s">"Capacity"</span> <span class="ow">in</span> <span class="n">match_dict</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
                    <span class="s">"enrollment_count"</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span>
                        <span class="n">match_dict</span><span class="p">[</span><span class="s">"EnrolledCount"</span><span class="p">]</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="s">"EnrolledCount"</span> <span class="ow">in</span> <span class="n">match_dict</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
                    <span class="s">"enrollment_over"</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span>
                        <span class="n">match_dict</span><span class="p">[</span><span class="s">"OverenrolledCount"</span><span class="p">]</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="s">"OverenrolledCount"</span> <span class="ow">in</span> <span class="n">match_dict</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="n">enrollment_dict</span><span class="p">[</span><span class="s">'enrollment_status'</span><span class="p">]</span> <span class="o">==</span> <span class="s">"classFull"</span> <span class="ow">or</span> <span class="n">enrollment_dict</span><span class="p">[</span>
                    <span class="s">'enrollment_status'</span><span class="p">]</span> <span class="o">==</span> <span class="s">"waitlistFull"</span><span class="p">:</span>
                    <span class="n">enrollment_dict</span><span class="p">[</span><span class="s">"enrollment_count"</span><span class="p">]</span> <span class="o">=</span> <span class="n">enrollment_dict</span><span class="p">[</span><span class="s">"enrollment_capacity"</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">enrollment_dict</span>
</code></pre></div></div>

<p>One little annoying detail you might notice I have to handle in my code is the fact that the enrollment status string for full classes might look something like</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Waitlist
Class Full (180), Over Enrolled By 9
</code></pre></div></div>
<p>And well, the regex for a waitlisted full class only picks up the capacity at 180 in this case. Of course, they omit the actual enrollment count because it’s implied to be 180 as well, so the last few lines of the function handle that case.</p>

<p>There is a corresponding function for the waitlist status, using the following regexes:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="bp">self</span><span class="p">.</span><span class="n">waitlist_regexes</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"waitlistOpen"</span><span class="p">:</span> <span class="n">re</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="s">'(?P&lt;WaitlistCount&gt;\d+) of (?P&lt;WaitlistCapacity&gt;\d+) Taken'</span><span class="p">),</span>
    <span class="s">"noWaitlist"</span><span class="p">:</span> <span class="n">re</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="s">'No Waitlist'</span><span class="p">),</span>
    <span class="s">"waitlistClosed"</span><span class="p">:</span> <span class="n">re</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="s">'Waitlist Full \((?P&lt;WaitlistCapacity&gt;\d+)\)'</span><span class="p">),</span>
<span class="p">}</span>
</code></pre></div></div>
<h2 id="interacting-with-the-bot">Interacting with the Bot</h2>

<p>Great, we’ve hammered out most of the details of how the bot will scrape all that class information. But now, of course, we need to define how the user themselves will ask the bot for this information. Due to the nature of Discord bots, we have a couple limitations, in particular, outside of “texting” the bot, there’s not many other ways we can talk to the bot, so we have to think about that.</p>

<h3 id="choices">Choices</h3>
<p>For example, I’ve mentioned briefly how giving a subject+catalog number isn’t enough to uniquely identify a single offering of a course. When you meet someone else taking Math 32A, you have to ask something like “which professor?” to confirm that you are indeed in the same class. Even then, there’s no reliable way to know, many times the same professor teaches 2 different lectures of the same class in a single quarter.</p>

<p>All that to say, we’re going to have to accept that there’s no real way for a user by themselves to reliably provide enough information to identify a single class to keep track of. Then again, this is sort of what UCLA does themselves, providing a table of each lecture under each class title. So we’re going to have to present choices to the user, and have them select one.</p>

<p>I was looking through other bots to see how they handled scenarios that require user input or choice, like voting, or confirming certain commands, and realized the exact solution: emoji reactions!</p>

<figure style="width: 600px;">
<img alt="small network" src="/assets/img/blog/discord_files/discord_reaction.png" class="lead" />
<figcaption>Example of Discord reaction
</figcaption>
</figure>

<p>Under any message in Discord, you can “react” with emojis underneath. For normal users and conversation, this is just a fun little feature to express something about what someone said. However, because bots have the capability to both create and detect reactions on certain messages, this is a perfect way to present and collect choices from users.</p>

<p>So let’s say we’re looking up the class MATH 142, which usually has 2 lectures. After sending messages about the info we found for each lecture, we can present a message with emoji reactions equal in amount to the number of lectures found. There are only 10 emojis labeled 1-10 (duh) so just in case we have some wack scenario where someone is concerned with lecture 15 of a class. So I figured it’d make more sense to go with letters.</p>

<p>I’m not sure if this is common knowledge, but I didn’t know this going into the project: apparently emojis have unicode encodings as well, and if you did something like chr(127462), you’d get a string with the “A” emoji, and could print it as long as whatever platform you’re using could handle displaying emojis.</p>

<p>And thankfully, all the letter emojis are adjacent to each other, so I could just build up the list of emoji choices I needed really easily.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">emoji_choices</span> <span class="o">=</span> <span class="p">[</span><span class="nb">chr</span><span class="p">(</span><span class="n">A_EMOJI_INT</span> <span class="o">+</span> <span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_choices</span><span class="p">)]</span>
</code></pre></div></div>

<p>Then the idea could be to wait for the user to react with an emoji, and based on the unicode of the emoji choices, determine the index of the choice they made.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="k">def</span> <span class="nf">_present_choices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">num_choices</span><span class="p">):</span>
    <span class="s">"""Given a (int) number of choices, send a message asking to choose one, with reactions for easy selecting"""</span>
    <span class="n">emoji_choices</span> <span class="o">=</span> <span class="p">[</span><span class="nb">chr</span><span class="p">(</span><span class="n">A_EMOJI_INT</span> <span class="o">+</span> <span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_choices</span><span class="p">)]</span>
    <span class="n">status</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ctx</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">f"Choose the class you want keep an eye on/remove from your watchlist."</span><span class="p">)</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            
        <span class="k">for</span> <span class="n">emoji_choice</span> <span class="ow">in</span> <span class="n">emoji_choices</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">status</span><span class="p">.</span><span class="n">add_reaction</span><span class="p">(</span><span class="n">emoji_choice</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">status</span><span class="p">.</span><span class="n">add_reaction</span><span class="p">(</span><span class="n">NO_EMOJI</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="p">.</span><span class="n">bot</span><span class="p">.</span><span class="n">wait_for</span><span class="p">(</span><span class="s">"reaction_add"</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="k">lambda</span> <span class="n">reaction</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">user</span> <span class="o">==</span> <span class="n">ctx</span><span class="p">.</span><span class="n">author</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="p">.</span><span class="nb">TimeoutError</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># check if this is the right user, and the right message
</span>            <span class="n">reactors</span>  <span class="o">=</span> <span class="k">await</span> <span class="n">r</span><span class="p">.</span><span class="n">users</span><span class="p">().</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">r</span><span class="p">.</span><span class="n">message</span><span class="p">.</span><span class="nb">id</span> <span class="o">==</span> <span class="n">status</span><span class="p">.</span><span class="nb">id</span> <span class="ow">and</span> <span class="n">ctx</span><span class="p">.</span><span class="n">author</span> <span class="ow">in</span> <span class="n">reactors</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">r</span><span class="p">.</span><span class="n">emoji</span> <span class="o">==</span> <span class="n">NO_EMOJI</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">status</span><span class="p">.</span><span class="n">edit</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s">"Aborted!"</span><span class="p">,</span> <span class="n">delete_after</span><span class="o">=</span><span class="n">TMPMSG_DEFAULT</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">None</span>
                <span class="k">if</span> <span class="n">r</span><span class="p">.</span><span class="n">emoji</span> <span class="ow">in</span> <span class="n">emoji_choices</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">status</span><span class="p">.</span><span class="n">edit</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s">f"You've selected choice </span><span class="si">{</span><span class="n">r</span><span class="p">.</span><span class="n">emoji</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
                    <span class="c1"># The index of our choice will correspond with how "far" out emoji
</span>                    <span class="c1"># choice was past number that corresponds with the A emoji
</span>                    <span class="n">choice_index</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">emoji</span><span class="p">)</span> <span class="o">-</span> <span class="n">A_EMOJI_INT</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">ctx</span><span class="p">.</span><span class="n">guild</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">emoji_choice</span> <span class="ow">in</span> <span class="n">emoji_choices</span><span class="p">:</span>
                                <span class="k">await</span> <span class="n">status</span><span class="p">.</span><span class="n">clear_reaction</span><span class="p">(</span><span class="n">emoji_choice</span><span class="p">)</span>
                            <span class="k">await</span> <span class="n">status</span><span class="p">.</span><span class="n">clear_reaction</span><span class="p">(</span><span class="n">NO_EMOJI</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">discord</span><span class="p">.</span><span class="n">errors</span><span class="p">.</span><span class="n">Forbidden</span><span class="p">:</span>
                        <span class="k">pass</span>


                    <span class="k">return</span> <span class="n">choice_index</span>
</code></pre></div></div>

<p>Overall, a standard “dialogue” with the bot might then look like</p>

<p><img src="/assets/img/blog/discord_files/bot_dialogue.png" alt="Standard bot dialogue" /></p>

<h3 id="fast-and-slow-mode">Fast and Slow Mode</h3>
<p>Because the incoming data is just HTML that would be thrown up on the page after clicking to expand one of those classes, I thought “wouldn’t it be great if we could just render that HTML somehow, and just ‘take a picture’ and send that as the message in Discord?”. That way it would look like the familiar table view, and I wouldn’t have to fiddle with designing my own display of a class’s information.</p>

<p>Now through the 10 minutes I spent digging, there are some ways of doing this programmatically, but either they were more trouble than they were worth, or I couldn’t get them working. But then I remembered Pyppeteer in some examples demonstrated the feature of taking a screenshot of an HTML element. While this wouldn’t be rendering the HTML locally, and relying on going to the SOC website again, this didn’t seem like a bad idea.</p>

<p>In fact, you’re also allowed to run Javascript on your “fake browser” that Pyppeteer has running, so I could even inject the words into each class title as a way of labeling each different choice.</p>

<p><img src="/assets/img/blog/discord_files/slow_mode.png" alt="slow mode" /></p>

<h3 id="the-watchlist">The Watchlist</h3>
<p>So I’ve been making references to this “watchlist” a couple times now, and you might have already guessed what it is based on the context of the entire app: the watchlist is what I’m calling the list of classes you want this bot to notify you about. Obviously this is user specific, so my first solution was to store these are JSON files specific to each users. Now luckily, Discord’s API has easy ways to get a Discord ID associated with each user based on the author of a command, so I thought the most convenient way to do this would be to make a separate file for each user titled exactly their ID number.</p>

<p>But what exactly would be stored in the watchlist? I could just stick each class’s model in there, but we can do one better.</p>

<p>One frustration I encountered earlier actually was that the CoursesTitleView endpoint didn’t actually tell me anything about the Class ID number. Remember from my Ok, Zoomer post that this is a 9 digit ID that, along with a specified term, could uniquely identify classes. If I just had access to that number from the CoursesTitleView endpoint, I wouldn’t have to do all this fiddling with models, because I would just be able to search by Class ID number. However, once we already looked up a class with GetCourseSummary, we could just extract the ID number from the HTML. Therefore, we can just store a class’s term and parsed ID, and that’s enough to look up an individual class.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="k">def</span> <span class="nf">search_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="c1"># ...
# Ask the user which one they want to select
</span>        <span class="n">choice_index</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="p">.</span><span class="n">_present_choices</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">htmls</span><span class="p">))</span>
 
        <span class="c1"># Warning if term is really long ago
</span>        <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"term"</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">current_terms</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">ctx</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">f"</span><span class="si">{</span><span class="n">args</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'term'</span><span class="p">)</span><span class="si">}</span><span class="s"> doesn't seem to be relevant right now. Are you sure you want to track a class from that term?"</span><span class="p">)</span>
        <span class="c1"># And add that selection to their watchlist
</span>        <span class="k">if</span> <span class="n">choice_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">name_soup_pair</span> <span class="o">=</span> <span class="n">htmls</span><span class="p">[</span><span class="n">choice_index</span><span class="p">]</span>
 
            <span class="n">json_object</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_get_user_watchlist</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
 
            <span class="n">parsed_class</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_parse_class</span><span class="p">(</span><span class="n">name_soup_pair</span><span class="p">)</span>
 
 
            <span class="c1"># check for duplicates
</span>            <span class="k">for</span> <span class="n">my_class</span> <span class="ow">in</span> <span class="n">json_object</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">parsed_class</span><span class="p">[</span><span class="s">'class_id'</span><span class="p">]</span> <span class="o">==</span> <span class="n">my_class</span><span class="p">[</span><span class="s">"class_id"</span><span class="p">]</span> <span class="ow">and</span> <span class="n">parsed_class</span><span class="p">[</span><span class="s">'term'</span><span class="p">]</span> <span class="o">==</span> <span class="n">my_class</span><span class="p">[</span><span class="s">"term"</span><span class="p">]:</span>
                    <span class="k">await</span> <span class="n">ctx</span><span class="p">.</span><span class="n">channel</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">"You're already keeping track of that class!"</span><span class="p">)</span>
                    <span class="k">return</span>
 
            <span class="c1"># write class_id, *current* enrollment_status, and a name to the json
</span>            <span class="n">json_object</span><span class="p">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s">"class_id"</span><span class="p">:</span> <span class="n">parsed_class</span><span class="p">[</span><span class="s">'class_id'</span><span class="p">],</span>
                <span class="s">"enrollment_data"</span><span class="p">:</span> <span class="n">name_soup_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">select_one</span><span class="p">(</span><span class="s">"div[id$=-status_data]"</span><span class="p">).</span><span class="n">text</span><span class="p">,</span>
                <span class="s">"class_name"</span><span class="p">:</span> <span class="n">name_soup_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s">"term"</span><span class="p">:</span> <span class="n">parsed_class</span><span class="p">[</span><span class="s">"term"</span><span class="p">],</span>
            <span class="p">})</span>
 
            <span class="n">a_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">f"speedchat_bot/ucla_data/watchlist/</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s">.json"</span><span class="p">,</span> <span class="s">"w"</span><span class="p">)</span>
            <span class="n">json</span><span class="p">.</span><span class="n">dump</span><span class="p">(</span><span class="n">json_object</span><span class="p">,</span> <span class="n">a_file</span><span class="p">)</span>
            <span class="n">a_file</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>
<p>Of course, we also have to store the enrollment data at this moment so that we can compare when looking up the new data, to see if we actually need to notify the user of any change.</p>

<h2 id="check-for-change">Check for Change</h2>
<p>And with all this in place we’re pretty much ready to implement the main loop of the program: checking every so often when enrollment numbers change.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">tasks</span><span class="p">.</span><span class="n">loop</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mf">15.0</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">check_for_change</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s">"""
    Loop that when activated, every 15 seconds checks if a class's status has changed.
    If a class's status has changed, alert user that was watching it, and update their watchlist's data
     
    """</span>
 
    <span class="c1"># iterate through all the files in the watchlist directory
</span>    <span class="k">for</span> <span class="n">user_watchlist</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="n">listdir</span><span class="p">(</span><span class="s">"speedchat_bot/ucla_data/watchlist"</span><span class="p">):</span>
        <span class="c1"># try:
</span>        <span class="c1">#     a_file = open(f"speedchat_bot/ucla_data/watchlist/{user_watchlist}", "r")
</span>        <span class="c1">#     json_object = json.load(a_file)
</span>        <span class="c1">#     a_file.close()
</span>        <span class="c1"># except (FileNotFoundError, json.JSONDecodeError):
</span>        <span class="c1">#     # The file is not there/unreadable, no point going on to check
</span>        <span class="c1">#     return
</span> 
 
        <span class="n">user_id</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">user_watchlist</span><span class="p">)</span>
        <span class="n">json_object</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_get_user_watchlist</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
 
        <span class="k">if</span> <span class="n">json_object</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># The file is not there/unreadable, no point going on to check
</span>            <span class="k">break</span>
 
        <span class="n">need_change</span> <span class="o">=</span> <span class="bp">False</span>
 
        <span class="k">for</span> <span class="n">my_class</span> <span class="ow">in</span> <span class="n">json_object</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s">'t'</span><span class="p">:</span> <span class="n">my_class</span><span class="p">[</span><span class="s">'term'</span><span class="p">],</span> <span class="s">'sBy'</span><span class="p">:</span> <span class="s">'classidnumber'</span><span class="p">,</span> <span class="s">'id'</span><span class="p">:</span> <span class="n">my_class</span><span class="p">[</span><span class="s">'class_id'</span><span class="p">]}</span>
            <span class="n">final_url</span> <span class="o">=</span> <span class="n">_generate_url</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">PUBLIC_RESULTS_URL</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
            <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">final_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">HEADERS</span><span class="p">).</span><span class="n">content</span><span class="p">,</span> <span class="s">"lxml"</span><span class="p">)</span>
            <span class="n">enrollment_data</span> <span class="o">=</span> <span class="n">soup</span><span class="p">.</span><span class="n">select_one</span><span class="p">(</span><span class="s">"div[id$=-status_data]"</span><span class="p">).</span><span class="n">text</span>
 
            <span class="c1"># await self.bot.get_user(int(user_id)).send(f'{my_class["class_name"]} changed from **{my_class["enrollment_data"]}** to **{enrollment_data}**')
</span> 
            <span class="c1">#  Current status  changed from   previously recorded status
</span>            <span class="k">if</span> <span class="n">enrollment_data</span>      <span class="o">!=</span>        <span class="n">my_class</span><span class="p">[</span><span class="s">"enrollment_data"</span><span class="p">]:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="p">.</span><span class="n">bot</span><span class="p">.</span><span class="n">get_user</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">user_id</span><span class="p">)).</span><span class="n">send</span><span class="p">(</span>
                    <span class="s">f'</span><span class="si">{</span><span class="n">my_class</span><span class="p">[</span><span class="s">"class_name"</span><span class="p">]</span><span class="si">}</span><span class="s"> changed from **</span><span class="si">{</span><span class="n">my_class</span><span class="p">[</span><span class="s">"enrollment_data"</span><span class="p">]</span><span class="si">}</span><span class="s">** to **</span><span class="si">{</span><span class="n">enrollment_data</span><span class="si">}</span><span class="s">**'</span><span class="p">)</span>
 
                <span class="n">my_class</span><span class="p">[</span><span class="s">'enrollment_data'</span><span class="p">]</span> <span class="o">=</span> <span class="n">enrollment_data</span>
                <span class="n">need_change</span> <span class="o">=</span> <span class="bp">True</span>
 
        <span class="k">if</span> <span class="n">need_change</span><span class="p">:</span>
            <span class="c1"># update watchlist
</span>            <span class="n">a_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">f"speedchat_bot/ucla_data/watchlist/</span><span class="si">{</span><span class="n">user_watchlist</span><span class="si">}</span><span class="s">"</span><span class="p">,</span> <span class="s">"w"</span><span class="p">)</span>
            <span class="n">json</span><span class="p">.</span><span class="n">dump</span><span class="p">(</span><span class="n">json_object</span><span class="p">,</span> <span class="n">a_file</span><span class="p">)</span>
            <span class="n">a_file</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
 
    <span class="k">print</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">check_for_change</span><span class="p">.</span><span class="n">current_loop</span><span class="p">)</span>
</code></pre></div></div>
<p>The idea is pretty basic: just loop through all the user watchlist files, and use the file name to get the user ID, and from the content, if we’ve detected a change in the status, overwrite with the new status, and then notify the users of the change.</p>

<h2 id="final-fixes">Final Fixes</h2>
<h3 id="one-big-oversight-herokus-ephemeral-filesystem">One Big Oversight: Heroku’s Ephemeral Filesystem</h3>
<p>So I think this stemmed from a lack of understanding of how everything worked here, but there was almost immediately a huge issue when I started to deploy my app. So most people use Heroku, an awesome platform to deploy pretty much any app you can think of, so I went along. However, most people’s bots didn’t have to do what I did: store watchlist and tons of class data. Now I thought I’d be safe when deploying the app because I was storing all that info in files, so they should stay, even if the app turns off, right? Nope.</p>

<p>There’s something called an ephemeral file system, which essentially means that files on the app disappear after a bit, or in other words, Heroku shouldn’t be relied upon for data storage. Now I’m not sure why it took me so long to just do this, but for some reason I was really intimidated by actually setting up my own database to store all this data. However, I figured that because no data could live very long on Heroku, this was the time where I’d have to actually start learning.</p>

<p>Some Stack Exchange browsing led me to a tool called MongoDB, which seemed really nice compared to other database systems because the NoSQL Document oriented system seemed really natural for holding the kinds of information I was working with. Plus, the ability to store items similarly to dictionaries in Python or objects in Javascript was really convenient because so much of how the class information was stored in Python memory was as dictionaries already.</p>

<p>And when I started going to MongoDB’s website to look at how things worked, from basically 0 knowledge, I was surprised at how easy it was to get everything working! It really was choosing a couple names, and then getting a URL that I could get a nice Python module Pymongo to connect with, just with a single line.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="bp">self</span><span class="p">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">pymongo</span><span class="p">.</span><span class="n">MongoClient</span><span class="p">(</span><span class="s">"mongodb://localhost:27017/"</span><span class="p">)</span>
<span class="n">And</span> <span class="n">thankfully</span><span class="p">,</span> <span class="n">pymongo</span> <span class="n">makes</span> <span class="n">it</span> <span class="nb">super</span> <span class="n">easy</span> <span class="n">to</span> <span class="n">perform</span> <span class="n">standard</span> <span class="n">CRUD</span> <span class="n">actions</span><span class="p">.</span>

<span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">users</span><span class="p">.</span><span class="n">update_one</span><span class="p">({</span><span class="s">"discord_id"</span><span class="p">:</span> <span class="n">user_id</span><span class="p">},</span> <span class="p">{</span><span class="s">"$set"</span><span class="p">:</span> <span class="n">to_insert</span><span class="p">},</span> <span class="n">upsert</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>
<p>The whole $ update operators took a second to get used to, but I actually came to really like that way of updating. At the end of the day, this was actually far easier to manage that having to sift through files with the JSON system, and had easier ways of telling when an operation was successful because we can get from an operation result if the number of modifications actually made was nonzero.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">remove_watchlist_result</span><span class="p">.</span><span class="n">modified_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">await</span> <span class="n">ctx</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">f"Classes cleared for </span><span class="si">{</span><span class="n">ctx</span><span class="p">.</span><span class="n">message</span><span class="p">.</span><span class="n">author</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s">."</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">await</span> <span class="n">ctx</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">f"It looks like </span><span class="si">{</span><span class="n">ctx</span><span class="p">.</span><span class="n">message</span><span class="p">.</span><span class="n">author</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s"> didn't have any classes to clear."</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="aliasing">Aliasing</h3>
<p>After demonstrating this tool to some of my friends, the most clear feature request I got was this: aliases.</p>

<p>Lots of the time, how most people abbreviate a certain subject, and what it’s called in UCLA’s database are not the same. Here are some really common examples:</p>

<table>
  <thead>
    <tr>
      <th>Subject</th>
      <th>Common Abbreviation</th>
      <th>Database Abbreviation</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Mechanical and Aerospace Engineering</td>
      <td>MAE</td>
      <td><code class="language-text highlighter-rouge">MECH&amp;AE</code></td>
    </tr>
    <tr>
      <td>Computer Science</td>
      <td>CS</td>
      <td><code class="language-text highlighter-rouge">COM SCI</code></td>
    </tr>
    <tr>
      <td>Electrical Engineering</td>
      <td>EE</td>
      <td><code class="language-text highlighter-rouge">EC ENGR</code></td>
    </tr>
  </tbody>
</table>

<p>Being a math (MATH) major, I only really tested on math classes, which has a really easy abbreviation, and didn’t realize how annoying it could be with some of the weirder ones.</p>

<p>I was originally thinking of manually setting some common aliases for these abbreviations, but I didn’t want to mess with the incoming data itself, I wanted to keep it as “pure” as possible, unmodified from the database. And I think another better reason is that there’s no official source on what the abbreviations should be, other than the database names themselves, so I didn’t want to come down and guess what some shorthands might be.</p>

<p>So I thought the best way to handle this would be to allow users to set their own aliases. This would be nice just because it could be a “set it and forget it” kind of setting, where you could just tell the bot “whenever I say ‘CS’, just replace it with ‘COM SCI’”, and then you never have to think about weird abbreviations again. And since I was already in the mood of moving things over to MongoDB, I could just make that a dictionary for each user as well, with (key, value) pairs given by (alias, target subject). (Aliases are the keys because those should not map to more than one subject name.)</p>

<p>Then most of the alias command function boils down to the line</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">users</span><span class="p">.</span><span class="n">update_one</span><span class="p">({</span><span class="s">"discord_id"</span><span class="p">:</span> <span class="n">user_id</span><span class="p">},</span> <span class="p">{</span><span class="s">"$set"</span><span class="p">:</span> <span class="p">{</span><span class="s">f"aliases.</span><span class="si">{</span><span class="n">alias</span><span class="si">}</span><span class="s">"</span><span class="p">:</span> <span class="n">target</span><span class="p">}},</span> <span class="n">upsert</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>
<p>Then an example user’s alias list could look like</p>

<p><img src="/assets/img/blog/discord_files/aliases.png" alt="List of Aliases one could have" /></p>

<h2 id="concluding-thoughts">Concluding Thoughts</h2>
<p>This was another really fun project! So far it hasn’t been quite as popular as Ok, Zoomer (I suppose fewer people use Discord than Chrome, and the population that worries about getting into classes enough to need a tracker is only a subset), but I think it’s safe to say it was quite a bit more interesting. Much of the time spent on Ok, Zoomer came from trying to iron our really annoying bugs that came from me not understanding web programming too much. There was a bit of time spent where I had to sit down and learn a bit of how asynchronous Python and the Discord API worked in general, but it wasn’t too long compared to other more fun things like figuring out how I was going to find all the enrollment data.</p>

<p>Plus, I think it’s simply more fun to use than Ok, Zoomer. Ok, Zoomer really is just a plain old bag for holding tons of Zoom links, but I’ve had fun looking up random classes and seeing how full they are and what professors are teaching, simply because my bot gives pretty much the same information as the UCLA website does, but a good amount faster as long as you already know the class catalog number you’re searching for (which most of the time you do). That’s actually why I added in a display_class command which included the description of the class, because my graduate math friend was part of a Discord server of other math grad students who didn’t really need to worry about enrollment, but liked talking about what other math classes teach.</p>

<p>To be honest though, a Discord bot isn’t probably the ideal platform for this kind of notification system, I’m sure better ones exist out there. But I chose to go for this because it seemed in the scope of my skills (the Discord API I already saw was pretty easy to use, where bots are sometimes people’s first practical Python projects), and was a lot of fun to test and deploy after playing with other peoples’ bots for so long. I really hope I’ll have more opportunities to work on other Discord bots, or with some kind of UCLA-related data.</p>
<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>I think it’s one of those “you don’t know what you don’t know” kinds of things though; underneath the surface of the simple <code class="language-text highlighter-rouge">send_message</code> commands lies a whole ton of <code class="language-text highlighter-rouge">asyncio</code> and event loop stuff I’m still too sure on. <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
    </li>
  </ol>
</div>

  
</article>






<hr class="dingbat related" />




  
     


  <aside class="about related mt4 mb4" role="complementary">
    
    

<div class="author mt4">
  

  
    





<img
  
    src="/assets/icons/icon.jpg"
    srcset="/assets/icons/icon.jpg 1x,/assets/icons/icon.jpg 2x"
    
  
  alt="Michael Ting"
  class="avatar"
  
  width="120"
  height="120"
  loading="lazy"
/>

  

  
  
  <h2  class="page-title hr-bottom">
    About
  </h2>

  <p>Michael is an Applied Math student at UCLA, but also minoring in Statistics and Asian Languages, with a specialization in computing - just studying anything that seems fun to me. Hoping that one day he’ll able to apply all the math+programming he’s been enjoying working on to help people solve their real-world problems. But most importantly? “I can only use SpeedChat”.</p>


  <div class="sidebar-social">
    <span class="sr-only">Social:</span>
<ul>
  
    
      



  

  
  
  
  

  

  

  <li>
    <a href="https://github.com/mting314" title="GitHub" class="no-mark-external">
      <span class="icon-github"></span>
      <span class="sr-only">GitHub</span>
    </a>
  </li>


    
      



  

  
  
  
  

  

  

  <li>
    <a href="mailto:giaga7@gmail.com" title="Email" class="no-mark-external">
      <span class="icon-mail"></span>
      <span class="sr-only">Email</span>
    </a>
  </li>


    
      



  

  
  
  
  

  

  

  <li>
    <a href="https://play.spotify.com/user/12162364462" title="Spotify" class="no-mark-external">
      <span class="icon-spotify"></span>
      <span class="sr-only">Spotify</span>
    </a>
  </li>


    
      



  

  
  
  
  

  

  

  <li>
    <a href="https://www.linkedin.com/in/michael-ting314" title="LinkedIn" class="no-mark-external">
      <span class="icon-linkedin2"></span>
      <span class="sr-only">LinkedIn</span>
    </a>
  </li>


    
  
</ul>

  </div>
</div>

  </aside>


  

  
    


  

  
    


  <aside class="other-projects related mb0" role="complementary">  <h2>Related Posts</h2>  <div class="columns">          <div class="column column-1-2">                  <article class="project-card">  <a href="/blog/blog/programming/2021-08-05-online-grade-distributions/" class="no-hover no-print-link flip-project" tabindex="-1">    <div class="project-card-img aspect-ratio sixteen-nine flip-project-img">              <img      src="/assets/img/blog/grades_files/thumbnail.PNG"        sizes="(min-width: 86em) 31.5rem, (min-width: 54em) 26.5rem, (min-width: 42em) 23.5rem, 48rem"    alt="How Grade Distributions Changed During Online Learning"      width="864"  height="486"  loading="lazy"/>          </div>  </a>  <h3 class="project-card-title flip-project-title">    <a href="/blog/blog/programming/2021-08-05-online-grade-distributions/" class="flip-title">How Grade Distributions Changed During Online Learning</a>  </h3>      <p class="project-card-text fine" property="disambiguatingDescription">      The COVID-19 pandemic changed routines in regard to learning and teaching. How did those changes impact grade distributions?    </p>      <a class="fill-card no-hover" href="/blog/blog/programming/2021-08-05-online-grade-distributions/" tabindex="-1"><span class="sr-only">Continue reading How Grade Distributions Changed During Online Learning</span></a></article>              </div>          <div class="column column-1-2">                  <article class="project-card">  <a href="/blog/blog/programming/2021-08-01-pubg/" class="no-hover no-print-link flip-project" tabindex="-1">    <div class="project-card-img aspect-ratio sixteen-nine flip-project-img">              <img      src="/assets/img/projects/pubg_thumbnail.jpg"        sizes="(min-width: 86em) 31.5rem, (min-width: 54em) 26.5rem, (min-width: 42em) 23.5rem, 48rem"    alt="PUBG Data Analysis"      width="864"  height="486"  loading="lazy"/>          </div>  </a>  <h3 class="project-card-title flip-project-title">    <a href="/blog/blog/programming/2021-08-01-pubg/" class="flip-title">PUBG Data Analysis</a>  </h3>      <p class="project-card-text fine" property="disambiguatingDescription">      Map of all kills across thousands of PUBG games, highlighted by the stage of the game in which the kill occurred.    </p>      <a class="fill-card no-hover" href="/blog/blog/programming/2021-08-01-pubg/" tabindex="-1"><span class="sr-only">Continue reading PUBG Data Analysis</span></a></article>              </div>      </div></aside>

  

  
    


  <aside class="related mb4" role="complementary">  <h2 class="hr-bottom">Random Posts</h2>  <ul class="related-posts">          <li class="h4">  <a href="/blog/blog/programming/2020-05-27-ok-zoomer/" class="flip-title"><span>Ok, Zoomer</span></a>  <time class="faded fine" datetime="2020-05-27T05:56:28-07:00">27 May 2020</time></li>          <li class="h4">  <a href="/blog/blog/programming/2021-08-01-pubg/" class="flip-title"><span>PUBG Data Analysis</span></a>  <time class="faded fine" datetime="2021-08-01T00:00:00-07:00">01 Aug 2021</time></li>          <li class="h4">  <a href="/blog/blog/programming/pic16b/2021-05-17-hw3/" class="flip-title"><span>Homework 3: Fake News Classification</span></a>  <time class="faded fine" datetime="2021-05-17T00:00:00-07:00">17 May 2021</time></li>      </ul></aside>

  

  
    

  


  
<footer class="content" role="contentinfo">
  <hr/>
  
    <p><small class="copyright">Michael Ting © 2021. All rights reserved
</small></p>
  
  
    <nav class="legal"><small>
    
      
      <a class="heading flip-title" href="/LICENSE/">LICENSE</a>
      |
    
      
      <a class="heading flip-title" href="/NOTICE/">NOTICE</a>
      |
    
      
      <a class="heading flip-title" href="/CHANGELOG/">CHANGELOG</a>
      
    
    </small></nav>
  
  
    <p><small>Powered by <a class="external" href="https://hydejack.com/">Hydejack</a> v<span id="_version">9.0.3</span></small></p>
  
  <hr class="sr-only"/>
</footer>


</main>

  <hy-drawer
  id="_drawer"
  class=""
  side="left"
  threshold="10"
  noscroll
  
>
  <header id="_sidebar" class="sidebar" role="banner">
    






<div class="sidebar-bg " style="background:linear-gradient(202deg, rgb(6 8 29) 13%, rgb(181 181 181) 87%)">

 </div>

    <div class="sidebar-sticky">
  <div class="sidebar-about">
    
      <a class="no-hover" href="/" tabindex="-1">
        <img src="/assets/icons/icon.jpg" class="avatar" alt="Michael Ting" width="120" height="120" loading="lazy" />
      </a>
    
    <a class="sidebar-title" href="/"><h2 class="h1">Michael Ting</h2>
        
      
      <h3 class="faded"> SpeedChat Enjoyer </h3>
    
    </a>
    

    
      <p class="">
        Undergraduate Student in Applied Mathematics at UCLA

      </p>
    
  </div>

  <nav class="sidebar-nav heading" role="navigation">
    <span class="sr-only">Navigation:</span>
<ul>
  
    
      
      <li>
        <a
          id="_drawer--opened"
          href="/about"
          class="sidebar-nav-item"
          
        >
          About
        </a>
      </li>
    
      
      <li>
        <a
          
          href="/blog"
          class="sidebar-nav-item"
          
        >
          Blog
        </a>
      </li>
    
      
      <li>
        <a
          
          href="/resume/"
          class="sidebar-nav-item"
          
        >
          Résumé\CV
        </a>
      </li>
    
      
      <li>
        <a
          
          href="/projects/"
          class="sidebar-nav-item"
          
        >
          Projects
        </a>
      </li>
    
  
</ul>

  </nav>

  
  <div class="sidebar-social">
    <span class="sr-only">Social:</span>
<ul>
  
    
      



  

  
  
  
  

  

  

  <li>
    <a href="https://github.com/mting314" title="GitHub" class="no-mark-external">
      <span class="icon-github"></span>
      <span class="sr-only">GitHub</span>
    </a>
  </li>


    
      



  

  
  
  
  

  

  

  <li>
    <a href="mailto:giaga7@gmail.com" title="Email" class="no-mark-external">
      <span class="icon-mail"></span>
      <span class="sr-only">Email</span>
    </a>
  </li>


    
      



  

  
  
  
  

  

  

  <li>
    <a href="https://play.spotify.com/user/12162364462" title="Spotify" class="no-mark-external">
      <span class="icon-spotify"></span>
      <span class="sr-only">Spotify</span>
    </a>
  </li>


    
      



  

  
  
  
  

  

  

  <li>
    <a href="https://www.linkedin.com/in/michael-ting314" title="LinkedIn" class="no-mark-external">
      <span class="icon-linkedin2"></span>
      <span class="sr-only">LinkedIn</span>
    </a>
  </li>


    
  
</ul>

  </div>
</div>
  </header>
</hy-drawer>
<hr class="sr-only" hidden />

</hy-push-state>


  <!--[if gt IE 10]><!---->
  <script nomodule>!function(){var e=document.createElement("script");if(!("noModule"in e)&&"onbeforeload"in e){var t=!1;document.addEventListener("beforeload",function(n){if(n.target===e)t=!0;else if(!n.target.hasAttribute("nomodule")||!t)return;n.preventDefault()},!0),e.type="module",e.src=".",document.head.appendChild(e),e.remove()}}();
</script>
  <script src="/assets/js/hydejack-9.0.3.js" type="module"></script>
  <script src="/assets/js/LEGACY-hydejack-9.0.3.js" nomodule defer></script>
  <!-- I gotta add this here or the javascript will NOT load when dynamic page reloading is disabled
typewriter.js and the code below are not that big so it should not be much of an issue in page loading speed. Especially with jekyll -->

<script src="/assets/mting314/js/jquery-3.5.1.min.js"></script>
<script src="/assets/mting314/js/typewriter.js"></script>
<script src="/assets/mting314/js/particles.min.js"></script> 
<script>
function appendLeadingZeroes(n){
    if(n <= 9){
      return "0" + n;
    };
    return n;
  };
  function strip(html){
    var doc = new DOMParser().parseFromString(html, 'text/html');
    return doc.body.textContent || "";
  };

  function getRandomSubarray(arr, size) {
    var shuffled = arr.slice(0), i = arr.length, temp, index;
    while (i--) {
        index = Math.floor((i + 1) * Math.random());
        temp = shuffled[index];
        shuffled[index] = shuffled[i];
        shuffled[i] = temp;
    }
    return shuffled.slice(0, size);
}

var blogTyperStarted = false;
var startBlogTyper = function(typingWindow){
  blogTyperStarted = true;
  var typingWindow = document.getElementsByClassName('typing-window blog')[0];  

  if(!typingWindow){
    return;
  };
  var typingWindowWrapper = document.getElementsByClassName('typing-window-wrapper')[0];  
  var app = typingWindow.getElementsByClassName('typing-area')[0];
  var closeBtn =  typingWindow.getElementsByClassName('typing-toolbar-btn close')[0];
  typingWindowWrapper.addEventListener('transitionend', function(event) {
    if(event.target !== event.currentTarget)
      return;
      /* Javascript returns max-height as a string "opx" */
    if (event.propertyName === "max-height" && typingWindowWrapper.style.maxHeight === "0px"){
      typingWindowWrapper.remove();
    }else if(event.propertyName === "opacity" && typingWindowWrapper.style.opacity < 0.1){
      typingWindowWrapper.style.maxHeight = 0;
    };
 });

  setTimeout (function() {
    closeBtn.classList.toggle('disabled');
    closeBtn.onclick = function() {
          typewriter.stop();
          typingWindowWrapper.style.opacity = 0.01;
      };
  }, 10000);
  console.log("Starting blog typer!");



  var totalLoops = 20;
  // var wordList = ["<em>PhD Student</em> 📚", "Programmer 💻", "Photographer 📷", "Pizza Lover 🍕", "Gamer 👾", "Swimmer 🏊", "Traveller 🌏"];
  const jsonData = {
        "10": "Oh, well.",
        "20": "Why not?",
        "30": "Naturally!",
        "40": "That's the way to do it.",
        "50": "Right on!",
        "60": "What up?",
        "70": "But of course!",
        "80": "Bingo!",
        "90": "You've got to be kidding...",
        "100": "Sounds good to me.",
        "110": "That's kooky!",
        "120": "Awesome!",
        "130": "For crying out loud!",
        "140": "Don't worry.",
        "150": "Grrrr!",
        "160": "What's new?",
        "170": "Hey, hey, hey!",
        "180": "See you tomorrow.",
        "190": "See you next time.",
        "200": "See ya later, alligator.",
        "210": "After a while, crocodile.",
        "220": "I need to go soon.",
        "230": "I don't know about this!",
        "240": "You're outta here!",
        "250": "Ouch, that really smarts!",
        "260": "Gotcha!",
        "270": "Please!",
        "280": "Thanks a million!",
        "290": "You are stylin'!",
        "300": "Excuse me!",
        "310": "Can I help you?",
        "320": "That's what I'm talking about!",
        "330": "If you can't take the heat, stay out of the kitchen.",
        "340": "Well shiver me timbers!",
        "350": "Well isn't that special!",
        "360": "Quit horsing around!",
        "370": "Cat got your tongue?",
        "380": "You're in the dog house now!",
        "390": "Look what the cat dragged in.",
        "400": "I need to go see a Toon.",
        "410": "Don't have a cow!",
        "420": "Don't chicken out!",
        "430": "You're a sitting duck.",
        "440": "Whatever!",
        "450": "Totally!",
        "460": "Sweet!",
        "470": "That rules!",
        "480": "Yeah, baby!",
        "490": "Catch me if you can!",
        "500": "You need to heal first.",
        "510": "You need more Laff Points.",
        "520": "I'll be back in a minute.",
        "530": "I'm hungry.",
        "540": "Yeah, right!",
        "550": "I'm sleepy.",
        "560": "I'm ready!",
        "570": "I'm bored.",
        "580": "I love it!",
        "590": "That was exciting!",
        "600": "Jump!",
        "610": "Got gags?",
        "620": "What's wrong?",
        "630": "Easy does it.",
        "640": "Slow and steady wins the race.",
        "650": "Touchdown!",
        "660": "Ready?",
        "670": "Set!",
        "680": "Go!",
        "690": "Let's go this way!",
        "700": "You won!",
        "710": "I vote yes.",
        "720": "I vote no.",
        "730": "Count me in.",
        "740": "Count me out.",
        "750": "Stay here, I'll be back.",
        "760": "That was quick!",
        "770": "Did you see that?",
        "780": "What's that smell?",
        "790": "That stinks!",
        "800": "I don't care.",
        "810": "Just what the doctor ordered.",
        "820": "Let's get this party started!",
        "830": "This way everybody!",
        "840": "What in the world?",
        "850": "The check's in the mail.",
        "860": "I heard that!",
        "870": "Are you talking to me?",
        "880": "Thank you, I'll be here all week.",
        "890": "Hmm.",
        "900": "I'll get this one.",
        "910": "I got it!",
        "920": "It's mine!",
        "930": "Please, take it.",
        "940": "Stand back, this could be dangerous.",
        "950": "No worries!",
        "960": "Oh, my!",
        "970": "Whew!",
        "980": "Owoooo!",
        "990": "All Aboard!",
        "1000": "Hot Diggity Dog!",
        "1010": "Curiosity killed the cat.",
        "2000": "Act your age!",
        "2010": "Am I glad to see you!",
        "2020": "Be my guest.",
        "2030": "Been keeping out of trouble?",
        "2040": "Better late than never!",
        "2050": "Bravo!",
        "2060": "But seriously, folks...",
        "2070": "Care to join us?",
        "2080": "Catch you later!",
        "2090": "Changed your mind?",
        "2100": "Come and get it!",
        "2110": "Dear me!",
        "2120": "Delighted to make your acquaintance.",
        "2130": "Don't do anything I wouldn't do!",
        "2140": "Don't even think about it!",
        "2150": "Don't give up the ship!",
        "2160": "Don't hold your breath.",
        "2170": "Don't ask.",
        "2180": "Easy for you to say.",
        "2190": "Enough is enough!",
        "2200": "Excellent!",
        "2210": "Fancy meeting you here!",
        "2220": "Give me a break.",
        "2230": "Glad to hear it.",
        "2240": "Go ahead, make my day!",
        "2250": "Go for it!",
        "2260": "Good job!",
        "2270": "Good to see you!",
        "2280": "Got to get moving.",
        "2290": "Got to hit the road.",
        "2300": "Hang in there.",
        "2310": "Hang on a second.",
        "2320": "Have a ball!",
        "2330": "Have fun!",
        "2340": "Haven't got all day!",
        "2350": "Hold your horses!",
        "2360": "Horsefeathers!",
        "2370": "I don't believe this!",
        "2380": "I doubt it.",
        "2390": "I owe you one.",
        "2400": "I read you loud and clear.",
        "2410": "I think so.",
        "2420": "I think you should pass.",
        "2430": "I wish I'd said that.",
        "2440": "I wouldn't if I were you.",
        "2450": "I'd be happy to!",
        "2460": "I'm helping my friend.",
        "2470": "I'm here all week.",
        "2480": "Imagine that!",
        "2490": "In the nick of time...",
        "2500": "It's not over 'til it's over.",
        "2510": "Just thinking out loud.",
        "2520": "Keep in touch.",
        "2530": "Lovely weather for ducks!",
        "2540": "Make it snappy!",
        "2550": "Make yourself at home.",
        "2560": "Maybe some other time.",
        "2570": "Mind if I join you?",
        "2580": "Nice place you have here.",
        "2590": "Nice talking to you.",
        "2600": "No doubt about it.",
        "2610": "No kidding!",
        "2620": "Not by a long shot.",
        "2630": "Of all the nerve!",
        "2640": "Okay by me.",
        "2650": "Righto.",
        "2660": "Say cheese!",
        "2670": "Say what?",
        "2680": "Tah-dah!",
        "2690": "Take it easy.",
        "2700": "Ta-ta for now!",
        "2710": "Thanks, but no thanks.",
        "2720": "That takes the cake!",
        "2730": "That's funny.",
        "2740": "That's the ticket!",
        "2750": "There's a Cog invasion!",
        "2760": "Toodles.",
        "2770": "Watch out!",
        "2780": "Well done!",
        "2790": "What's cooking?",
        "2800": "What's happening?",
        "2810": "Works for me.",
        "2820": "Yes sirree.",
        "2830": "You betcha.",
        "2840": "You do the math.",
        "2850": "You leaving so soon?",
        "2860": "You make me laugh!",
        "2870": "You take right.",
        "2880": "You're going down!",
        "3000": "Anything you say.",
        "3010": "Care if I join you?",
        "3020": "Check, please.",
        "3030": "Don't be too sure.",
        "3040": "Don't mind if I do.",
        "3050": "Don't sweat it!",
        "3060": "Don't you know it!",
        "3070": "Don't mind me.",
        "3080": "Eureka!",
        "3090": "Fancy that!",
        "3100": "Forget about it!",
        "3110": "Going my way?",
        "3120": "Good for you!",
        "3130": "Good grief.",
        "3140": "Have a good one!",
        "3150": "Heads up!",
        "3160": "Here we go again.",
        "3170": "How about that!",
        "3180": "How do you like that?",
        "3190": "I believe so.",
        "3200": "I think not.",
        "3210": "I'll get back to you.",
        "3220": "I'm all ears.",
        "3230": "I'm busy.",
        "3240": "I'm not kidding!",
        "3250": "I'm speechless.",
        "3260": "Keep smiling.",
        "3270": "Let me know!",
        "3280": "Let the pie fly!",
        "3290": "Likewise, I'm sure.",
        "3300": "Look alive!",
        "3310": "My, how time flies.",
        "3320": "No comment.",
        "3330": "Now you're talking!",
        "3340": "Okay by me.",
        "3350": "Pleased to meet you.",
        "3360": "Righto.",
        "3370": "Sure thing.",
        "3380": "Thanks a million.",
        "3390": "That's more like it.",
        "3400": "That's the stuff!",
        "3410": "Time for me to hit the hay.",
        "3420": "Trust me!",
        "3430": "Until next time.",
        "3440": "Wait up!",
        "3450": "Way to go!",
        "3460": "What brings you here?",
        "3470": "What happened?",
        "3480": "What now?",
        "3490": "You first.",
        "3500": "You take left.",
        "3510": "You wish!",
        "3520": "You're toast!",
        "3530": "You're too much!",
        "4000": "Toons rule!",
        "4010": "Cogs drool!",
        "4020": "Toons of the world unite!",
        "4030": "Howdy, partner!",
        "4040": "Much obliged.",
        "4050": "Get along, little doggie.",
        "4060": "I'm going to hit the hay.",
        "4070": "I'm chomping at the bit!",
        "4080": "This town isn't big enough for the two of us!",
        "4090": "Saddle up!",
        "4100": "Draw!!!",
        "4110": "There's gold in them there hills!",
        "4120": "Happy trails!",
        "4130": "This is where I ride off into the sunset...",
        "4140": "Let's skedaddle!",
        "4150": "You got a bee in your bonnet?",
        "4160": "Lands sake!",
        "4170": "Right as rain.",
        "4180": "I reckon so.",
        "4190": "Let's ride!",
        "4200": "Well, go figure!",
        "4210": "I'm back in the saddle again!",
        "4220": "Round up the usual suspects.",
        "4230": "Giddyup!",
        "4240": "Reach for the sky.",
        "4250": "I'm fixing to.",
        "4260": "Hold your horses!",
        "4270": "I can't hit the broad side of a barn.",
        "4280": "Y'all come back now.",
        "4290": "It's a real barn burner!",
        "4300": "Don't be a yellow belly.",
        "4310": "Feeling lucky?",
        "4320": "What in Sam Hill's goin' on here?",
        "4330": "Shake your tail feathers!",
        "4340": "Well, don't that take all.",
        "4350": "That's a sight for sore eyes!",
        "4360": "Pickins is mighty slim around here.",
        "4370": "Take a load off.",
        "4380": "Aren't you a sight!",
        "4390": "That'll learn ya!",
        "6000": "I want candy!",
        "6010": "I've got a sweet tooth.",
        "6020": "That's half-baked.",
        "6030": "Just like taking candy from a baby!",
        "6040": "They're cheaper by the dozen.",
        "6050": "Let them eat cake!",
        "6060": "That's the icing on the cake.",
        "6070": "You can't have your cake and eat it too.",
        "6080": "I feel like a kid in a candy store.",
        "6090": "Six of one, half a dozen of the other...",
        "6100": "Let's keep it short and sweet.",
        "6110": "Keep your eye on the doughnut not the hole.",
        "6120": "That's pie in the sky.",
        "6130": "But it's wafer thin.",
        "6140": "Let's gum up the works!",
        "6150": "You're one tough cookie!",
        "6160": "That's the way the cookie crumbles.",
        "6170": "Like water for chocolate.",
        "6180": "Are you trying to sweet talk me?",
        "6190": "A spoonful of sugar helps the medicine go down.",
        "6200": "You are what you eat!",
        "6210": "Easy as pie!",
        "6220": "Don't be a sucker!",
        "6230": "Sugar and spice and everything nice.",
        "6240": "It's like butter!",
        "6250": "The candyman can!",
        "6260": "We all scream for ice cream!",
        "6270": "Let's not sugar coat it.",
        "6280": "Knock knock...",
        "6290": "Who's there?",
        "7000": "Quit monkeying around!",
        "7010": "That really throws a monkey-wrench in things.",
        "7020": "Monkey see, monkey do.",
        "7030": "They made a monkey out of you.",
        "7040": "That sounds like monkey business.",
        "7050": "I'm just monkeying with you.",
        "7060": "Who's gonna be monkey in the middle?",
        "7070": "That's a monkey off my back...",
        "7080": "This is more fun than a barrel of monkeys!",
        "7090": "Well I'll be a monkey's uncle.",
        "7100": "I've got monkeys on the brain.",
        "7110": "What's with the monkey suit?",
        "7120": "Hear no evil.",
        "7130": "See no evil.",
        "7140": "Speak no evil.",
        "7150": "Let's make like a banana and split.",
        "7160": "It's a jungle out there.",
        "7170": "You're the top banana.",
        "7180": "Cool bananas!",
        "7190": "I'm going bananas!",
        "7200": "Let's get into the swing of things!",
        "7210": "This place is swinging!",
        "7220": "I'm dying on the vine.",
        "7230": "Let's make like a tree and leave.",
        "7240": "Jellybeans don't grow on trees!",
        "10000": "This place is a ghost town.",
        "10001": "Nice costume!",
        "10002": "I think this place is haunted.",
        "10003": "Trick or Treat!",
        "10004": "Boo!",
        "10005": "Happy Haunting!",
        "10006": "Happy Halloween!",
        "10007": "It's time for me to turn into a pumpkin.",
        "10008": "Spooktastic!",
        "10009": "Spooky!",
        "10010": "That's creepy!",
        "10011": "I hate spiders!",
        "10012": "Did you hear that?",
        "10013": "You don't have a ghost of a chance!",
        "10014": "You scared me!",
        "10015": "That's spooky!",
        "10016": "That's freaky!",
        "10017": "That was strange....",
        "10018": "Skeletons in your closet?",
        "10019": "Did I scare you?",
        "11000": "Bah! Humbug!",
        "11001": "Better not pout!",
        "11002": "Brrr!",
        "11003": "Chill out!",
        "11004": "Come and get it!",
        "11005": "Don't be a turkey.",
        "11006": "Gobble gobble!",
        "11007": "Happy holidays!",
        "11008": "Happy New Year!",
        "11009": "Happy Thanksgiving!",
        "11010": "Happy Turkey Day!",
        "11011": "Ho! Ho! Ho!",
        "11012": "It's \"snow\" problem.",
        "11013": "It's \"snow\" wonder.",
        "11014": "Let it snow!",
        "11015": "Rake 'em in.",
        "11016": "Season's greetings!",
        "11017": "Snow doubt about it!",
        "11018": "Snow far, snow good!",
        "11019": "Yule be sorry!",
        "11020": "Have a Wonderful Winter!",
        "11021": "The Holiday Party decorations are Toontastic!",
        "11022": "Toon Troopers are hosting Holiday Parties!",
        "12000": "Be mine!",
        "12001": "Be my sweetie!",
        "12002": "Happy ValenToon's Day!",
        "12003": "Aww, how cute.",
        "12004": "I'm sweet on you.",
        "12005": "It's puppy love.",
        "12006": "Love ya!",
        "12007": "Will you be my ValenToon?",
        "12008": "You are a sweetheart.",
        "12009": "You are as sweet as pie.",
        "12010": "You are cute.",
        "12011": "You need a hug.",
        "12012": "Lovely!",
        "12013": "That's darling!",
        "12014": "Roses are red...",
        "12015": "Violets are blue...",
        "12016": "That's sweet!",
        "12050": "I LOVE busting Cogs!",
        "12051": "You're dynamite!",
        "12052": "I only have hypno-eyes for you!",
        "12053": "You're sweeter than a jellybean!",
        "12054": "I'd LOVE for you to come to my ValenToon's party!",
        "13000": "Top o' the mornin' to you!",
        "13001": "Happy St. Patrick's Day!",
        "13002": "You're not wearing green!",
        "13003": "It's the luck of the Irish.",
        "13004": "I'm green with envy.",
        "13005": "You lucky dog!",
        "13006": "You're my four leaf clover!",
        "13007": "You're my lucky charm!",
        "14000": "Let's have a summer Estate party!",
        "14001": "It's party time!",
        "14002": "Last one in the pond is a rotten Cog!",
        "14003": "Group Doodle training time!",
        "14004": "Doodle training time!",
        "14005": "Your Doodle is cool!",
        "14006": "What tricks can your Doodle do?",
        "14007": "Time for Cannon Pinball!",
        "14008": "Cannon Pinball rocks!",
        "14009": "Your Estate rocks!",
        "14010": "Your Garden is cool!",
        "14011": "Your Estate is cool!",
        "14012": "I don't have anyone to call for help",
        "14013": "I like your style.",
        "14014": "Send in a bug report"
      }
  var wordList = getRandomSubarray(Object.values(jsonData), 10);
  var pause = [1000, 4500];
  var terminalStarter = "> <span style='color: #5cd400;'> mting314@blog:</span><span style='color: #1c39c7;'>~</span>$ ";
  var current_datetime = new Date();
  var formatted_date = current_datetime.getFullYear() + "-" + appendLeadingZeroes(current_datetime.getMonth() + 1) + "-" + appendLeadingZeroes(current_datetime.getDate()) + " " + appendLeadingZeroes(current_datetime.getHours()) + ":" + appendLeadingZeroes(current_datetime.getMinutes()) + ":" + appendLeadingZeroes(current_datetime.getSeconds());

  var randomDelay = function(){
   return Math.random() * (pause[1] - pause[0] + pause[0]);
  };
  var typewriter = new Typewriter(app, {
    loop: false,
    delay: 'natural',
    cursor: '▌'
  });

  typewriter
  .pasteString(terminalStarter +"["+formatted_date+"]")
  .pauseFor(1000);

  if(current_datetime.getHours() > 22 ||current_datetime.getHours() < 5){
    typewriter
    .changeDelay(50)
    .pasteString("<br /> " +terminalStarter)
    .typeString("What are you doing up late? :)")
    .pauseFor(randomDelay());
  };

  if((current_datetime.getMonth() + 1) == 6 && current_datetime.getDate() == 9){
    typewriter
    .changeDelay(50)
    .pasteString("<br /> " +terminalStarter)
    .typeString("It's my birthday today! 🎂🎉")
    .pauseFor(randomDelay());    
  };

  console.log("aolsikfhjalskfhj");
  typewriter
  .changeDelay(90)
  .pasteString("<br /> " +terminalStarter)
  .pauseFor(1200)
  .typeString("Hey!")
  .pauseFor(800)
  .typeString(" I'm <strong>Michael</strong>")
  .pauseFor(1000)
  .pasteString("<br /> " + terminalStarter)
  .typeString(" I can only use SpeedChat.")
  .pauseFor(1000)
  .pasteString("<br /> " + terminalStarter)
  .typeString(" SpeedChat: ")
  ;

  let toType;
  for(var k = 0; k < totalLoops; k++){ 
    for(var i=0; i < wordList.length; i++){
      toType = wordList[parseInt(Math.random() * wordList.length)]
      typewriter
      .typeString(toType)
      .pauseFor(randomDelay())
      .deleteChars(strip(toType).length);
    };
  };
  typewriter.start();
};

var startTypers = function(){
  /*if(!blogTyperStarted){  startBlogTyper() }; */
  startBlogTyper();
  
};

var linesAdded = false;
var codeLinesSpan = "<span class='code-lines' style='display: none;'> </span>";
var codeLinesBtn = "<span class='code-lines-btn icon-list-numbered'></span>";
var codeLanguageTag = "<span class='code-language-tag'></span>";
var codeOutputTag = "<span class='code-output-tag icon-enlarge2'></span>";
var codeOutputMinHeight = "3rem";
var codeExtrasSpan = "<span class='code-extras'></span>";
var charLength = 0.8+0.1;
var addCodeLines = function(){
  console.log(linesAdded);
  if(linesAdded){
    return;
  }
  linesAdded = true;
  $(".highlight").each(function(index){
    if($(this).find(".code-lines").length > 0){
      return;
    };
    if($(this).parents(".highlight").length > 0){ /*We only want the most external one */
      return;
    };
    var code = $(this).find("code");
    var languageClass = code.attr('class');
    if(!languageClass){
      languageClass = $($(this).parents(".highlighter-rouge")[0]).attr('class');
    };
    var language = languageClass.split("-")[1].split(" ")[0].trim();
    var codeExtras = $(codeExtrasSpan);
      var languageTag = $(codeLanguageTag);
    if(language === 'plaintext'){
      languageTag.text("output");
      codeExtras.prepend(languageTag);
      $(this).addClass("code-output");
      var outputTag = $(codeOutputTag);
      code.parent().css("max-height", codeOutputMinHeight);
      outputTag.click(function(){
          var par = $(this).parent().parent();
          par.toggleClass("expanded");
        if( $(this).hasClass("enabled")){
          par.find("code").parent().css('max-height', codeOutputMinHeight);
        }
        else{   
          par.find("code").parent().css('max-height', '');
        };
        $(this).toggleClass("enabled");
      });
      codeExtras.prepend(outputTag);    
    }
    else{
      languageTag.text(language);
      codeExtras.prepend(languageTag);
      var noLines = code.text().trim().split(/\r\n|\r|\n/).length;
      if(noLines > 5){
        var linesSpan = $(codeLinesSpan);
        linesSpan.attr("code-lines", noLines);
        var linesBtnSpan = $(codeLinesBtn);
        linesBtnSpan.click(function(){
          if( $(this).hasClass("enabled")){
            var par = $(this).parent().parent();
            var codeLines = par.find(".code-lines");
            par.find("code").parent().css("padding-left", "");
            codeLines.css('opacity', '0');
            codeLines.css('display', 'none');
          }
          else{   
            var par = $(this).parent().parent();
            var codeLines = par.find(".code-lines");
            var padding = Math.max(2,codeLines.attr("code-lines").length)+"rem";
            par.find("code").parent().css("padding-left", padding);
            codeLines.css('display', '');
            codeLines.css('opacity', '1');
          };
          $(this).toggleClass("enabled");
        });
        linesSpan.text([...Array(noLines).keys()].join("\n"));
        $(this).prepend(linesSpan);
        codeExtras.prepend(linesBtnSpan);
      };
    };
    $(this).prepend(codeExtras);
    $(this).addClass("code-extended");
  });
};


document.getElementById('_pushState').addEventListener('hy-push-state-load', function() {
    startTypers();
    addCodeLines();
});


document.getElementById('_pushState').addEventListener('hy-push-state-start', function() {
  linesAdded = false;
});
document.addEventListener('DOMContentLoaded', function(){ 
    startTypers();
}, false);
</script>
  
  <script>!function(w, d) {
    w.ga=w.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;

    /**/
      ga('create', 'UA-145580315-1', 'auto');
    /**/

    var pushStateEl = d.getElementById('_pushState');
    var timeoutId;
    pushStateEl.addEventListener('hy-push-state-load', function() {
      w.clearTimeout(timeoutId);
      timeoutId = w.setTimeout(function() {
        ga('set', 'page', w.location.pathname);
        ga('send', 'pageview');
      }, 500);
    });

    d.addEventListener('hy--cookies-ok', function () {
      w.ga(function(tracker) {
        w.ga("set", "anonymizeIp", undefined);
        localStorage && localStorage.setItem("ga--client-id", tracker.get("clientId"));
      });
    });

    w.loadJSDeferred('https://www.google-analytics.com/analytics.js');
  }(window, document);</script>


  <script type="module">
    if ('serviceWorker' in navigator) {
      /**/
      navigator.serviceWorker.register('/sw.js')
        .then(r => r.update())
        .catch(() => {});
      /**/
    }
  </script>
<!--<![endif]-->
  <!-- <script>
  document.querySelector('hy-push-state').setAttribute('prefetch', '');

  document.querySelectorAll('.sidebar a[href^="/"]').forEach(function (el) { 
    el.addEventListener('click', function (e) {
      if (el.pathname === window.location.pathname) {
        e.preventDefault();
        e.stopPropagation();
        document.querySelector('hy-drawer').close();
      }
    });
  });
</script> -->

<!--
Code for integrating CloudFlare's email protection with Hydejack's single page app loading.
-->
<script>
  document.getElementById('_pushState').addEventListener('hy-push-state-after', function (e) {
    function e(e){
      (console.error?console.error:console.log).call(console,e)
    }

    function t(e){
      return l.innerHTML='<a href="'+e.replace(/"/g,"&quot;")+'"></a>',l.childNodes[0].getAttribute("href")
    }

    function r(e,t){
      var r=e.substr(t,2);return parseInt(r,16)
    }

    function n(e,n){
      for(var o="",c=r(e,n),a=n+2;a<e.length;a+=2){
        var l=r(e,a)^c;
        o+=String.fromCharCode(l)
      }
      return t(o)
    }

    var o="/cdn-cgi/l/email-protection#",
        c=".__cf_email__",
        a="data-cfemail",
        l=document.createElement("div");

    !function(){
      for(var t=document.getElementsByTagName("a"),r=0;r<t.length;r++)
        try{
          var c=t[r],a=c.href.indexOf(o);
          a>-1&&(c.href="mailto:"+n(c.href,a+o.length))
        }catch(t){
          e(t)
        }
    }(),
    function(){
      for(var t=document.querySelectorAll(c),r=0;r<t.length;r++)
        try{
          var o=t[r],l=n(o.getAttribute(a),0),i=document.createTextNode(l);
          o.parentNode.replaceChild(i,o)
        }catch(t){
          e(t)
        }
    }()
  });
</script>





<div hidden>
  
  <h2 class="sr-only">Templates (for web app):</h2>

  <template id="_animation-template">
  <div class="animation-main fixed-top">
    <div class="content">
      <div class="page"></div>
    </div>
  </div>
</template>

  <template id="_loading-template">
  <div class="loading nav-btn fr">
    <span class="sr-only">Loading…</span>
    <span class="icon-cog"></span>
  </div>
</template>

  <template id="_error-template">
  <div class="page">
    <h1 class="page-title">Error</h1>
    
    
    <p class="lead">
      Sorry, an error occurred while loading <a class="this-link" href=""></a>.

    </p>
  </div>
</template>

  <template id="_forward-template">
  <button id="_forward" class="forward nav-btn no-hover">
    <span class="sr-only">Forward</span>
    <span class="icon-arrow-right2"></span>
  </button>
</template>

  <template id="_back-template">
  <button id="_back" class="back nav-btn no-hover">
    <span class="sr-only">Back</span>
    <span class="icon-arrow-left2"></span>
  </button>
</template>

  <template id="_permalink-template">
  <a href="#" class="permalink">
    <span class="sr-only">Permalink</span>
    <span class="content-hash"></span>
  </a>
</template>

  
  
    <template id="_dark-mode-template">
  <button id="_dark-mode" class="nav-btn no-hover" >
    <span class="sr-only">Dark Mode</span>
    <span class="icon-brightness-contrast"></span>
  </button>
</template>

  
  
    <template id="_search-template">
  <button id="_search" class="nav-btn no-hover">
    <label class="sr-only" for="_search-input">Search</label>
    <span class="icon-search"></span>
  </button>
  <div id="_search-box">
    <div class="nav-btn">
      <span class="icon-search"></span>
    </div>
    <input 
      id="_search-input"
      type="search"
      class="form-control form-control-lg nav-btn"
      placeholder="SEARCH NOT ENABLED DURING DEVELOPMENT"
    />
    <button type="reset" class="nav-btn no-hover">
      <span class="sr-only">Close</span>
      <span class="icon-cross"></span>
    </button>
  </div>
  <div id="_hits"></div>
</template>

  
</div>

</body>
</html>
